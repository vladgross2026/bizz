# Настройка комментариев (Supabase)

Если комментарии не появляются или не отправляются, пройдите по шагам ниже.

---

## 1. Проверьте, какой режим комментариев включён

На **странице поста** под формой «Оставить комментарий» после загрузки появляется подсказка:

- **«Комментарии сохраняются в Supabase (видны всем).»** — используется Supabase, комментарии общие для всех.
- **«Комментарии сохраняются локально…»** — используется только localStorage, комментарии видны только в этом браузере.

Если видите локальный режим, но хотите общие комментарии — переходите к шагу 2.

---

## 2. Включите Supabase в config.js

Файл **`config.js`** (в корне проекта):

```js
window.BIZFORUM_CONFIG = {
  useSupabase: true,
  SUPABASE_URL: 'https://ВАШ_ПРОЕКТ.supabase.co',
  SUPABASE_ANON_KEY: 'ваш_anon_ключ'
};
```

- `useSupabase: true` — обязательно.
- URL и ключ возьмите в Supabase: **Project Settings → API** (Project URL и anon public key).

Сохраните файл и **полностью перезагрузите страницу** (Ctrl+F5).

---

## 3. Таблица `comments` в Supabase

В **Supabase → Table Editor** должна быть таблица **comments** с колонками:

- `id` (uuid, primary key)
- `post_id` (uuid, не null)
- `body` (text, не null)
- `author_id` (uuid, nullable) — для авторизованных
- `author_name` (text, default 'Гость')
- `author_device_id` (text, nullable) — для гостей
- `created_at` (timestamptz)
- `updated_at` (timestamptz, nullable)

Если таблицы нет — создайте её, выполнив скрипт из **`supabase/schema.sql`** (блок создания таблицы `comments` и индексов).

---

## 4. RLS и политики для комментариев

В **Supabase → SQL Editor** выполните скрипт из файла:

**`supabase/migration-comments-allow-insert.sql`**

Он:

- включает RLS для таблицы `comments`;
- создаёт политику **comments_insert** (вставка разрешена всем);
- создаёт политику **comments_select** (чтение разрешено всем).

После выполнения снова попробуйте отправить комментарий.

---

## 5. Если при отправке появляется красное сообщение

Под формой комментария отображается **текст ошибки** (от Supabase или общий «Ошибка»).

- **«new row violates row-level security policy»** — политика RLS блокирует вставку. Ещё раз выполните `migration-comments-allow-insert.sql`.
- **«column "..." does not exist»** — в таблице нет нужной колонки. Сверьте таблицу с пунктом 3 и при необходимости добавьте колонку (Supabase → Table Editor → изменить таблицу).
- **«Network Error» / «Failed to fetch»** — проверьте SUPABASE_URL и SUPABASE_ANON_KEY, а также доступ в интернет и CORS (для Supabase обычно настроен).

Скопируйте точный текст ошибки — по нему можно понять причину.

---

## 6. Проверка в Supabase

После успешной отправки комментария:

- **Supabase → Table Editor → comments** — должна появиться новая строка с вашим `body`, `post_id`, `author_name` и т.д.

Если строка есть, но комментарий не отображается на сайте — обновите страницу поста (F5). Список комментариев подгружается при открытии поста; после отправки он обновляется автоматически, но при сбоях сети можно обновить вручную.

---

## Краткий чеклист

- [ ] В config.js указано `useSupabase: true` и верные SUPABASE_URL, SUPABASE_ANON_KEY
- [ ] Страница перезагружена после изменения config.js
- [ ] В Supabase есть таблица `comments` с нужными колонками
- [ ] Выполнен скрипт `supabase/migration-comments-allow-insert.sql`
- [ ] На странице поста под формой видна подсказка «Комментарии сохраняются в Supabase»
- [ ] При ошибке отправки прочитан красный текст под формой и при необходимости скопирован для диагностики
