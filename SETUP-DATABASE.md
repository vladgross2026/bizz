# Подключение BizForum к базе данных (Supabase)

## Почему Supabase

- **Бесплатно:** 500 MB БД, 1 GB файлов, 50 000 активных пользователей в месяц, встроенная авторизация (email, OAuth).
- **Удобно масштабировать:** при росте можно перейти на **Pro** ($25/мес) — больше БД, бэкапы, поддержка.
- **Без своего сервера:** запросы идут из браузера через Supabase JS; для аккаунтов используется встроенный Supabase Auth.

Альтернативы: **Firebase** (NoSQL, своя модель), **Neon** (только PostgreSQL, без Auth из коробки).

---

## Шаг 1: Регистрация и проект

1. Зайдите на [supabase.com](https://supabase.com) и зарегистрируйтесь (GitHub или email).
2. **New project** → выберите организацию, имя проекта (например `bizforum`), пароль БД (сохраните), регион (например Frankfurt).
3. Дождитесь создания проекта (1–2 минуты).

---

## Шаг 2: Создать таблицы

1. В проекте откройте **SQL Editor** → **New query**.
2. Скопируйте весь текст из файла **`supabase/schema.sql`** и вставьте в редактор.
3. Нажмите **Run**. Должны создаться таблицы: `categories`, `posts`, `comments`, `post_views`, `reactions`, `favorites` и политики RLS.

---

## Шаг 3: Включить авторизацию по email

1. **Authentication** → **Providers** → **Email**.
2. Включите **Enable Email provider**.
3. При желании включите **Confirm email** (подтверждение по ссылке).

Для входа по паролю пользователи будут регистрироваться через форму (её можно добавить в шапку сайта, используя `BizForum.auth.signUp` / `signIn`).

---

## Шаг 4: Ключи и config.js

1. **Project Settings** (иконка шестерёнки) → **API**.
2. Скопируйте:
   - **Project URL** (например `https://xxxxx.supabase.co`);
   - **anon public** (ключ с длинным JWT).
3. В папке `bizforum` создайте файл **`config.js`** (не коммитьте его в git, если репозиторий общий):

```js
window.BIZFORUM_CONFIG = {
  useSupabase: true,
  SUPABASE_URL: 'https://ВАШ_ПРОЕКТ.supabase.co',
  SUPABASE_ANON_KEY: 'ваш_anon_ключ'
};
```

4. Откройте сайт. Если `config.js` есть и `useSupabase: true`, данные будут браться из Supabase. Категории уже есть (из схемы), посты можно создавать через форму «Новый пост».

---

## Шаг 5: Триггер создания профиля при регистрации (обязательно)

Без этого шага при регистрации появится ошибка **«new row violates row-level security policy for table profiles»**: вставка профиля из браузера блокируется RLS. Триггер создаёт строку в `profiles` при появлении пользователя в `auth.users` и подставляет имя, фамилию, компанию и секретное слово из данных регистрации.

1. **SQL Editor** → **New query**.
2. Скопируйте содержимое файла **`supabase/migration-auth-trigger-profile.sql`** и нажмите **Run**.

После этого новые регистрации будут создавать профиль автоматически, в шапке будет отображаться имя и фамилия, а при секретном слове `admingrosskremeshova` появится админ-панель.

---

## Шаг 6: Типы реакций (обязательно, если уже запускали schema.sql раньше)

В таблице `reactions` разрешены только определённые значения `type`. В приложении используются: мужик!, королева!, ржаакаа, огонь, фу, грустно, делаем бабки, хахаха (в БД: `muzhik`, `koroleva`, `rzhaka`, `fire`, `fu`, `grustno`, `babki`, `hahaha`).

1. **SQL Editor** → **New query**.
2. Скопируйте содержимое файла **`supabase/migration-reactions-types.sql`** и нажмите **Run**.

Без этого шага у **авторизованных** пользователей не будут сохраняться реакции (у гостей они хранятся в браузере и работают).

---

## Где в Supabase искать свой аккаунт

- **Учётная запись (логин/пароль):** **Authentication** → **Users**. Там список всех зарегистрированных пользователей (email, дата создания). Это таблица `auth.users`.
- **Имя, фамилия, компания, верификация:** **Table Editor** → таблица **`profiles`**. Строка с вашим `id` (такой же UUID, как в Authentication → Users) — это ваш профиль. Профиль создаётся триггером при регистрации (шаг 5) или при первом заходе в «Профиль», если триггер не был настроен.

---

## Шаг 7: Первые посты (опционально)

Пока постов в БД нет — лента будет пустой. Можно:

- создавать посты через форму на сайте;
- или вставить тестовые посты вручную в **Table Editor** → `posts` (нужны `category_id`, `title`, `body`, `author_name`).

---

## Шаг 8 и дальше: платный план (Pro)

Когда понадобится больше ресурсов и надёжности:

1. **Billing** в Supabase → **Upgrade to Pro** ($25/мес).
2. Получите больше БД (8 GB), бэкапы, мониторинг. Тот же код и те же ключи (anon key) продолжат работать.

Если позже захотите сменить хостинг БД — схема в `supabase/schema.sql` подойдёт для любого PostgreSQL.
