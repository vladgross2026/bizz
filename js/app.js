(function(){
function t(k){ return window.BizForum && window.BizForum.i18n && window.BizForum.i18n.t ? window.BizForum.i18n.t(k) : k; }
function validatePassword(pw){ if(!pw || pw.length < 8) return false; if(!/[A-Z]/.test(pw)) return false; if(!/[a-z]/.test(pw)) return false; if(!/[^A-Za-z0-9]/.test(pw)) return false; return true; }
function updatePasswordChecklist(pw, prefix){ var len=document.getElementById(prefix+'-pw-len'); var upper=document.getElementById(prefix+'-pw-upper'); var lower=document.getElementById(prefix+'-pw-lower'); var special=document.getElementById(prefix+'-pw-special'); if(!len||!upper||!lower||!special)return; var ok='auth-pw-ok'; var fail='auth-pw-fail'; len.className=(pw&&pw.length>=8)?ok:fail; upper.className=/[A-Z]/.test(pw||'')?ok:fail; lower.className=/[a-z]/.test(pw||'')?ok:fail; special.className=/[^A-Za-z0-9]/.test(pw||'')?ok:fail; }
var listEl = document.getElementById('post-list');
var listCatEl = document.getElementById('post-list-category');
var listSearchEl = document.getElementById('post-list-search');
var categoryListEl = document.getElementById('category-list');
var categoriesGridEl = document.getElementById('categories-grid');
var postFullEl = document.getElementById('post-full');
var postReactionsEl = document.getElementById('post-reactions');
var commentsListEl = document.getElementById('comments-list');
var categoryFeedTitleEl = document.getElementById('category-feed-title');
var searchResultTitleEl = document.getElementById('search-result-title');
var listFavoritesEl = document.getElementById('post-list-favorites');
var listDraftsEl = document.getElementById('post-list-drafts');
var breadcrumbsEl = document.getElementById('breadcrumbs');
var views = { feed: document.getElementById('view-feed'), category: document.getElementById('view-category'), post: document.getElementById('view-post'), categories: document.getElementById('view-categories'), search: document.getElementById('view-search'), favorites: document.getElementById('view-favorites'), drafts: document.getElementById('view-drafts'), subscription: document.getElementById('view-subscription'), privacy: document.getElementById('view-privacy'), new: document.getElementById('view-new'), admin: document.getElementById('view-admin'), adminDashboard: document.getElementById('view-admin-dashboard'), adminVerification: document.getElementById('view-admin-verification'), adminReports: document.getElementById('view-admin-reports'), adminContent: document.getElementById('view-admin-content'), profile: document.getElementById('view-profile'), friends: document.getElementById('view-friends'), groups: document.getElementById('view-groups'), userProfile: document.getElementById('view-user-profile'), landing: document.getElementById('view-landing') };
var adminModeOn = false;
var currentPostId = null;
var currentPostAuthorId = null;
var currentPostBestAnswerId = null;
var currentUserIsPostAuthor = false;
var currentReplyToAuthorId = null;
var fromRoute = '';
var lastListRoute = '#/';
var lastSearchQuery = '';
var lastScrollY = 0;
var PAGE_SIZE = 20;
var feedOffset = 0;
var categoryOffset = 0;
var currentCategoryId = '';
function getSessionId(){ try { var s = sessionStorage.getItem('bizforum_sid'); if(!s){ s = 's' + Date.now() + '_' + Math.random().toString(36).slice(2); sessionStorage.setItem('bizforum_sid', s); } return s; } catch(e){ return 'guest'; } }
function getAuthorName(){ try { return sessionStorage.getItem('bizforum_author') || ''; } catch(e){ return ''; } }
function setAuthorName(name){ try { if(name) sessionStorage.setItem('bizforum_author', name); } catch(e){} }
function showView(name){
var k; for(k in views){ if(views[k]) views[k].classList.add('hidden'); } if(views[name]) views[name].classList.remove('hidden'); if(name !== 'landing') document.body.classList.remove('landing-visible');
if(name === 'landing' && typeof loadLandingPreview === 'function') setTimeout(loadLandingPreview, 50);
}
var REACTION_OPTIONS = [{ type:'muzhik', labelKey:'reactionMuzhik', emoji:'', color:'#3b82f6' }, { type:'koroleva', labelKey:'reactionKoroleva', emoji:'', color:'#a855f7' }, { type:'rzhaka', labelKey:'reactionRzhaka', emoji:'', color:'#eab308' }, { type:'fire', labelKey:'reactionFire', emoji:'üî•', color:'#ef4444' }, { type:'fu', labelKey:'reactionFu', emoji:'üëé', color:'#6b7280' }, { type:'grustno', labelKey:'reactionGrustno', emoji:'', color:'#6366f1' }, { type:'babki', labelKey:'reactionBabki', emoji:'', color:'#22c55e' }, { type:'hahaha', labelKey:'reactionHahaha', emoji:'', color:'#f97316' }, { type:'useful', labelKey:'reactionUseful', emoji:'üëç', color:'#ff7f00' }];
function formatDate(s){ var d = new Date(s); var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; return d.toLocaleDateString(loc,{ day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit' }); }
function formatStatNumber(n){ if(n == null || n === '') return '0'; var x = parseInt(n, 10); if(isNaN(x)) return String(n); if(x >= 1000000) return (x / 1000000).toFixed(1).replace(/\.0$/, '') + ' –º–ª–Ω'; if(x >= 1000) return (x / 1000).toFixed(1).replace(/\.0$/, '') + ' —Ç—ã—Å.'; return x.toLocaleString('ru-RU'); }
function avatarHtml(avatarUrl, name){ var initial = (name && String(name).trim()) ? String(name).trim().charAt(0).toUpperCase() : '?'; if(avatarUrl && String(avatarUrl).trim()) return '<span class="avatar-wrap"><img class="avatar-img" src="' + escapeHtml(avatarUrl) + '" alt="" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><span class="avatar-initial" style="display:none">' + escapeHtml(initial) + '</span></span>'; return '<span class="avatar-wrap avatar-initial">' + escapeHtml(initial) + '</span>'; }
function showToast(message, type){ type = type || 'info'; var container = document.getElementById('toast-container'); if(!container) return; var el = document.createElement('div'); el.className = 'toast toast-' + type; el.innerHTML = '<span class="toast-icon">' + (type === 'error' ? '‚ö†' : type === 'success' ? '‚úì' : '‚Ñπ') + '</span><span class="toast-message">' + escapeHtml(message) + '</span>'; container.appendChild(el); el.offsetHeight; el.classList.add('toast-visible'); var remove = function(){ el.classList.remove('toast-visible'); setTimeout(function(){ if(el.parentNode) el.parentNode.removeChild(el); }, 300); }; setTimeout(remove, 5000); el.addEventListener('click', remove); }
function formatPostBody(text, highlightQuery){
if(!text) return '';
var s = escapeHtml(text);
s = s.replace(/\n/g, '<br>');
s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
s = s.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
s = s.replace(/#([a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]+)/g, '<a href="#/search/$1" class="hashtag">#$1</a>');
if(highlightQuery && highlightQuery.trim()){ var q = escapeHtml(highlightQuery.trim()); var re = new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/\s+/g, '|') + ')', 'gi'); s = s.replace(re, '<mark class="search-highlight">$1</mark>'); }
return s;
}
function renderMediaHtml(mediaUrls){ if(!mediaUrls || !mediaUrls.length) return ''; return mediaUrls.map(function(m){ var url = (m && m.url) ? m.url : (typeof m === 'string' ? m : ''); var type = (m && m.type) ? m.type : 'image'; if(!url) return ''; if(type === 'video') return '<div class="post-media-wrap"><video class="post-media post-media-video" src="' + escapeHtml(url) + '" controls preload="metadata"></video></div>'; return '<div class="post-media-wrap"><img class="post-media post-media-img" src="' + escapeHtml(url) + '" alt="" loading="lazy" onerror="this.parentElement.style.display=\'none\'"></div>'; }).filter(Boolean).join(''); }
function reactionPillsHtml(postId, r, userType){
r = r || {}; userType = userType || null;
var pills = REACTION_OPTIONS.filter(function(o){ return (r[o.type]|0) > 0; }).map(function(o){ var count = r[o.type]|0; var lbl = t(o.labelKey); var active = userType === o.type ? ' reaction-pill-active' : ''; var em = o.emoji || ''; var clr = o.color ? ' style="--reaction-color:' + o.color + '"' : ''; var disp = em ? ('<span class="reaction-emoji">' + em + '</span> ') : (escapeHtml(lbl) + ' '); return '<button type="button" class="reaction-pill reaction-pill-' + o.type + active + '" data-post-id="' + postId + '" data-type="' + o.type + '" title="' + escapeHtml(lbl) + '"' + clr + '>' + disp + count + '</button>'; }).join('');
return pills;
}
function reactionBlockHtml(postId, r, userType){
r = r || {}; userType = userType || null;
var opts = REACTION_OPTIONS.map(function(o){ var lbl = t(o.labelKey); var em = o.emoji || ''; var clr = o.color ? ' style="--reaction-color:' + o.color + '"' : ''; var disp = em ? ('<span class="reaction-emoji">' + em + '</span> ') : ''; return '<button type="button" class="reaction-picker-option reaction-option-' + o.type + '" data-post-id="' + postId + '" data-type="' + o.type + '" title="' + escapeHtml(lbl) + '"' + clr + '>' + disp + escapeHtml(lbl) + '</button>'; }).join('');
var pills = reactionPillsHtml(postId, r, userType);
return '<span class="reaction-block-wrap"><span class="reaction-picker-wrap"><button type="button" class="reaction-picker-trigger" data-post-id="' + postId + '" title="' + escapeHtml(t('reaction')) + '" aria-haspopup="true"><svg class="reaction-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9 9h.01M15 9h.01M9.75 15a3.375 3.375 0 0 0 6.5 0"/></svg></button><div class="reaction-picker-dropdown">' + opts + '</div></span><span class="reaction-bar-wrap">' + pills + '</span></span>';
}
function commentReactionPillsHtml(commentId, r, userType){
r = r || {}; userType = userType || null;
var pills = REACTION_OPTIONS.filter(function(o){ return (r[o.type]|0) > 0; }).map(function(o){ var count = r[o.type]|0; var lbl = t(o.labelKey); var active = userType === o.type ? ' reaction-pill-active' : ''; var em = o.emoji || ''; var clr = o.color ? ' style="--reaction-color:' + o.color + '"' : ''; var disp = em ? ('<span class="reaction-emoji">' + em + '</span> ') : (escapeHtml(lbl) + ' '); return '<button type="button" class="reaction-pill comment-reaction-pill reaction-pill-' + o.type + active + '" data-comment-id="' + commentId + '" data-type="' + o.type + '" title="' + escapeHtml(lbl) + '"' + clr + '>' + disp + count + '</button>'; }).join('');
return pills;
}
function commentReactionBlockHtml(commentId, r, userType){
r = r || {}; userType = userType || null;
var opts = REACTION_OPTIONS.map(function(o){ var lbl = t(o.labelKey); var em = o.emoji || ''; var clr = o.color ? ' style="--reaction-color:' + o.color + '"' : ''; var disp = em ? ('<span class="reaction-emoji">' + em + '</span> ') : ''; return '<button type="button" class="reaction-picker-option comment-reaction-option reaction-option-' + o.type + '" data-comment-id="' + commentId + '" data-type="' + o.type + '" title="' + escapeHtml(lbl) + '"' + clr + '>' + disp + escapeHtml(lbl) + '</button>'; }).join('');
var pills = commentReactionPillsHtml(commentId, r, userType);
return '<span class="reaction-block-wrap comment-reaction-wrap"><span class="reaction-picker-wrap"><button type="button" class="reaction-picker-trigger comment-reaction-trigger" data-comment-id="' + commentId + '" title="' + escapeHtml(t('reaction')) + '"><svg class="reaction-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9 9h.01M15 9h.01M9.75 15a3.375 3.375 0 0 0 6.5 0"/></svg></button><div class="reaction-picker-dropdown">' + opts + '</div></span><span class="reaction-bar-wrap">' + pills + '</span></span>';
}
function renderPostCard(p, cat){
var catName = (cat && cat.name) || p.categoryId;
var v = (p.views !== undefined && p.views !== null) ? p.views : BizForum.data.getViews(p.id);
var r = (p.reactions !== undefined && p.reactions !== null) ? p.reactions : BizForum.data.getReactions(p.id);
var commentsCount = p.commentsCount || 0;
var isFav = (p._isFavorite === true);
var favClass = isFav ? 'fav-btn card-fav fav-active' : 'fav-btn card-fav';
var authorAvatar = avatarHtml((p.authorAvatarUrl || ''), p.author);
var showAuthorLink = (p.author && String(p.author).trim()) && !p.isAnonymous && p.authorId;
var authorSpan = (p.author && String(p.author).trim()) ? (showAuthorLink ? '<a href="#/user/' + escapeHtml(p.authorId) + '" class="post-card-author">' + authorAvatar + '<span>' + escapeHtml(p.author) + '</span></a>' : '<span class="post-card-author">' + authorAvatar + '<span>' + escapeHtml(p.author) + '</span></span>') : '';
var ownClass = (window.__bizforum_user_id && p.authorId === window.__bizforum_user_id) ? ' post-card-own' : '';
var deleteBtn = ownClass && window.BizForum.deletePost ? '<button type="button" class="post-card-delete-btn" data-post-id="' + p.id + '" title="' + escapeHtml(t('adminDeletePost')) + '" aria-label="' + escapeHtml(t('adminDeletePost')) + '"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>' : '';
var shareBtn = '<button type="button" class="btn-share post-card-share" data-post-id="' + p.id + '" title="' + escapeHtml(t('sharePost')) + '"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg></button>';
var paidPost = !!(p.price && p.price > 0);
var canSeeContent = paidPost ? (p._hasPurchased || (window.__bizforum_user_id && p.authorId === window.__bizforum_user_id)) : (p._canSeeContent !== false);
var mediaHtml = renderMediaHtml(p.mediaUrls);
var excerptHtml = (p._highlightQuery && p.excerpt) ? formatPostBody(p.excerpt, p._highlightQuery) : escapeHtml(p.excerpt || '');
var excerptBlock = canSeeContent ? ('<p class="post-card-excerpt">' + excerptHtml + '</p>' + (mediaHtml ? '<div class="post-card-media">' + mediaHtml + '</div>' : '')) : ('<p class="post-card-excerpt post-card-excerpt-blurred">' + excerptHtml + '</p>' + (mediaHtml ? '<div class="post-card-media post-card-media-blurred">' + mediaHtml + '</div>' : ''));
var priceBadge = paidPost ? '<span class="post-card-price-badge">' + (p.price || 0) + '</span>' : '';
var buyBtn = (paidPost && !canSeeContent && window.BizForum.buyPost) ? '<button type="button" class="btn-buy-post post-card-buy-btn" data-post-id="' + p.id + '" data-price="' + (p.price || 0) + '">' + t('buyPost') + ' (' + (p.price || 0) + ')</button>' : '';
var openBtn = (!paidPost && p._subscriptionBlur && window.BizForum.usePostOpen) ? (p._opensRemaining > 0 ? '<button type="button" class="post-card-open-btn" data-post-id="' + p.id + '">' + (t('subscriptionOpen') || '–û—Ç–∫—Ä—ã—Ç—å') + ' (' + (t('subscriptionOpensLeft') || '–æ—Å—Ç–∞–ª–æ—Å—å') + ' ' + p._opensRemaining + ')</button>' : '<a href="#/subscription" class="post-card-subscribe-link">' + (t('subscriptionConnectUnlimited') || '–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ç–∞—Ä–∏—Ñ –±–µ–∑–ª–∏–º–∏—Ç') + '</a>') : '';
var commentsBtnHtml = commentsCount > 0 ? ('<button type="button" class="stat-comments post-card-comments-link" data-post-id="' + p.id + '">' + commentsCount + ' ' + t('commentsShort') + '</button><button type="button" class="post-card-leave-comment-link" data-post-id="' + p.id + '">' + t('leaveComment') + '</button>') : ('<button type="button" class="stat-comments post-card-comments-link post-card-leave-comment-link" data-post-id="' + p.id + '">' + t('leaveComment') + '</button>');
return '<div class="post-card' + ownClass + (paidPost ? ' post-card-paid' : '') + (p._subscriptionBlur ? ' post-card-blurred' : '') + '" data-post-id="' + p.id + '">' + deleteBtn + '<div class="post-card-link" role="button" tabindex="0" data-post-id="' + p.id + '"><div class="post-card-meta"><span class="post-card-category">' + catName + '</span>' + authorSpan + '<span class="post-card-date">' + formatDate(p.createdAt) + '</span>' + priceBadge + '</div><h2 class="post-card-title">' + (p._highlightQuery && p.title ? formatPostBody(p.title, p._highlightQuery) : escapeHtml(p.title)) + '</h2>' + excerptBlock + (canSeeContent ? '<a href="#/post/' + p.id + '" class="post-card-read-more">' + t('readMore') + '</a>' : '') + buyBtn + openBtn + '</div><div class="post-card-stats"><span class="stat-views">' + v + ' ' + t('views') + '</span>' + commentsBtnHtml + reactionBlockHtml(p.id, r, p.userReaction) + '<button type="button" class="' + favClass + '" data-post-id="' + p.id + '" title="' + escapeHtml(t('favTitle')) + '"><svg class="fav-icon" xmlns="http://www.w3.org/2000/svg" fill="' + (isFav ? 'currentColor' : 'none') + '" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"/></svg></button>' + shareBtn + '</div><div class="post-card-comments" data-post-id="' + p.id + '"></div></div>';
}
function renderCommentsInlineHtml(comments, postId, verified){
if(!comments || !comments.length) return '<p class="comments-login-hint">' + t('noComments') + '</p>';
var byParent = {}; comments.forEach(function(c){ var pid = (c.parentId === null || c.parentId === undefined) ? '' : c.parentId; if(!byParent[pid]) byParent[pid] = []; byParent[pid].push(c); });
function renderTree(parentId){
var list = (byParent[parentId || ''] || []).slice(); list.sort(function(a,b){ return new Date(a.createdAt) - new Date(b.createdAt); });
return list.map(function(c){
var repliesHtml = renderTree(c.id);
var authorLink = (c.authorId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(c.authorId))) ? '<a href="#/user/' + escapeHtml(c.authorId) + '">' + escapeHtml(c.author) + '</a>' : escapeHtml(c.author);
var replyBtn = verified && window.BizForum.data && window.BizForum.data.addComment ? '<button type="button" class="reply-comment-inline" data-post-id="' + postId + '" data-comment-id="' + c.id + '" data-author="' + escapeHtml(c.author || '') + '">' + t('commentReply') + '</button>' : '';
return '<div class="comment comment-inline' + (parentId ? ' comment-reply' : '') + '" data-comment-id="' + c.id + '"><div class="comment-meta">' + authorLink + ' ¬∑ ' + formatDate(c.createdAt) + (replyBtn ? ' ' + replyBtn : '') + '</div><div class="comment-body">' + formatCommentBodyWithMentions(c.body) + '</div>' + (repliesHtml ? '<div class="comment-replies">' + repliesHtml + '</div>' : '') + '</div>'; }).join('');
}
return renderTree('');
}
function renderFeed(list, container, categoryMap){
if(!container) return;
categoryMap = categoryMap || {};
var emptyHtml = '<div class="empty-state"><div class="empty-state-icon" aria-hidden="true">‚Äî</div><h3>' + escapeHtml(t('emptyStateFeed')) + '</h3><p>' + escapeHtml(t('emptyStateFeedDesc')) + '</p></div>';
container.innerHTML = list.length ? list.map(function(p){ var cat = categoryMap[p.categoryId] || null; return renderPostCard(p, cat); }).join('') : emptyHtml;
bindCardReactionDelegation(container);
bindFavDelegation(container);
bindShareDelegation(container);
bindDeletePostDelegation(container);
bindPostCardLinks(container);
}
function loadCommentsAndFormInCard(postId, commentsEl){
if(!commentsEl) return;
commentsEl.innerHTML = '<p class="comments-loading">' + t('loading') + '</p>';
var isVerifiedPromise = (window.BizForum && window.BizForum.isVerified) ? window.BizForum.isVerified() : Promise.resolve(false);
var hasAuth = !!(window.__bizforum_user_id);
var commentsPromise = (window.BizForum && window.BizForum.data && window.BizForum.data.getComments) ? window.BizForum.data.getComments(postId) : Promise.resolve([]);
commentsPromise.catch(function(){ return []; }).then(function(comments){
return isVerifiedPromise.then(function(verified){
commentsEl._loaded = true;
var formHtml = verified && window.BizForum && window.BizForum.data && window.BizForum.data.addComment ? '<div class="comment-form comment-form-inline"><textarea rows="2" placeholder="' + escapeHtml(t('commentPlaceholder')) + '" class="comment-inline-body" data-post-id="' + postId + '"></textarea><div class="auth-error comment-inline-error"></div><button type="button" class="comment-submit comment-inline-submit" data-post-id="' + postId + '">' + t('commentSubmit') + '</button></div>' : '';
var loginHint = !hasAuth && typeof openAuthModal === 'function' ? '<p class="comment-login-hint"><button type="button" class="comment-login-hint-btn">' + (t('authLogin') || '–í–æ–π—Ç–∏') + '</button> ' + (t('leaveComment') || '—á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π') + '</p>' : '';
if(!verified && hasAuth) loginHint = '<p class="comment-login-hint muted">' + (t('commentVerificationHint') || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ—á—Ç—É, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å') + '</p>';
commentsEl.innerHTML = '<div class="comments-title-inline">' + t('comments') + '</div>' + renderCommentsInlineHtml(comments || [], postId, verified) + (formHtml || loginHint);
if(formHtml){
var textarea = commentsEl.querySelector('.comment-inline-body');
var errEl = commentsEl.querySelector('.comment-inline-error');
var submitBtn = commentsEl.querySelector('.comment-inline-submit');
var card = commentsEl.closest('.post-card');
if(submitBtn && textarea) bindInlineCommentSubmit(submitBtn, textarea, errEl, postId, commentsEl, card);
}
var card = commentsEl.closest('.post-card');
bindInlineReplyButtons(commentsEl, postId, card);
var loginBtn = commentsEl.querySelector('.comment-login-hint-btn');
if(loginBtn && typeof openAuthModal === 'function') loginBtn.addEventListener('click', function(e){ e.preventDefault(); openAuthModal('login'); });
});
});
}
function bindInlineCommentSubmit(btn, textarea, errEl, postId, commentsEl, card){
function doSubmit(author, parentId){
author = author || getAuthorName() || '–ì–æ—Å—Ç—å';
if(!window.BizForum.data || !window.BizForum.data.addComment){ if(errEl) errEl.textContent = t('error'); return; }
btn.disabled = true;
if(errEl) errEl.textContent = '';
BizForum.data.addComment(postId, (textarea.value || '').trim(), author, getSessionId(), parentId || undefined).then(function(newComment){
textarea.value = '';
if(!newComment){ if(errEl) errEl.textContent = t('error'); return; }
commentsEl._loaded = false;
loadCommentsAndFormInCard(postId, commentsEl);
var statBtn = card && card.querySelector('.post-card-comments-link');
if(statBtn){ BizForum.data.getComments(postId).then(function(list){ statBtn.textContent = (list.length || 0) + ' ' + t('commentsShort'); }); }
}).catch(function(err){ if(errEl) errEl.textContent = (err && err.message) || t('error'); }).finally(function(){ btn.disabled = false; });
}
btn.addEventListener('click', function(){
var text = (textarea.value || '').trim();
if(!text) return;
if(window.BizForum.getDisplayName) window.BizForum.getDisplayName().then(function(a){ doSubmit(a, btn.getAttribute('data-parent-id') || undefined); }).catch(function(){ doSubmit(getAuthorName(), btn.getAttribute('data-parent-id') || undefined); });
else doSubmit(getAuthorName(), btn.getAttribute('data-parent-id') || undefined);
});
}
function bindInlineReplyButtons(commentsEl, postId, card){
if(!commentsEl || !window.BizForum.data || !window.BizForum.data.addComment) return;
if(commentsEl._inlineReplyBound) return;
commentsEl._inlineReplyBound = true;
commentsEl.addEventListener('click', function(e){
var btn = e.target.closest('.reply-comment-inline');
if(!btn) return;
e.preventDefault();
var commentId = btn.getAttribute('data-comment-id');
var author = (btn.getAttribute('data-author') || '').trim();
var mentionPrefix = author ? '@' + author + ' ' : '';
var commentEl = commentsEl.querySelector('.comment[data-comment-id="' + commentId + '"]');
if(!commentEl) return;
var existing = commentEl.querySelector('.comment-reply-form-inline');
if(existing){ existing.remove(); return; }
var formHtml = '<div class="comment-reply-form-inline"><textarea rows="2" placeholder="' + escapeHtml(t('commentPlaceholder')) + '" class="comment-inline-reply-body">' + escapeHtml(mentionPrefix) + '</textarea><div class="auth-error comment-inline-reply-error"></div><button type="button" class="comment-inline-reply-submit" data-post-id="' + postId + '" data-parent-id="' + commentId + '">' + t('commentSubmit') + '</button></div>';
var wrap = document.createElement('div');
wrap.innerHTML = formHtml;
var formEl = wrap.firstElementChild;
var repliesContainer = commentEl.querySelector('.comment-replies');
if(repliesContainer){ repliesContainer.appendChild(formEl); } else { var div = document.createElement('div'); div.className = 'comment-replies'; div.appendChild(formEl); commentEl.appendChild(div); }
var ta = formEl.querySelector('.comment-inline-reply-body');
var errEl = formEl.querySelector('.comment-inline-reply-error');
var subBtn = formEl.querySelector('.comment-inline-reply-submit');
subBtn.setAttribute('data-parent-id', commentId);
if(ta) ta.focus();
subBtn.addEventListener('click', function(){
var text = (ta.value || '').trim();
if(!text) return;
subBtn.disabled = true;
if(errEl) errEl.textContent = '';
function doReply(author){ BizForum.data.addComment(postId, text, author || getAuthorName() || '–ì–æ—Å—Ç—å', getSessionId(), commentId).then(function(newComment){
formEl.remove();
if(newComment){ commentsEl._loaded = false; loadCommentsAndFormInCard(postId, commentsEl); var statBtn = card && card.querySelector('.post-card-comments-link'); if(statBtn){ BizForum.data.getComments(postId).then(function(list){ statBtn.textContent = (list.length || 0) + ' ' + t('commentsShort'); }); } }
}).catch(function(err){ if(errEl) errEl.textContent = (err && err.message) || t('error'); }).finally(function(){ subBtn.disabled = false; }); }
if(window.BizForum.getDisplayName) window.BizForum.getDisplayName().then(doReply).catch(function(){ doReply(''); });
else doReply(getAuthorName());
});
});
}
function bindPostCardLinks(container){
if(!container) return;
container.addEventListener('click', function(e){
if(e.target.closest('.post-card-buy-btn') || e.target.closest('.post-full-buy-btn')) return;
if(e.target.closest('.post-card-open-btn') || e.target.closest('.post-full-open-btn')) return;
if(e.target.closest('.post-card-delete-btn')) return;
if(e.target.closest('.post-card-subscribe-link') || e.target.closest('.post-full-subscribe-link')){ var lnk = e.target.closest('.post-card-subscribe-link') || e.target.closest('.post-full-subscribe-link'); if(lnk && lnk.getAttribute('href') === '#/subscription'){ window.location.hash = '#/subscription'; } return; }
if(e.target.closest('.post-card-read-more')){ e.preventDefault(); e.stopPropagation(); var rm = e.target.closest('.post-card-read-more'); var href = rm && rm.getAttribute('href'); if(href && href.indexOf('#/') === 0){ window.location.hash = href; } return; }
var authorLink = e.target.closest('a.post-card-author, a.post-full-author, a.comment-author-link'); if(authorLink) return;
if(e.target.closest('.reaction-block-wrap') || e.target.closest('.fav-btn') || e.target.closest('.post-card-share') || e.target.closest('.btn-share')) return;
if(e.target.closest('.post-card-comments-link') || e.target.closest('.post-card-leave-comment-link')){ e.preventDefault(); e.stopPropagation(); var btn = e.target.closest('.post-card-comments-link') || e.target.closest('.post-card-leave-comment-link'); var id = btn && btn.getAttribute('data-post-id'); if(!id) return; var card = btn.closest('.post-card'); var commentsEl = card && card.querySelector('.post-card-comments'); if(!card || !commentsEl) return; if(card.classList.contains('post-card-expanded')){ card.classList.remove('post-card-expanded'); commentsEl.innerHTML = ''; commentsEl._loaded = false; return; } card.classList.add('post-card-expanded'); if(typeof commentsEl.scrollIntoView === 'function') commentsEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); if(!commentsEl._loaded) loadCommentsAndFormInCard(id, commentsEl); return; }
var link = e.target.closest('.post-card-link');
if(!link) return;
e.preventDefault(); e.stopPropagation();
var id = link.getAttribute('data-post-id'); if(!id) return;
var card = link.closest('.post-card'); if(!card) return;
var commentsEl = card.querySelector('.post-card-comments'); if(!commentsEl) return;
if(card.classList.contains('post-card-expanded')){ card.classList.remove('post-card-expanded'); commentsEl.innerHTML = ''; commentsEl._loaded = false; return; }
card.classList.add('post-card-expanded');
if(commentsEl._loaded){ return; }
loadCommentsAndFormInCard(id, commentsEl);
});
}
function bindFavDelegation(container){
if(!container) return;
container.addEventListener('click', function(e){ var btn = e.target.closest('.fav-btn'); if(!btn) return; e.preventDefault(); e.stopPropagation(); var id = btn.getAttribute('data-post-id'); if(!id) return; var p = BizForum.data.toggleFavorite(id); function updateBtn(isFav){ btn.classList.toggle('fav-active', isFav); btn.querySelector('.fav-icon') && btn.querySelector('.fav-icon').setAttribute('fill', isFav ? 'currentColor' : 'none'); } if(p && typeof p.then === 'function') p.then(function(favIds){ updateBtn(favIds && favIds.indexOf(id) >= 0); }); else updateBtn(BizForum.data.isFavorite(id)); });
}
function doSharePost(postId){ var url = window.location.origin + window.location.pathname + '#/post/' + postId; if(navigator.share){ navigator.share({ title: document.title, url: url }).catch(function(){ navigator.clipboard && navigator.clipboard.writeText(url); }); } else { navigator.clipboard && navigator.clipboard.writeText(url).then(function(){ if(window.BizForum && window.BizForum.i18n && window.BizForum.i18n.t) alert(window.BizForum.i18n.t('sharePost') + ': —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); }); } }
function bindShareDelegation(container){ if(!container) return; container.addEventListener('click', function(e){ var btn = e.target.closest('.post-card-share'); if(btn){ e.preventDefault(); e.stopPropagation(); var id = btn.getAttribute('data-post-id'); if(id) doSharePost(id); return; } }); }
function bindDeletePostDelegation(container){ if(!container || !window.BizForum || !window.BizForum.deletePost) return; container.addEventListener('click', function(e){ var btn = e.target.closest('.post-card-delete-btn'); if(!btn) return; e.preventDefault(); e.stopPropagation(); var id = btn.getAttribute('data-post-id'); if(!id) return; if(!confirm(t('confirmDeleteOwnPost') || '–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return; var card = btn.closest('.post-card'); btn.disabled = true; window.BizForum.deletePost(id).then(function(){ if(card && card.parentNode) card.remove(); if(typeof showToast === 'function') showToast(t('postDeleted') || '–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω', 'success'); }).catch(function(err){ btn.disabled = false; var msg = (err && err.message) ? err.message : t('error'); if(typeof showToast === 'function') showToast(msg, 'error'); else alert(msg); }); }); }
function bindBuyPostDelegation(container){ if(!container || !window.BizForum || !window.BizForum.buyPost) return; container.addEventListener('click', function(e){ var btn = e.target.closest('.post-card-buy-btn, .post-full-buy-btn'); if(!btn) return; e.preventDefault(); e.stopPropagation(); var id = btn.getAttribute('data-post-id'); if(!id) return; if(!window.__bizforum_user_id){ if(typeof openAuthModal === 'function') openAuthModal('login'); return; } btn.disabled = true; window.BizForum.buyPost(id).then(function(){ if(typeof updateAuthHeader === 'function') updateAuthHeader(); window.location.hash = '#/post/' + id; }).catch(function(err){ var msg = err && err.message ? err.message : t('error'); if(/—É–∂–µ –∫—É–ø–∏–ª|already bought/i.test(msg)){ if(typeof updateAuthHeader === 'function') updateAuthHeader(); window.location.hash = '#/post/' + id; return; } if(/–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ|—Å—Ä–µ–¥—Å—Ç–≤|balance|–±–∞–ª–∞–Ω—Å/i.test(msg)){ if(typeof showToast === 'function') showToast((t('balanceTopUpHint') || '–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤.'), 'error'); if(typeof openBalanceModal === 'function') openBalanceModal(); } else if(typeof showToast === 'function') showToast(msg, 'error'); else alert(msg); btn.disabled = false; }); }); }
function bindOpenPostDelegation(container){ if(!container || !window.BizForum || !window.BizForum.usePostOpen) return; container.addEventListener('click', function(e){ var btn = e.target.closest('.post-card-open-btn, .post-full-open-btn'); if(!btn) return; e.preventDefault(); e.stopPropagation(); var id = btn.getAttribute('data-post-id'); if(!id) return; if(!window.__bizforum_user_id){ if(typeof openAuthModal === 'function') openAuthModal('login'); return; } btn.disabled = true; window.BizForum.usePostOpen(id).then(function(){ if(typeof loadPost === 'function' && currentPostId === id){ loadPost(id); } else { window.location.hash = '#/post/' + id; } }).catch(function(err){ btn.disabled = false; if(err && err.message && err.message.indexOf('post_opens_limit') >= 0){ if(typeof loadSubscriptionView === 'function') loadSubscriptionView(); window.location.hash = '#/subscription'; alert(t('subscriptionOutOfOpens') || '–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –±–µ–∑–ª–∏–º–∏—Ç.'); } else alert((err && err.message) || t('error')); }); }); }
function renderSidebarCategories(cats){
if(!categoryListEl) return;
categoryListEl.innerHTML = '<li><a href="#/">' + t('all') + '</a></li>' + cats.map(function(c){ return '<li><a href="#/category/' + c.id + '">' + escapeHtml(c.name) + '</a></li>'; }).join('');
}
function updateSidebarTrends(list, categoryMap){
var wrap = document.getElementById('sidebar-trends-wrap'); var ul = document.getElementById('sidebar-trends'); if(!wrap || !ul) return;
if(!list || !list.length){ wrap.classList.add('hidden'); return; }
var byCat = {}; list.forEach(function(p){ var id = p.categoryId; if(id) byCat[id] = (byCat[id] || 0) + 1; });
var ids = Object.keys(byCat).sort(function(a,b){ return byCat[b] - byCat[a]; }).slice(0, 5);
categoryMap = categoryMap || {}; ul.innerHTML = ids.map(function(id){ var cat = categoryMap[id]; var name = cat ? cat.name : id; return '<li><a href="#/category/' + escapeHtml(id) + '">' + escapeHtml(name) + '</a></li>'; }).join('');
wrap.classList.remove('hidden');
}
function renderPostFull(p, cat){
if(!postFullEl || !postReactionsEl) return;
var catName = (cat && cat.name) || p.categoryId;
var v = (p.views !== undefined && p.views !== null) ? p.views : BizForum.data.getViews(p.id);
var rRaw = (p.reactions !== undefined && p.reactions !== null) ? p.reactions : BizForum.data.getReactions(p.id);
var authorName = (p.author && String(p.author).trim()) ? escapeHtml(p.author) : '';
var pAvatar = avatarHtml((p.authorAvatarUrl || ''), p.author);
var showAuthorLinkFull = authorName && !p.isAnonymous && p.authorId;
var metaAuthor = authorName ? (showAuthorLinkFull ? '<a href="#/user/' + escapeHtml(p.authorId) + '" class="post-full-author">' + pAvatar + '<span>' + authorName + '</span></a>' : '<span class="post-full-author">' + pAvatar + '<span>' + authorName + '</span></span>') : '';
var paidPost = !!(p.price && p.price > 0);
var canSeeContent = paidPost ? (p._hasPurchased || (window.__bizforum_user_id && p.authorId === window.__bizforum_user_id)) : (p._canSeeContent !== false);
var bodyHtml = formatPostBody(p.body || '');
var mediaHtml = renderMediaHtml(p.mediaUrls || []);
var bodyBlock = canSeeContent ? '<div class="post-full-body">' + bodyHtml + '</div>' + (mediaHtml ? '<div class="post-full-media">' + mediaHtml + '</div>' : '') : '<div class="post-full-body post-full-body-blurred">' + bodyHtml + '</div>' + (mediaHtml ? '<div class="post-full-media post-full-media-blurred">' + mediaHtml + '</div>' : '');
var priceBadge = paidPost ? '<span class="post-full-price-badge">' + (p.price || 0) + '</span>' : '';
var buyBtn = (paidPost && !canSeeContent && window.BizForum.buyPost) ? '<div class="post-full-buy-wrap"><button type="button" class="btn-buy-post post-full-buy-btn" data-post-id="' + p.id + '" data-price="' + (p.price || 0) + '">' + t('buyPost') + ' (' + (p.price || 0) + ')</button></div>' : '';
var openBtn = (!paidPost && p._subscriptionBlur && window.BizForum.usePostOpen) ? (p._opensRemaining > 0 ? '<div class="post-full-open-wrap"><button type="button" class="post-full-open-btn" data-post-id="' + p.id + '">' + (t('subscriptionOpen') || '–û—Ç–∫—Ä—ã—Ç—å') + ' (' + (t('subscriptionOpensLeft') || '–æ—Å—Ç–∞–ª–æ—Å—å') + ' ' + p._opensRemaining + ')</button></div>' : '<div class="post-full-open-wrap"><a href="#/subscription" class="post-full-subscribe-link">' + (t('subscriptionConnectUnlimited') || '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –±–µ–∑–ª–∏–º–∏—Ç') + '</a></div>') : '';
postFullEl.innerHTML = '<div class="post-full-meta"><span class="post-full-category">' + catName + '</span>' + metaAuthor + '<span class="post-full-date">' + formatDate(p.createdAt) + '</span><span class="post-full-views">' + v + ' ' + t('views') + '</span>' + priceBadge + '</div><h1 class="post-full-title">' + escapeHtml(p.title) + '</h1>' + bodyBlock + buyBtn + openBtn;
function setReactionsBar(r, userType){ postReactionsEl.innerHTML = '<div class="reactions-bar"><span class="reactions-label">' + t('reactions') + ':</span>' + reactionBlockHtml(p.id, r || {}, userType) + '</div><div class="post-full-stats" id="post-full-stats">' + t('dash') + '</div>'; }
if(rRaw && typeof rRaw.then === 'function'){ rRaw.then(function(r){ var ur = BizForum.data.getUserReaction && BizForum.data.getUserReaction(p.id); if(ur && typeof ur.then === 'function') ur.then(function(ut){ setReactionsBar(r, ut); }); else setReactionsBar(r, null); }); } else { var ur = BizForum.data.getUserReaction && BizForum.data.getUserReaction(p.id); if(ur && typeof ur.then === 'function') ur.then(function(ut){ setReactionsBar(rRaw || {}, ut); }); else setReactionsBar(rRaw || {}, null); }
}
function renderCommentItem(c, commentsMap, isReply){
var sid = getSessionId();
var own = c.authorId && c.authorId === sid;
var actions = own ? '<span class="comment-actions"><button type="button" class="edit-comment" data-comment-id="' + c.id + '">' + t('commentEdit') + '</button><button type="button" class="delete-comment" data-comment-id="' + c.id + '">' + t('commentDelete') + '</button></span>' : '';
var adminDel = adminModeOn && window.BizForum && window.BizForum.adminDeleteComment ? '<span class="comment-actions"><button type="button" class="admin-delete-comment" data-comment-id="' + c.id + '">' + t('commentDeleteAdmin') + '</button></span>' : '';
var replyBtn = !isReply && window.BizForum && window.BizForum.isVerified ? '<span class="comment-actions"><button type="button" class="reply-comment" data-comment-id="' + c.id + '" data-author-id="' + (c.authorId || '') + '" data-author="' + escapeHtml(c.author || '') + '">' + t('commentReply') + '</button></span>' : '';
var replyClass = isReply ? ' comment comment-reply' : 'comment';
var html = '<div class="' + replyClass + '" data-comment-id="' + c.id + '"><div class="comment-meta">' + escapeHtml(c.author) + ' ¬∑ ' + formatDate(c.createdAt) + actions + adminDel + replyBtn + '</div><div class="comment-body">' + formatCommentBodyWithMentions(c.body) + '</div><div class="comment-replies"></div></div>';
return html;
}
var commentsSortMode = 'new';
function renderComments(comments, reactionsMap, bestAnswerId, postAuthorId, isPostAuthor){
if(!commentsListEl) return;
reactionsMap = reactionsMap || {}; bestAnswerId = bestAnswerId || null; postAuthorId = postAuthorId || null; isPostAuthor = !!isPostAuthor;
commentAuthorMap = {}; comments.forEach(function(c){ var n = (c.author || '').trim().toLowerCase(); if(n && c.authorId) commentAuthorMap[n] = c.authorId; });
var sid = getSessionId();
var byParent = {}; var roots = [];
comments.forEach(function(c){ var pid = c.parentId || ''; if(!byParent[pid]) byParent[pid] = []; byParent[pid].push(c); });
function usefulScore(c){ var r = reactionsMap[c.id]; if(!r || !r.reactions) return 0; return (r.reactions.useful || 0); }
roots = byParent[''] || byParent[null] || []; roots.sort(function(a,b){ if(bestAnswerId && a.id === bestAnswerId) return -1; if(bestAnswerId && b.id === bestAnswerId) return 1; if(commentsSortMode === 'useful') return (usefulScore(b) || 0) - (usefulScore(a) || 0); if(commentsSortMode === 'old') return new Date(a.createdAt) - new Date(b.createdAt); return new Date(b.createdAt) - new Date(a.createdAt); });
function renderTree(parentId){
var list = (byParent[parentId] || []).slice(); list.sort(function(a,b){ return new Date(a.createdAt) - new Date(b.createdAt); });
return list.map(function(c){
var repliesHtml = renderTree(c.id);
var own = c.authorId && (c.authorId === sid || c.authorId === window.__bizforum_user_id);
var ownClass = own ? ' comment-own' : '';
var bestBadge = (bestAnswerId && c.id === bestAnswerId) ? '<span class="comment-best-badge">' + escapeHtml(t('bestAnswer')) + '</span>' : '';
var canMarkBest = (postAuthorId && isPostAuthor && window.BizForum && window.BizForum.setBestAnswer) || (adminModeOn && window.BizForum && window.BizForum.adminSetBestAnswer);
var useAdminForBest = adminModeOn && !isPostAuthor && window.BizForum && window.BizForum.adminSetBestAnswer;
var markBtn = (canMarkBest && c.id !== bestAnswerId) ? '<span class="comment-actions"><button type="button" class="best-answer-btn" data-comment-id="' + c.id + '" data-admin-only="' + (useAdminForBest ? '1' : '0') + '">' + t('markAsBestAnswer') + '</button></span>' : ''; var unmarkBtn = (canMarkBest && bestAnswerId && c.id === bestAnswerId) ? '<span class="comment-actions"><button type="button" class="unmark-best-answer-btn" data-comment-id="' + c.id + '" data-admin-only="' + (useAdminForBest ? '1' : '0') + '">' + t('unmarkBestAnswer') + '</button></span>' : '';
var rec = reactionsMap[c.id] || { reactions: {}, userReaction: null };
var reactionHtml = (window.BizForum && window.BizForum.setCommentReaction) ? commentReactionBlockHtml(c.id, rec.reactions || {}, rec.userReaction) : '';
var cAvatar = avatarHtml((c.authorAvatarUrl || ''), c.author);
var authorHtml = (c.authorId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(c.authorId))) ? '<a href="#/user/' + escapeHtml(c.authorId) + '" class="comment-author-link">' + escapeHtml(c.author) + '</a>' : escapeHtml(c.author); var editedBadge = (c.updatedAt && c.updatedAt !== c.createdAt) ? ' <span class="comment-edited-badge" title="' + formatDate(c.updatedAt) + '">(' + (t('commentEdited') || '–∏–∑–º–µ–Ω–µ–Ω–æ') + ')</span>' : ''; var qb = (c.body || '').slice(0, 200).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
var replyData = ' data-author-id="' + (c.authorId || '') + '" data-author="' + escapeHtml(c.author || '') + '" data-quoted-body="' + qb + '"'; return '<div class="comment' + (parentId ? ' comment-reply' : '') + ownClass + '" data-comment-id="' + c.id + '" data-author-id="' + (c.authorId || '') + '"><div class="comment-meta"><span class="comment-meta-inner">' + cAvatar + '<span class="comment-meta-text">' + authorHtml + ' ¬∑ ' + formatDate(c.createdAt) + editedBadge + bestBadge + (own ? '<span class="comment-actions"><button type="button" class="edit-comment" data-comment-id="' + c.id + '">' + t('commentEdit') + '</button><button type="button" class="delete-comment" data-comment-id="' + c.id + '">' + t('commentDelete') + '</button></span>' : '') + (adminModeOn && window.BizForum && window.BizForum.adminDeleteComment ? '<span class="comment-actions"><button type="button" class="admin-delete-comment" data-comment-id="' + c.id + '">' + t('commentDeleteAdmin') + '</button></span>' : '') + (window.BizForum && window.BizForum.isVerified ? '<span class="comment-actions"><button type="button" class="reply-comment" data-comment-id="' + c.id + '"' + replyData + '>' + t('commentReply') + '</button></span>' : '') + markBtn + unmarkBtn + '</span></span></div><div class="comment-body">' + formatCommentBodyWithMentions(c.body) + '</div>' + (reactionHtml ? '<div class="comment-reactions-row">' + reactionHtml + '</div>' : '') + (repliesHtml ? '<div class="comment-replies">' + repliesHtml + '</div>' : '') + '</div>'; }).join('');
}
commentsListEl.innerHTML = comments.length ? renderTree('') : '<p class="comments-login-hint">' + t('noComments') + '</p>';
var sortSel = document.getElementById('comments-sort'); if(sortSel){ sortSel.value = commentsSortMode; sortSel.onchange = function(){ commentsSortMode = sortSel.value; renderComments(comments, reactionsMap, currentPostBestAnswerId, currentPostAuthorId, currentUserIsPostAuthor); bindCommentActions(); bindCommentReactionDelegation(); bindBestAnswerButtons(); }; }
bindCommentActions();
bindCommentReactionDelegation();
bindBestAnswerButtons();
}
function loadAndRenderComments(cb){
if(!currentPostId || !BizForum.data.getComments) return;
BizForum.data.getComments(currentPostId).then(function(comments){
var ids = comments.map(function(c){ return c.id; });
function doRender(rMap){ rMap = rMap || {}; renderComments(comments, rMap, currentPostBestAnswerId, currentPostAuthorId, currentUserIsPostAuthor); try{ var key = 'bizforum_last_seen_' + currentPostId; var last = localStorage.getItem(key); var lastId = last || ''; var idx = comments.findIndex(function(c){ return c.id === lastId; }); var newCount = idx < 0 ? comments.length : comments.length - idx - 1; var badge = document.getElementById('comments-new-badge'); if(badge && newCount > 0){ badge.textContent = newCount + ' ' + (t('commentsNewReplies') || '–Ω–æ–≤—ã—Ö'); badge.classList.remove('hidden'); } else if(badge) badge.classList.add('hidden'); localStorage.setItem(key, ids[ids.length - 1] || ''); } catch(e){} if(cb) cb(comments); }
if(window.BizForum.getCommentReactions && ids.length > 0) window.BizForum.getCommentReactions(ids).then(doRender).catch(function(){ doRender({}); });
else doRender({});
});
}
function bindCommentReactionDelegation(){
if(!commentsListEl || !window.BizForum || !window.BizForum.setCommentReaction) return;
if(commentsListEl._commentReactionBound) return;
commentsListEl._commentReactionBound = true;
commentsListEl.addEventListener('click', function(e){
var pill = e.target.closest('.comment-reaction-pill'); var opt = e.target.closest('.comment-reaction-option'); var trigger = e.target.closest('.comment-reaction-trigger');
if(trigger){ e.preventDefault(); var w = trigger.closest('.reaction-picker-wrap'); var drop = w && w.querySelector('.reaction-picker-dropdown'); if(drop) drop.classList.toggle('open'); return; }
if(!pill && !opt) return;
e.preventDefault();
var btn = pill || opt; var cid = btn.getAttribute('data-comment-id'); var type = btn.getAttribute('data-type');
if(!cid || !type || btn._pending) return;
if(!window.__bizforum_user_id){ if(typeof openAuthModal === 'function') openAuthModal('login'); return; }
var verifiedPromise = window.BizForum.isVerified ? window.BizForum.isVerified() : Promise.resolve(true);
verifiedPromise.then(function(verified){ if(!verified){ alert(t('reactionVerifiedOnly')); return; } btn._pending = true; var isRemove = pill && pill.classList.contains('reaction-pill-active'); var promise = isRemove && window.BizForum.unsetCommentReaction ? window.BizForum.unsetCommentReaction(cid) : window.BizForum.setCommentReaction(cid, type); promise.then(function(rMap){ var rec = (rMap && rMap[cid]) || { reactions: {}, userReaction: null }; var wrap = commentsListEl.querySelector('.comment[data-comment-id="' + cid + '"] .comment-reaction-wrap'); if(wrap) wrap.outerHTML = commentReactionBlockHtml(cid, rec.reactions || {}, rec.userReaction); }).catch(function(){}).finally(function(){ btn._pending = false; }); });
});
}
function bindBestAnswerButtons(){
if(!commentsListEl) return;
commentsListEl.querySelectorAll('.best-answer-btn').forEach(function(btn){
btn.addEventListener('click', function(){ var cid = this.getAttribute('data-comment-id'); var useAdmin = this.getAttribute('data-admin-only') === '1'; if(!cid || !currentPostId) return; var fn = useAdmin && window.BizForum.adminSetBestAnswer ? window.BizForum.adminSetBestAnswer : (window.BizForum.setBestAnswer || window.BizForum.adminSetBestAnswer); if(!fn) return; fn(currentPostId, cid).then(function(){ currentPostBestAnswerId = cid; loadAndRenderComments(); }).catch(function(err){ alert((err && err.message) || t('error')); }); });
});
commentsListEl.querySelectorAll('.unmark-best-answer-btn').forEach(function(btn){
btn.addEventListener('click', function(){ var useAdmin = this.getAttribute('data-admin-only') === '1'; if(!currentPostId) return; var fn = useAdmin && window.BizForum.adminUnsetBestAnswer ? window.BizForum.adminUnsetBestAnswer : (window.BizForum.unsetBestAnswer || window.BizForum.adminUnsetBestAnswer); if(!fn) return; fn(currentPostId).then(function(){ currentPostBestAnswerId = null; loadAndRenderComments(); }).catch(function(err){ alert((err && err.message) || t('error')); }); });
});
}
function bindCommentActions(){
if(!commentsListEl) return;
commentsListEl.querySelectorAll('.edit-comment').forEach(function(btn){
btn.addEventListener('click', function(){ var cid = this.getAttribute('data-comment-id'); var comment = commentsListEl.querySelector('.comment[data-comment-id="' + cid + '"]'); var bodyEl = comment && comment.querySelector('.comment-body'); if(!bodyEl) return; var newBody = prompt(t('promptEditComment'), bodyEl.textContent); if(newBody !== null && newBody.trim()){ BizForum.data.updateComment(currentPostId, cid, newBody.trim()).then(function(){ loadAndRenderComments(function(comments){ updatePostStatsCommentCount(comments.length); }); }); } });
});
commentsListEl.querySelectorAll('.delete-comment').forEach(function(btn){
btn.addEventListener('click', function(){ if(!confirm(t('confirmDeleteComment'))) return; var cid = this.getAttribute('data-comment-id'); BizForum.data.deleteComment(currentPostId, cid).then(function(){ loadAndRenderComments(function(comments){ updatePostStatsCommentCount(comments.length); }); }); });
});
commentsListEl.querySelectorAll('.admin-delete-comment').forEach(function(btn){
btn.addEventListener('click', function(){ if(!confirm(t('confirmDeleteCommentAdmin'))) return; var cid = this.getAttribute('data-comment-id'); if(window.BizForum.adminDeleteComment) window.BizForum.adminDeleteComment(cid).then(function(){ loadAndRenderComments(function(comments){ updatePostStatsCommentCount(comments.length); }); }); });
});
var parentInput = document.getElementById('comment-parent-id'); var replyToEl = document.getElementById('comment-reply-to');
commentsListEl.querySelectorAll('.reply-comment').forEach(function(btn){
btn.addEventListener('click', function(){ var cid = this.getAttribute('data-comment-id'); var authorId = this.getAttribute('data-author-id'); var author = (this.getAttribute('data-author') || '').trim(); var quotedBody = (this.getAttribute('data-quoted-body') || '').trim(); var mentionPrefix = author ? '@' + author + ' ' : ''; var quoteBlock = quotedBody ? '> ' + (author ? author + ': ' : '') + quotedBody.replace(/\n/g, '\n> ') + '\n\n' : ''; currentReplyToAuthorId = authorId || null; if(parentInput) parentInput.value = cid || ''; if(replyToEl){ var meta = this.closest('.comment') && this.closest('.comment').querySelector('.comment-meta'); replyToEl.textContent = t('replyTo') + ' ' + (meta ? meta.textContent.split(' ¬∑ ')[0] : ''); replyToEl.classList.remove('hidden'); } var bodyEl = document.getElementById('comment-body'); if(bodyEl){ bodyEl.value = quoteBlock + mentionPrefix; bodyEl.focus(); } });
});
}
function updateReactionBlock(cardOrContainer, postId, r, userType){
var wrap = cardOrContainer && (cardOrContainer.querySelector ? cardOrContainer.querySelector('.reaction-block-wrap') : null) || (cardOrContainer && cardOrContainer.classList && cardOrContainer.classList.contains('reaction-block-wrap') ? cardOrContainer : null); if(!wrap) return; wrap.outerHTML = reactionBlockHtml(postId, r, userType); }
function triggerReactionCelebrate(container, postId, reactionType){
var wrap = container && (container.querySelector ? container.querySelector('.reaction-block-wrap') : null) || (container && container.classList && container.classList.contains('reaction-block-wrap') ? container : null); if(!wrap) return; var pill = wrap.querySelector('.reaction-pill[data-type="' + reactionType + '"]'); if(!pill) pill = wrap.querySelector('.reaction-picker-trigger'); if(pill){ pill.classList.add('reaction-celebrate'); setTimeout(function(){ pill.classList.remove('reaction-celebrate'); }, 600); } }
function bindReactionPicker(){}
function bindCardReactionDelegation(container){
if(!container) return;
container.addEventListener('click', function(e){
var trigger = e.target.closest('.reaction-picker-trigger'); if(trigger){ e.preventDefault(); e.stopPropagation(); var w = trigger.closest('.reaction-picker-wrap'); var drop = w && w.querySelector('.reaction-picker-dropdown'); if(drop) drop.classList.toggle('open'); return; }
var pill = e.target.closest('.reaction-pill'); var opt = e.target.closest('.reaction-picker-option'); if(!pill && !opt) return; e.preventDefault(); e.stopPropagation(); var btn = pill || opt; var id = btn.getAttribute('data-post-id'); var type = btn.getAttribute('data-type'); if(!id || !type) return; if(!window.__bizforum_user_id){ if(typeof openAuthModal === 'function') openAuthModal('login'); return; } if(btn._reactionPending) return; btn._reactionPending = true; var verifiedPromise = window.BizForum.isVerified ? window.BizForum.isVerified() : Promise.resolve(true); verifiedPromise.then(function(verified){ if(!verified){ alert(t('reactionVerifiedOnly')); btn._reactionPending = false; return; } var userPromise = BizForum.data.getUserReaction && BizForum.data.getUserReaction(id); function applyToggle(currentType){ var myReaction = (typeof currentType === 'string' && currentType) ? currentType : null; var removeOnlyMyReaction = (myReaction === type) && !!BizForum.data.unsetReaction; var promise = removeOnlyMyReaction ? BizForum.data.unsetReaction(id) : BizForum.data.setReaction(id, type); function finish(r){ var ur = BizForum.data.getUserReaction && BizForum.data.getUserReaction(id); if(ur && typeof ur.then === 'function') ur.then(function(ut){ done(r, ut, !removeOnlyMyReaction); }); else done(r, null, !removeOnlyMyReaction); } if(promise && typeof promise.then === 'function') promise.then(finish).catch(function(){ btn._reactionPending = false; }); else finish(promise && typeof promise === 'object' ? promise : BizForum.data.getReactions(id) || {}); } function done(r, userType, didAdd){ btn._reactionPending = false; var card = btn.closest('.post-card'); if(card){ var blockWrap = card.querySelector('.reaction-block-wrap'); if(blockWrap){ blockWrap.outerHTML = reactionBlockHtml(id, r, userType); if(didAdd) setTimeout(function(){ triggerReactionCelebrate(card, id, type); }, 50); } } else if(postReactionsEl && btn.closest('#post-reactions')){ var statsEl = document.getElementById('post-full-stats'); var statsText = statsEl ? statsEl.textContent : '‚Äî'; postReactionsEl.innerHTML = '<div class="reactions-bar"><span class="reactions-label">' + t('reactions') + ':</span>' + reactionBlockHtml(id, r, userType) + '</div><div class="post-full-stats" id="post-full-stats">' + escapeHtml(statsText) + '</div>'; if(didAdd) setTimeout(function(){ triggerReactionCelebrate(postReactionsEl, id, type); }, 50); } else { var wrap = btn.closest('.reaction-block-wrap'); if(wrap){ wrap.outerHTML = reactionBlockHtml(id, r, userType); if(didAdd) setTimeout(function(){ var parent = wrap.parentElement; if(parent) triggerReactionCelebrate(parent, id, type); }, 50); } } if(opt && (drop = btn.closest('.reaction-picker-wrap')) && (drop = drop.querySelector('.reaction-picker-dropdown'))) drop.classList.remove('open'); } if(userPromise && typeof userPromise.then === 'function') userPromise.then(applyToggle); else applyToggle(null); }).catch(function(){ btn._reactionPending = false; }); });
container.addEventListener('mouseenter', function(ev){ var w = ev.target.closest('.reaction-picker-wrap'); if(w && w.querySelector){ var d = w.querySelector('.reaction-picker-dropdown'); if(d){ d.classList.add('open'); if(w._ct) clearTimeout(w._ct); w._ct = null; } } }, true);
container.addEventListener('mouseleave', function(ev){ var w = ev.target.closest('.reaction-picker-wrap'); if(w && !w.contains(ev.relatedTarget)){ var d = w.querySelector('.reaction-picker-dropdown'); if(d) w._ct = setTimeout(function(){ d.classList.remove('open'); w._ct = null; }, 250); } }, true);
container.addEventListener('wheel', function(ev){ var drop = ev.target.closest('.reaction-picker-dropdown'); if(!drop || !drop.classList.contains('open')) return; var el = drop; var top = el.scrollTop === 0; var bottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 1; if((top && ev.deltaY < 0) || (bottom && ev.deltaY > 0)){ ev.preventDefault(); ev.stopPropagation(); } }, { passive: false });
}
function renderCategoriesPage(cats, trendIds){
if(!categoriesGridEl) return;
trendIds = trendIds || [];
categoriesGridEl.innerHTML = cats.map(function(c){ var trendClass = trendIds.indexOf(c.id) >= 0 ? ' category-trending' : ''; return '<a href="#/category/' + c.id + '" class="category-grid-item' + trendClass + '">' + escapeHtml(c.name) + '</a>'; }).join('');
}
function renderFeedSkeletons(n){ n = n || 3; var html = ''; for(var i = 0; i < n; i++){ html += '<div class="post-card post-card-skeleton"><div class="skeleton-line" style="width:60px;height:16px;margin-bottom:12px"></div><div class="skeleton-line" style="width:90%;height:24px;margin-bottom:8px"></div><div class="skeleton-line" style="width:100%;height:14px;margin-bottom:6px"></div><div class="skeleton-line" style="width:80%;height:14px;margin-bottom:12px"></div><div class="skeleton-line" style="width:40%;height:12px"></div></div>'; } return html; }
function escapeHtml(s){ if(!s) return ''; var div = document.createElement('div'); div.textContent = s; return div.innerHTML; }
var commentAuthorMap = {};
function formatCommentBodyWithMentions(text, authorMap){ authorMap = authorMap || commentAuthorMap; if(!text) return ''; var safe = escapeHtml(text); safe = safe.replace(/\n/g, '<br>'); safe = safe.replace(/^&gt; (.+)$/gm, '<blockquote class="comment-quote-block">$1</blockquote>'); return safe.replace(/@([^\s@]+)/g, function(m, name){ var id = authorMap[(name||'').toLowerCase().trim()]; if(id) return '<a href="#/user/' + escapeHtml(id) + '" class="comment-mention">@' + escapeHtml(name) + '</a>'; return '<span class="comment-mention">@' + escapeHtml(name) + '</span>'; }); }
function getSort(){ var sel = document.getElementById('sort'); return sel ? sel.value : 'new'; }
function getSortCat(){ var sel = document.getElementById('sort-cat'); return sel ? sel.value : 'new'; }
var feedFollowingMode = false;
var feedLoading = false;
function loadFeed(sort, append){ if(typeof syncSortPills === 'function') syncSortPills();
if(!listEl) return;
if(append && feedLoading) return;
var off = append ? feedOffset : 0;
if(!append){ feedOffset = 0; feedLoading = true; listEl.innerHTML = (typeof renderFeedSkeletons === 'function' ? renderFeedSkeletons(5) : '<p class="feed-loading">' + t('loading') + '</p>'); }
var opts = { sort: sort || getSort(), limit: PAGE_SIZE, offset: off };
if(feedFollowingMode) opts.followingOnly = true;
return BizForum.data.getPosts(opts).then(function(list){
var next = function(){ return BizForum.data.getCategories().then(function(cats){ var map = {}; cats.forEach(function(c){ map[c.id] = c; }); var listToRender = list; if(document.getElementById('feed-filter-mine') && document.getElementById('feed-filter-mine').checked && window.__bizforum_user_id){ listToRender = list.filter(function(p){ return p.authorId === window.__bizforum_user_id; }); } if(append && listEl.querySelector('.post-card')){ listToRender.forEach(function(p){ listEl.insertAdjacentHTML('beforeend', renderPostCard(p, map[p.categoryId] || null)); }); bindCardReactionDelegation(listEl); bindFavDelegation(listEl); bindShareDelegation(listEl); bindDeletePostDelegation(listEl); bindPostCardLinks(listEl); } else renderFeed(listToRender, listEl, map); updateSidebarTrends(list, map); feedOffset = off + list.length; feedLoading = false; }); };
if(window.BizForum.data.getFavorites && typeof window.BizForum.data.getFavorites().then === 'function'){ return window.BizForum.data.getFavorites().then(function(favIds){ list.forEach(function(p){ p._isFavorite = favIds && favIds.indexOf(p.id) >= 0; }); return next(); }); }
list.forEach(function(p){ p._isFavorite = BizForum.data.isFavorite ? BizForum.data.isFavorite(p.id) : false; }); return next();
});
}
function loadCategoryFeed(categoryId, sort, append){
if(!listCatEl) return;
currentCategoryId = categoryId;
var off = append ? categoryOffset : 0;
if(!append) categoryOffset = 0;
showView('category');
if(!append) listCatEl.innerHTML = (typeof renderFeedSkeletons === 'function' ? renderFeedSkeletons(4) : '<p class="feed-loading">' + t('loading') + '</p>');
var loadMoreBtn = document.getElementById('load-more-category'); if(loadMoreBtn) loadMoreBtn.style.display = 'block';
return BizForum.data.getCategory(categoryId).then(function(cat){
categoryFeedTitleEl.textContent = cat ? cat.name : t('category');
if(cat) setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: cat.name, href: '' }]);
return BizForum.data.getPosts({ categoryId: categoryId, sort: sort, limit: PAGE_SIZE, offset: off }).then(function(list){
list = list.filter(function(p){ return p.categoryId === categoryId; });
var next = function(){ var map = {}; if(cat) map[cat.id] = cat; if(append && listCatEl.children.length){ list.forEach(function(p){ listCatEl.insertAdjacentHTML('beforeend', renderPostCard(p, map[p.categoryId] || null)); }); bindCardReactionDelegation(listCatEl); bindFavDelegation(listCatEl); bindShareDelegation(listCatEl); bindDeletePostDelegation(listCatEl); } else renderFeed(list, listCatEl, map); updateSidebarTrends(list, map); categoryOffset = off + list.length; var loadMoreCatBtn = document.getElementById('load-more-category'); if(loadMoreCatBtn) loadMoreCatBtn.style.display = list.length < PAGE_SIZE ? 'none' : 'block'; };
if(window.BizForum.data.getFavorites && typeof window.BizForum.data.getFavorites().then === 'function'){ return window.BizForum.data.getFavorites().then(function(favIds){ list.forEach(function(p){ p._isFavorite = favIds && favIds.indexOf(p.id) >= 0; }); return next(); }); }
list.forEach(function(p){ p._isFavorite = BizForum.data.isFavorite ? BizForum.data.isFavorite(p.id) : false; }); return next();
});
});
}
function loadPost(postId){
showView('post');
if(postFullEl) postFullEl.innerHTML = '<p class="feed-loading">' + t('loading') + '</p>';
if(postReactionsEl) postReactionsEl.innerHTML = '';
BizForum.data.getPost(postId).then(function(p){
if(!p){ currentPostId = null; showView('feed'); loadFeed(getSort()); return; }
currentPostId = postId; currentPostAuthorId = p.authorId || null; currentPostBestAnswerId = p.bestAnswerCommentId || null;
BizForum.data.getCategory(p.categoryId).then(function(cat){ renderPostFull(p, cat); updatePageMeta((p.title || '').slice(0, 60) + (p.title && p.title.length > 60 ? '‚Ä¶' : '') + ' ‚Äî @Bizz', (p.excerpt || p.body || '').slice(0, 160)); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, cat ? { name: cat.name, href: '#/category/' + cat.id } : null, { name: p.title.slice(0,40) + (p.title.length > 40 ? '‚Ä¶' : ''), href: '' }].filter(Boolean)); if(BizForum.data.incrementView) BizForum.data.incrementView(postId).then(function(newCount){ var el = document.querySelector('.post-full-views'); if(el) el.textContent = newCount + ' ' + t('views'); }).catch(function(){}); });
var backLink = document.getElementById('back-link'); if(backLink){ var backLabel = t('backToFeed'); if(fromRoute.indexOf('#/category/') === 0) backLabel = t('backToCategory'); else if(fromRoute === '#/favorites') backLabel = t('backToFavorites'); else if(fromRoute.indexOf('#/search') === 0) backLabel = t('backToSearch'); backLink.textContent = '‚Üê ' + backLabel; backLink.href = fromRoute; backLink.onclick = function(e){ e.preventDefault(); window.__bizforum_restoreScroll = lastScrollY; window.location.hash = fromRoute; }; }
var favBtn = document.getElementById('fav-btn'); if(favBtn){ var starSvg = '<svg class="fav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"/></svg>'; function setFavBtn(isFav){ favBtn.className = 'fav-btn' + (isFav ? ' fav-active' : ''); var icon = favBtn.querySelector('.fav-icon'); if(icon) icon.setAttribute('fill', isFav ? 'currentColor' : 'none'); } favBtn.innerHTML = starSvg; favBtn.title = t('favTitle'); var favP = BizForum.data.isFavorite(postId); if(favP && typeof favP.then === 'function') favP.then(setFavBtn); else setFavBtn(BizForum.data.isFavorite(postId)); favBtn.onclick = function(){ var p = BizForum.data.toggleFavorite(postId); if(p && typeof p.then === 'function') p.then(function(favIds){ setFavBtn(favIds && favIds.indexOf(postId) >= 0); }); else setFavBtn(BizForum.data.isFavorite(postId)); }; }
(window.BizForum && window.BizForum.auth ? window.BizForum.auth.getUser() : Promise.resolve({ data: null })).then(function(r){ var uid = r.data && r.data.user && r.data.user.id; currentUserIsPostAuthor = (uid === p.authorId); var bar = document.getElementById('post-admin-bar'); var aep = document.getElementById('admin-edit-post-btn'); var adp = document.getElementById('admin-delete-post-btn'); if(bar) bar.classList.toggle('hidden', !adminModeOn && !currentUserIsPostAuthor); if(aep){ aep.style.display = (adminModeOn || currentUserIsPostAuthor) ? '' : 'none'; aep.onclick = function(){ window.location.hash = '#/edit/' + postId; }; } if(adp) adp.onclick = function(){ if(!confirm(t('confirmDeletePost'))) return; var fn = (adminModeOn && window.BizForum.adminDeletePost) ? window.BizForum.adminDeletePost : (currentUserIsPostAuthor && window.BizForum.deletePost) ? window.BizForum.deletePost : null; if(!fn) return; fn(postId).then(function(){ window.location.hash = '#/'; }).catch(function(err){ alert((err && err.message) || t('error')); }); }; var pubBtn = document.getElementById('publish-draft-post-btn'); if(pubBtn){ pubBtn.style.display = (p.status === 'draft' && currentUserIsPostAuthor && BizForum.data.publishPost) ? '' : 'none'; pubBtn.onclick = function(){ if(!BizForum.data.publishPost) return; this.disabled = true; BizForum.data.publishPost(postId).then(function(){ loadPost(postId); }).catch(function(err){ pubBtn.disabled = false; var msg = (err && err.message) || t('error'); if(msg.indexOf('moderation:') === 0){ msg = '–ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø–æ—Å—Ç: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–ª–æ–≤–∞ ‚Äî ' + (msg.split(':').slice(1).join(':') || '').replace(/,/g, ', '); } alert(msg); }); }; } loadAndRenderComments(function(comments){ updatePostStatsCommentCount(comments.length); }); });
var commentFormWrap = document.getElementById('comment-form'); var commentVerifiedHint = document.getElementById('comment-verified-hint');
if(window.BIZFORUM_CONFIG && window.BIZFORUM_CONFIG.useSupabase && window.BizForum && window.BizForum.isVerified){ var formEl = commentFormWrap; var hintEl = commentVerifiedHint; window.BizForum.isVerified().then(function(verified){ if(formEl) formEl.style.display = verified ? '' : 'none'; if(hintEl) hintEl.classList.toggle('hidden', !!verified); }); } else { if(commentFormWrap) commentFormWrap.style.display = ''; if(commentVerifiedHint) commentVerifiedHint.classList.add('hidden'); }
var modeEl = document.getElementById('comment-mode-hint'); if(modeEl) modeEl.textContent = '';
var shareBtn = document.getElementById('post-share-btn'); if(shareBtn) shareBtn.onclick = function(){ doSharePost(postId); };
var commentBodyEl = document.getElementById('comment-body'); if(commentBodyEl){ try { var draft = localStorage.getItem('bizforum_comment_draft_' + postId); if(draft) commentBodyEl.value = draft; } catch(e){} var saveDraftTm; commentBodyEl.addEventListener('input', function(){ clearTimeout(saveDraftTm); saveDraftTm = setTimeout(function(){ try { localStorage.setItem('bizforum_comment_draft_' + postId, commentBodyEl.value || ''); } catch(e){} }, 500); }); }
showView('post');
});
}
function updatePageMeta(title, description){ var t = title || '@Bizz'; document.title = t; var meta = document.querySelector('meta[name="description"]'); if(!meta){ meta = document.createElement('meta'); meta.name = 'description'; document.head.appendChild(meta); } meta.content = description || '–§–æ—Ä—É–º –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π ‚Äî –æ–±—Å—É–∂–¥–µ–Ω–∏—è, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞.'; }
function setBreadcrumbs(items){
if(!breadcrumbsEl) return;
var filtered = items.filter(Boolean);
breadcrumbsEl.innerHTML = filtered.length ? filtered.map(function(it){ return it.href ? '<a href="' + it.href + '">' + escapeHtml(it.name) + '</a>' : '<span>' + escapeHtml(it.name) + '</span>'; }).join(' ‚Üí ') : '';
}
function updatePostStatsCommentCount(count){
var s = document.getElementById('post-full-stats'); if(s) s.textContent = (count || 0) + ' ' + t('commentsCount');
}
function loadCategoriesPage(){
showView('categories'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('breadcrumbCategories'), href: '' }]);
BizForum.data.getCategories().then(function(cats){
function done(trendIds){ renderCategoriesPage(cats, trendIds || []); }
if(BizForum.data.getPosts){ BizForum.data.getPosts({ limit: 200, sort: 'new' }).then(function(list){ var byCat = {}; (list || []).forEach(function(p){ var id = p.categoryId; if(id){ byCat[id] = (byCat[id] || 0) + 1; } }); var ids = Object.keys(byCat).sort(function(a,b){ return byCat[b] - byCat[a]; }).slice(0, 5); done(ids); }).catch(function(){ done([]); }); } else { done([]); }
});
}
function loadAdminDashboardView(){ if(!window.BizForum || !window.BizForum.isAdmin){ showView('feed'); loadFeed(getSort()); return; } window.BizForum.isAdmin().then(function(ok){ if(!ok){ showView('feed'); loadFeed(getSort()); return; } showView('adminDashboard'); if(views.admin) views.admin.classList.add('hidden'); if(views.adminVerification) views.adminVerification.classList.add('hidden'); if(views.adminReports) views.adminReports.classList.add('hidden'); if(views.adminContent) views.adminContent.classList.add('hidden'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('adminPanelTitle'), href: '' }]); if(typeof updateAdminReportsBadge === 'function') updateAdminReportsBadge(); var statsBar = document.getElementById('admin-stats-bar'); var activityEl = document.getElementById('admin-recent-activity'); var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; if(window.BizForum.getAdminStats && statsBar){ window.BizForum.getAdminStats().then(function(s){ s = s || {}; statsBar.innerHTML = '<div class="admin-stat-item"><span class="admin-stat-value">' + (s.users || 0) + '</span><span class="admin-stat-label">' + (t('adminStatsUsers') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π') + '</span></div><div class="admin-stat-item"><span class="admin-stat-value">' + (s.posts || 0) + '</span><span class="admin-stat-label">' + (t('adminStatsPosts') || '–ü–æ—Å—Ç–æ–≤') + '</span></div><div class="admin-stat-item"><span class="admin-stat-value">' + (s.comments || 0) + '</span><span class="admin-stat-label">' + (t('adminStatsComments') || '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤') + '</span></div><div class="admin-stat-item"><span class="admin-stat-value">' + (s.unverified || 0) + '</span><span class="admin-stat-label">' + (t('adminStatsUnverified') || '–ù–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏') + '</span></div><div class="admin-stat-item"><span class="admin-stat-value">' + (s.newToday || 0) + '</span><span class="admin-stat-label">' + (t('adminStatsNewToday') || '–ù–æ–≤—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è') + '</span></div><div class="admin-stat-item"><span class="admin-stat-value">' + (s.adminThreads || 0) + '</span><span class="admin-stat-label">' + (t('adminStatsAdminChats') || '–û–±—Ä–∞—â–µ–Ω–∏–π –≤ –∞–¥–º–∏–Ω') + '</span></div>'; }).catch(function(){ statsBar.innerHTML = ''; }); } if(window.BizForum.getAdminRecentActivity && activityEl){ window.BizForum.getAdminRecentActivity().then(function(a){ a = a || {}; var users = a.users || []; var posts = a.posts || []; var usersHtml = users.length ? users.map(function(u){ var d = u.createdAt ? new Date(u.createdAt).toLocaleDateString(loc) : ''; return '<div class="admin-recent-item"><a href="#/user/' + escapeHtml(u.id) + '">' + escapeHtml(u.name || '‚Äî') + '</a><br><span class="muted">' + escapeHtml(d) + (u.verified ? '' : ' ‚Ä¢ ' + (t('profilePending') || '–æ–∂–∏–¥–∞–µ—Ç')) + '</span></div>'; }).join('') : '<p class="muted">' + (t('loading') || '') + '</p>'; var postsHtml = posts.length ? posts.map(function(p){ var d = p.createdAt ? new Date(p.createdAt).toLocaleDateString(loc) : ''; return '<div class="admin-recent-item"><a href="#/post/' + escapeHtml(p.id) + '">' + escapeHtml((p.title || '').slice(0, 50) + (p.title && p.title.length > 50 ? '‚Ä¶' : '')) + '</a><br><span class="muted">' + escapeHtml(p.authorName || '‚Äî') + ' ¬∑ ' + escapeHtml(d) + '</span></div>'; }).join('') : '<p class="muted">' + (t('loading') || '') + '</p>'; activityEl.innerHTML = '<div class="admin-recent-block"><h3>' + (t('adminRecentUsers') || '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏') + '</h3><div class="admin-recent-list">' + usersHtml + '</div></div><div class="admin-recent-block"><h3>' + (t('adminRecentPosts') || '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã') + '</h3><div class="admin-recent-list">' + postsHtml + '</div></div>'; }).catch(function(){ activityEl.innerHTML = ''; }); } }); }
function loadAdminRegistryView(){
if(!window.BizForum || !window.BizForum.isAdmin || !window.BizForum.adminListProfiles){ showView('feed'); loadFeed(getSort()); return; }
window.BizForum.isAdmin().then(function(ok){ if(!ok){ showView('feed'); loadFeed(getSort()); return; } showView('admin'); if(views.adminDashboard) views.adminDashboard.classList.add('hidden'); if(views.adminVerification) views.adminVerification.classList.add('hidden'); if(views.adminReports) views.adminReports.classList.add('hidden'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('breadcrumbRegistry'), href: '' }]); document.querySelectorAll('.admin-tab-link').forEach(function(lnk){ lnk.classList.toggle('active', (lnk.getAttribute('href') || '').indexOf('/registry') >= 0); }); window.BizForum.adminListProfiles().then(function(profiles){ var listEl = document.getElementById('admin-list'); if(!listEl) return; var nameStr = function(pr){ return ((pr.first_name || '') + ' ' + (pr.last_name || '')).trim(); }; listEl.innerHTML = profiles.length ? profiles.map(function(pr){ return '<div class="admin-list-item"><span>' + escapeHtml(nameStr(pr)) + '</span> <span class="muted">' + escapeHtml(pr.company || '') + '</span> <button type="button" class="admin-edit-btn" data-id="' + pr.id + '">' + t('adminEditBtn') + '</button></div>'; }).join('') : '<p>' + t('adminNoAccounts') + '</p>'; listEl.querySelectorAll('.admin-edit-btn').forEach(function(b){ b.addEventListener('click', function(){ var id = this.getAttribute('data-id'); var p = profiles.find(function(x){ return x.id === id; }); if(!p) return; document.getElementById('admin-edit-id').value = p.id; document.getElementById('admin-edit-first').value = p.first_name || ''; document.getElementById('admin-edit-last').value = p.last_name || ''; document.getElementById('admin-edit-company').value = p.company || ''; var acs = document.getElementById('admin-edit-company-stage'); if(acs) acs.value = p.company_stage || ''; document.getElementById('admin-edit-verified').checked = !!p.verified; var balEl = document.getElementById('admin-edit-balance'); if(balEl) balEl.value = (p.balance != null) ? p.balance : '0'; var subEl = document.getElementById('admin-edit-subscription-ends'); if(subEl && p.subscription_ends_at){ var d = new Date(p.subscription_ends_at); subEl.value = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + 'T' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0'); } else if(subEl) subEl.value = ''; document.getElementById('admin-edit').classList.remove('hidden'); }); }); var editForm = document.getElementById('admin-edit-form'); if(editForm) editForm.onsubmit = function(e){ e.preventDefault(); var id = document.getElementById('admin-edit-id').value; if(!id || !window.BizForum.adminUpdateProfile) return; var acs = document.getElementById('admin-edit-company-stage'); var balEl = document.getElementById('admin-edit-balance'); var subEl = document.getElementById('admin-edit-subscription-ends'); var bal = balEl && balEl.value !== '' ? parseInt(balEl.value, 10) : null; if(bal !== null && isNaN(bal)) bal = null; var subEnds = subEl && subEl.value ? new Date(subEl.value).toISOString() : null; window.BizForum.adminUpdateProfile(id, { first_name: document.getElementById('admin-edit-first').value.trim(), last_name: document.getElementById('admin-edit-last').value.trim(), company: document.getElementById('admin-edit-company').value.trim(), verified: document.getElementById('admin-edit-verified').checked, company_stage: acs ? acs.value : null, balance: bal, subscription_ends_at: subEnds }).then(function(){ document.getElementById('admin-edit').classList.add('hidden'); loadAdminRegistryView(); }); }; var addBalBtn = document.getElementById('admin-add-balance-btn'); var addBalInput = document.getElementById('admin-add-balance-amount'); if(addBalBtn && addBalInput && window.BizForum.adminAddBalance){ addBalBtn.onclick = function(){ var id = document.getElementById('admin-edit-id').value; var amt = parseInt(addBalInput.value, 10); if(!id || !amt || amt <= 0){ alert(t('error') || '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É'); return; } addBalBtn.disabled = true; window.BizForum.adminAddBalance(id, amt).then(function(){ addBalInput.value = ''; var balEl = document.getElementById('admin-edit-balance'); if(balEl){ var cur = parseInt(balEl.value, 10) || 0; balEl.value = cur + amt; } addBalBtn.disabled = false; loadAdminRegistryView(); }).catch(function(err){ addBalBtn.disabled = false; alert((err && err.message) || t('error')); }); }; } }); });
}
function loadUserProfileView(userId){
if(!userId){ showView('feed'); loadFeed(getSort()); return; }
showView('userProfile'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('pageProfile'), href: '' }]);
var headerEl = document.getElementById('user-profile-header'); var statsEl = document.getElementById('user-profile-stats'); var actionsEl = document.getElementById('user-profile-actions'); var listEl = document.getElementById('user-profile-posts-list');
if(headerEl) headerEl.innerHTML = '<p class="muted">' + t('loading') + '</p>'; if(statsEl) statsEl.innerHTML = ''; if(actionsEl) actionsEl.innerHTML = ''; if(listEl) listEl.innerHTML = '<p class="muted">' + t('loading') + '</p>';
var currentUid = window.__bizforum_user_id || null;
function renderHeader(profile){ var name = (profile && ((profile.first_name || '') + ' ' + (profile.last_name || '')).trim()) ? ((profile.first_name || '') + ' ' + (profile.last_name || '')).trim() : '‚Äî'; var company = (profile && profile.company) || ''; var avatar = (profile && profile.avatar_url) ? '<img src="' + escapeHtml(profile.avatar_url) + '" alt="" class="user-profile-avatar" onerror="this.style.display=\'none\'">' : '<span class="user-profile-avatar-placeholder">' + escapeHtml((name.charAt(0) || '?').toUpperCase()) + '</span>'; headerEl.innerHTML = '<div class="user-profile-header-inner">' + avatar + '<div class="user-profile-info"><h1 class="user-profile-name">' + escapeHtml(name) + '</h1><p class="user-profile-company">' + escapeHtml(company) + '</p></div></div>'; }
function renderStats(stats, badges){ var s = stats || {}; var posts = (s.postsCount != null) ? s.postsCount : 0; var views = (s.totalViews != null) ? s.totalViews : 0; var reactions = (s.reactionsReceived != null) ? s.reactionsReceived : 0; var helpful = (s.helpfulCount != null) ? s.helpfulCount : 0; var subs = (s.subscribersCount != null) ? s.subscribersCount : 0; var fmt = typeof formatStatNumber === 'function' ? formatStatNumber : function(n){ return n != null ? String(n) : '0'; }; var html = '<div class="user-profile-stat"><span class="user-profile-stat-value">' + fmt(posts) + '</span><span class="user-profile-stat-label">' + t('profilePostsCount') + '</span></div><div class="user-profile-stat"><span class="user-profile-stat-value">' + fmt(helpful) + '</span><span class="user-profile-stat-label">' + t('profileHelpfulCount') + '</span></div><div class="user-profile-stat"><span class="user-profile-stat-value">' + fmt(views) + '</span><span class="user-profile-stat-label">' + t('profileTotalViews') + '</span></div><div class="user-profile-stat"><span class="user-profile-stat-value">' + fmt(reactions) + '</span><span class="user-profile-stat-label">' + t('profileReactionsReceived') + '</span></div><div class="user-profile-stat"><span class="user-profile-stat-value">' + fmt(subs) + '</span><span class="user-profile-stat-label">' + t('profileSubscribers') + '</span></div>'; if(badges && badges.length) html += '<div class="user-profile-badges"><span class="user-profile-badges-label">' + t('profileBadges') + '</span>' + badges.map(function(b){ return '<span class="profile-badge" title="' + escapeHtml(b.description_ru || '') + '">' + escapeHtml(b.name_ru || b.badge_id) + '</span>'; }).join('') + '</div>'; statsEl.innerHTML = html; }
function renderActions(profile, isSelf, friendStatus, isSubscribed){ if(!actionsEl) return; if(isSelf){ actionsEl.innerHTML = ''; return; } var isFriend = friendStatus && friendStatus.isFriend; var sent = friendStatus && friendStatus.sent; var isSub = !!isSubscribed; var html = ''; if(isFriend){ html = '<span class="user-profile-friend-status">' + t('friendsAlready') + '</span>'; if(window.BizForum.friendsRemove) html += ' <button type="button" class="btn-outline user-profile-action-btn friends-remove-btn" data-id="' + escapeHtml(userId) + '">' + t('friendsRemove') + '</button>'; } else if(sent){ html = '<button type="button" class="btn-outline user-profile-action-btn sent" disabled>' + t('friendsSent') + '</button>'; } else if(window.BizForum.friendsSendRequest){ html = '<button type="button" class="btn-outline user-profile-action-btn friends-add-btn" data-id="' + escapeHtml(userId) + '">' + t('friendsAdd') + '</button>'; } if(window.BizForum.subscribeToAuthor) html += ' <button type="button" class="btn-outline user-profile-action-btn friends-subscribe-btn' + (isSub ? ' subscribed' : '') + '" data-id="' + escapeHtml(userId) + '">' + (isSub ? t('friendsSubscribed') : t('friendsSubscribe')) + '</button>'; actionsEl.innerHTML = html; actionsEl.querySelectorAll('.friends-add-btn').forEach(function(btn){ btn.onclick = function(){ var id = btn.getAttribute('data-id'); if(!id || !window.BizForum.friendsSendRequest) return; (window.BizForum.isVerified ? window.BizForum.isVerified() : Promise.resolve(true)).then(function(verified){ if(!verified){ alert(t('friendsVerifiedOnly')); return; } window.BizForum.friendsSendRequest(id).then(function(){ loadUserProfileView(userId); }).catch(function(err){ alert(err.message || t('error')); }); }); }; }); actionsEl.querySelectorAll('.friends-remove-btn').forEach(function(btn){ btn.onclick = function(){ var id = btn.getAttribute('data-id'); if(!id || !window.BizForum.friendsRemove) return; if(!confirm(t('friendsRemoveConfirm'))) return; window.BizForum.friendsRemove(id).then(function(){ loadUserProfileView(userId); }).catch(function(err){ alert(err.message || t('error')); }); }; }); actionsEl.querySelectorAll('.friends-subscribe-btn').forEach(function(btn){ btn.onclick = function(){ var id = btn.getAttribute('data-id'); if(!id) return; var self = this; if(self.classList.contains('subscribed') && window.BizForum.unsubscribeFromAuthor){ window.BizForum.unsubscribeFromAuthor(id).then(function(){ loadUserProfileView(userId); }).catch(function(){}); } else if(window.BizForum.subscribeToAuthor){ window.BizForum.subscribeToAuthor(id).then(function(){ loadUserProfileView(userId); }).catch(function(){}); } }; }); }
var profilePromise = (window.BizForum.friendsGetProfilesByIds) ? window.BizForum.friendsGetProfilesByIds([userId]).then(function(arr){ return arr && arr[0] ? arr[0] : null; }).catch(function(){ return null; }) : Promise.resolve(null);
var statsPromise = (window.BizForum.getProfileStats) ? window.BizForum.getProfileStats(userId).then(function(s){ return s; }).catch(function(){ return {}; }) : Promise.resolve({});
var friendStatusPromise = (window.BizForum.friendsListAccepted && window.BizForum.friendsListSent) ? Promise.all([window.BizForum.friendsListAccepted(), window.BizForum.friendsListSent()]).then(function(arr){ var accepted = arr[0] || []; var sent = arr[1] || []; return { isFriend: accepted.indexOf(userId) >= 0, sent: sent.indexOf(userId) >= 0 }; }).catch(function(){ return { isFriend: false, sent: false }; }) : Promise.resolve({ isFriend: false, sent: false });
var subscribedPromise = (window.BizForum.getSubscribedAuthorIds) ? window.BizForum.getSubscribedAuthorIds().then(function(ids){ return ids && ids.indexOf(userId) >= 0; }).catch(function(){ return false; }) : Promise.resolve(false);
var badgesPromise = (window.BizForum.getUserBadges) ? window.BizForum.getUserBadges(userId).catch(function(){ return []; }) : Promise.resolve([]);
Promise.all([profilePromise, statsPromise, friendStatusPromise, subscribedPromise, badgesPromise]).then(function(res){ var profile = res[0]; var stats = res[1]; var friendStatus = res[2]; var isSubscribed = res[3]; var badges = res[4] || []; renderHeader(profile); renderStats(stats, badges); renderActions(profile, currentUid === userId, friendStatus, isSubscribed); });
var postsPromise = (BizForum.data.getPosts) ? BizForum.data.getPosts({ authorId: userId, limit: 50, sort: 'new' }) : Promise.resolve([]);
postsPromise.then(function(list){ BizForum.data.getCategories().then(function(cats){ var map = {}; (cats || []).forEach(function(c){ map[c.id] = c; }); if(!list || list.length === 0){ listEl.innerHTML = '<div class="empty-state"><p>' + escapeHtml(t('emptyStateFeed')) + '</p></div>'; return; } if(window.BizForum.data.getFavorites && typeof window.BizForum.data.getFavorites().then === 'function'){ window.BizForum.data.getFavorites().then(function(favIds){ list.forEach(function(p){ p._isFavorite = favIds && favIds.indexOf(p.id) >= 0; }); renderFeed(list, listEl, map); }).catch(function(){ list.forEach(function(p){ p._isFavorite = BizForum.data.isFavorite ? BizForum.data.isFavorite(p.id) : false; }); renderFeed(list, listEl, map); }); } else { list.forEach(function(p){ p._isFavorite = BizForum.data.isFavorite ? BizForum.data.isFavorite(p.id) : false; }); renderFeed(list, listEl, map); } }).catch(function(){ if(!list || list.length === 0) listEl.innerHTML = '<div class="empty-state"><p>' + escapeHtml(t('emptyStateFeed')) + '</p></div>'; else { list.forEach(function(p){ p._isFavorite = BizForum.data.isFavorite ? BizForum.data.isFavorite(p.id) : false; }); renderFeed(list, listEl, {}); } }); }).catch(function(){ listEl.innerHTML = '<div class="empty-state"><p>' + escapeHtml(t('emptyStateFeed')) + '</p></div>'; });
closeSidebar();
}
function loadFriendsView(){
if(!window.BizForum || !window.BizForum.auth){ showView('feed'); loadFeed(getSort()); return; }
window.BizForum.auth.getUser().then(function(r){ if(!r.data || !r.data.user){ window.location.hash = '#/'; return; } showView('friends'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('pageFriends'), href: '' }]); var resultsEl = document.getElementById('friends-results'); var incomingEl = document.getElementById('friends-incoming-list'); var loadMoreBtn = document.getElementById('friends-load-more-btn'); var resultsTitleEl = document.getElementById('friends-results-title'); var friendsListOffset = 0; var isSearchMode = false; function renderPersonCard(p, sentIds, acceptedIds, subscribedIds){ var name = ((p.first_name || '') + ' ' + (p.last_name || '')).trim() || '‚Äî'; var company = p.company || ''; var postsCount = (p.posts_count != null) ? p.posts_count : 0; var totalViews = (p.total_views != null) ? p.total_views : 0; var sent = sentIds && sentIds.indexOf(p.id) >= 0; var isFriend = acceptedIds && acceptedIds.indexOf(p.id) >= 0; var isSub = subscribedIds && subscribedIds.indexOf(p.id) >= 0; var subBtn = (window.BizForum.subscribeToAuthor) ? '<button type="button" class="friends-subscribe-btn btn-outline' + (isSub ? ' subscribed' : '') + '" data-id="' + p.id + '">' + (isSub ? (t('friendsSubscribed') || '–ü–æ–¥–ø–∏—Å–∞–Ω–æ') : t('friendsSubscribe')) + '</button>' : ''; var addBtn = isFriend ? '<span class="friends-status-label">' + t('friendsAlready') + '</span><button type="button" class="friends-remove-btn btn-outline" data-id="' + p.id + '">' + t('friendsRemove') + '</button>' : (sent ? '<button type="button" class="friends-add-btn sent" data-id="' + p.id + '" disabled>' + t('friendsSent') + '</button>' : '<button type="button" class="friends-add-btn" data-id="' + p.id + '">' + t('friendsAdd') + '</button>'); var favAvatar = avatarHtml((p.avatar_url || ''), name); return '<div class="friends-result-card" data-id="' + p.id + '"><div class="friends-card-main">' + favAvatar + '<div class="friends-card-info"><a href="#/user/' + escapeHtml(p.id) + '" class="friends-card-name">' + escapeHtml(name) + '</a><span class="friends-card-company">' + escapeHtml(company) + '</span><span class="friends-card-stats">' + postsCount + ' ' + t('friendsPostsCount') + ', ' + totalViews + ' ' + t('friendsViewsCount') + '</span></div></div><div class="friends-card-actions">' + addBtn + ' ' + subBtn + '</div></div>'; } function bindResultCards(container, sentIds, acceptedIds){ if(!container) return; container.querySelectorAll('.friends-add-btn:not(.sent)').forEach(function(btn){ btn.onclick = function(){ var id = btn.getAttribute('data-id'); if(!id || !window.BizForum.friendsSendRequest) return; (window.BizForum.isVerified ? window.BizForum.isVerified() : Promise.resolve(true)).then(function(verified){ if(!verified){ alert(t('friendsVerifiedOnly')); return; } window.BizForum.friendsSendRequest(id).then(function(){ btn.classList.add('sent'); btn.textContent = t('friendsSent'); btn.disabled = true; }).catch(function(err){ alert(err.message || t('error')); }); }); }; }); container.querySelectorAll('.friends-subscribe-btn').forEach(function(btn){ btn.onclick = function(){ var id = btn.getAttribute('data-id'); if(!id) return; var self = this; if(self.classList.contains('subscribed') && window.BizForum.unsubscribeFromAuthor){ window.BizForum.unsubscribeFromAuthor(id).then(function(){ self.classList.remove('subscribed'); self.textContent = t('friendsSubscribe'); }).catch(function(){}); } else if(window.BizForum.subscribeToAuthor){ window.BizForum.subscribeToAuthor(id).then(function(){ self.classList.add('subscribed'); self.textContent = t('friendsSubscribed') || '–ü–æ–¥–ø–∏—Å–∞–Ω–æ'; }).catch(function(){}); } }; }); container.querySelectorAll('.friends-remove-btn').forEach(function(btn){ btn.onclick = function(){ var id = btn.getAttribute('data-id'); if(!id || !window.BizForum.friendsRemove) return; if(!confirm(t('friendsRemoveConfirm'))) return; var card = btn.closest('.friends-result-card'); window.BizForum.friendsRemove(id).then(function(){ if(card) card.remove(); }).catch(function(err){ alert(err.message || t('error')); }); }; }); } function loadDirectory(offset, append){ isSearchMode = false; if(loadMoreBtn) loadMoreBtn.style.display = 'none'; if(resultsTitleEl){ resultsTitleEl.textContent = t('friendsDirectory'); resultsTitleEl.classList.remove('hidden'); } var listFn = window.BizForum.friendsListProfiles ? window.BizForum.friendsListProfiles(30, offset) : (offset === 0 && window.BizForum.friendsSearchProfiles ? window.BizForum.friendsSearchProfiles('') : Promise.resolve([])); if(!append && resultsEl) resultsEl.innerHTML = '<p class="muted">' + t('loading') + '</p>'; Promise.all([listFn, window.BizForum.friendsListSent ? window.BizForum.friendsListSent() : Promise.resolve([]), window.BizForum.friendsListAccepted ? window.BizForum.friendsListAccepted() : Promise.resolve([]), window.BizForum.getSubscribedAuthorIds ? window.BizForum.getSubscribedAuthorIds() : Promise.resolve([])]).then(function(arr){ var list = arr[0] || []; var sentIds = arr[1] || []; var acceptedIds = arr[2] || []; var subscribedIds = arr[3] || []; if(!list.length && !append){ resultsEl.innerHTML = '<p class="muted">' + t('friendsNoResults') + '</p>'; return; } var html = list.map(function(p){ return renderPersonCard(p, sentIds, acceptedIds, subscribedIds); }).join(''); if(append && resultsEl) resultsEl.insertAdjacentHTML('beforeend', html); else if(resultsEl) resultsEl.innerHTML = html; bindResultCards(resultsEl, sentIds, acceptedIds); if(loadMoreBtn && window.BizForum.friendsListProfiles && list.length >= 30) loadMoreBtn.style.display = 'block'; }); } function doSearch(){ var q = (document.getElementById('friends-search-input') && document.getElementById('friends-search-input').value) ? document.getElementById('friends-search-input').value.trim() : ''; if(!q){ friendsListOffset = 0; loadDirectory(0, false); return; } isSearchMode = true; if(loadMoreBtn) loadMoreBtn.style.display = 'none'; if(resultsTitleEl) resultsTitleEl.classList.add('hidden'); if(!window.BizForum.friendsSearchProfiles){ if(resultsEl) resultsEl.innerHTML = '<p class="muted">' + t('friendsSearchHint') + '</p>'; return; } if(resultsEl) resultsEl.innerHTML = '<p class="muted">' + t('loading') + '</p>'; Promise.all([window.BizForum.friendsSearchProfiles(q), window.BizForum.friendsListSent ? window.BizForum.friendsListSent() : Promise.resolve([]), window.BizForum.friendsListAccepted ? window.BizForum.friendsListAccepted() : Promise.resolve([]), window.BizForum.getSubscribedAuthorIds ? window.BizForum.getSubscribedAuthorIds() : Promise.resolve([])]).then(function(arr){ var list = arr[0] || []; var sentIds = arr[1] || []; var acceptedIds = arr[2] || []; var subscribedIds = arr[3] || []; if(!list.length){ resultsEl.innerHTML = '<p class="muted">' + t('friendsNoResults') + '</p>'; return; } resultsEl.innerHTML = list.map(function(p){ return renderPersonCard(p, sentIds, acceptedIds, subscribedIds); }).join(''); bindResultCards(resultsEl, sentIds, acceptedIds); }); } function renderIncoming(){ if(!window.BizForum.friendsListIncoming || !window.BizForum.friendsGetProfilesByIds) return; window.BizForum.friendsListIncoming().then(function(rows){ if(!rows.length){ if(incomingEl) incomingEl.innerHTML = '<p class="muted">' + t('friendsIncomingNone') + '</p>'; return; } var ids = rows.map(function(x){ return x.from_user_id; }); var profilesPromise = window.BizForum.friendsGetProfilesByIds(ids); var statsPromise = window.BizForum.getProfileStats && ids.length ? Promise.all(ids.map(function(id){ return window.BizForum.getProfileStats(id).then(function(s){ return { id: id, stats: s }; }).catch(function(){ return { id: id, stats: {} }; }); })) : Promise.resolve([]); Promise.all([profilesPromise, statsPromise]).then(function(res){ var profiles = res[0] || []; var statsList = res[1] || []; var profileMap = {}; profiles.forEach(function(p){ profileMap[p.id] = p; }); var statsMap = {}; statsList.forEach(function(x){ statsMap[x.id] = x.stats || {}; }); incomingEl.innerHTML = rows.map(function(row){ var p = profileMap[row.from_user_id]; var name = p ? ((p.first_name || '') + ' ' + (p.last_name || '')).trim() || '‚Äî' : '‚Äî'; var company = (p && p.company) || ''; var s = statsMap[row.from_user_id] || {}; var postsCount = (s.postsCount != null) ? s.postsCount : 0; var totalViews = (s.totalViews != null) ? s.totalViews : 0; var reactionsCount = (s.reactionsReceived != null) ? s.reactionsReceived : 0; var incAvatar = avatarHtml((p && p.avatar_url) || '', name); var nameHtml = '<a href="#/user/' + escapeHtml(row.from_user_id) + '" class="friends-incoming-name">' + escapeHtml(name) + '</a>'; var statsLine = postsCount + ' ' + t('friendsPostsCount') + ', ' + totalViews + ' ' + t('friendsViewsCount') + ', ' + reactionsCount + ' ' + t('profileReactionsReceived'); return '<div class="friends-incoming-item" data-from="' + row.from_user_id + '"><div class="friends-incoming-main">' + incAvatar + '<div><span class="friends-incoming-name-wrap">' + nameHtml + '</span><br><span class="company">' + escapeHtml(company) + '</span><br><span class="friends-incoming-stats">' + escapeHtml(statsLine) + '</span></div></div><div><button type="button" class="friends-add-btn accept" data-from="' + row.from_user_id + '">' + t('friendsAccept') + '</button> <button type="button" class="friends-add-btn reject" data-from="' + row.from_user_id + '">' + t('friendsReject') + '</button></div></div>'; }).join(''); incomingEl.querySelectorAll('button.accept').forEach(function(btn){ btn.addEventListener('click', function(){ var id = btn.getAttribute('data-from'); if(!id || !window.BizForum.friendsAccept) return; (window.BizForum.isVerified ? window.BizForum.isVerified() : Promise.resolve(true)).then(function(verified){ if(!verified){ alert(t('friendsVerifiedOnly')); return; } window.BizForum.friendsAccept(id).then(function(){ renderIncoming(); updateFriendsBadge(); }); }); }); }); incomingEl.querySelectorAll('button.reject').forEach(function(btn){ btn.addEventListener('click', function(){ var id = btn.getAttribute('data-from'); if(!id || !window.BizForum.friendsReject) return; window.BizForum.friendsReject(id).then(function(){ renderIncoming(); updateFriendsBadge(); }); }); }); }); }); } loadDirectory(0, false); renderIncoming(); var sb = document.getElementById('friends-search-btn'); if(sb) sb.addEventListener('click', doSearch); var si = document.getElementById('friends-search-input'); if(si) si.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); doSearch(); } }); if(loadMoreBtn) loadMoreBtn.addEventListener('click', function(){ friendsListOffset += 30; loadDirectory(friendsListOffset, true); }); }); }
function updateFriendsBadge(){ if(!window.BizForum.friendsListIncoming) return; window.BizForum.friendsListIncoming().then(function(rows){ var badge = document.getElementById('friends-badge'); if(!badge) return; if(rows.length > 0){ badge.textContent = rows.length > 99 ? '99+' : rows.length; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }); }
function loadGroupsView(){
if(!window.BizForum || !window.BizForum.auth){ showView('feed'); loadFeed(getSort()); return; }
window.BizForum.auth.getUser().then(function(r){ if(!r.data || !r.data.user){ window.location.hash = '#/'; return; }
showView('groups'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('groupsSearchTitle'), href: '' }]);
var resultsEl = document.getElementById('groups-results'); var searchInp = document.getElementById('groups-search-input'); var searchBtn = document.getElementById('groups-search-btn');
function renderGroupCard(g){ var statusLabel = '<span class="group-card-badge group-card-badge-open"><svg class="group-card-globe" xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418"/></svg> ' + (t('groupOpen') || '–û—Ç–∫—Ä—ã—Ç–∞—è') + '</span>'; var catTag = g.categoryName ? '<span class="group-card-category">' + escapeHtml(g.categoryName) + '</span>' : ''; var membersText = (g.membersCount || 0) + ' ' + (t('groupMembers') || '—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'); var joinBtn = g.myRequestStatus === 'pending' ? '<button type="button" class="group-card-join group-card-join-sent" disabled>' + (t('groupRequestSent') || '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞') + '</button>' : '<button type="button" class="group-card-join" data-conversation-id="' + escapeHtml(g.conversationId) + '">' + (t('groupJoin') || '–í—Å—Ç—É–ø–∏—Ç—å') + '</button>'; return '<div class="group-card" data-conversation-id="' + g.conversationId + '"><div class="group-card-top"><span class="group-card-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"/></svg></span>' + statusLabel + '</div><h3 class="group-card-title">' + escapeHtml(g.title) + '</h3><p class="group-card-desc">' + escapeHtml(g.description || '') + '</p>' + (catTag ? '<div class="group-card-meta">' + catTag + '</div>' : '') + '<div class="group-card-bottom"><span class="group-card-members"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z"/></svg> ' + membersText + '</span>' + joinBtn + '</div></div>'; }
function doSearch(){ var q = (searchInp && searchInp.value) ? searchInp.value.trim() : ''; if(!resultsEl) return; resultsEl.innerHTML = '<p class="muted">' + t('loading') + '</p>'; if(!window.BizForum.listOpenGroups){ resultsEl.innerHTML = '<p class="muted">' + t('groupsSearchHint') + '</p>'; return; } window.BizForum.listOpenGroups(q).then(function(list){ if(!list || list.length === 0){ resultsEl.innerHTML = '<p class="muted">' + (t('groupsNoResults') || '–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≥—Ä—É–ø–ø') + '</p>'; return; } resultsEl.innerHTML = list.map(renderGroupCard).join(''); resultsEl.querySelectorAll('.group-card-join:not(.group-card-join-sent)').forEach(function(btn){ var cid = btn.getAttribute('data-conversation-id'); if(!cid || !window.BizForum.requestToJoinGroup) return; btn.addEventListener('click', function(){ btn.disabled = true; window.BizForum.requestToJoinGroup(cid).then(function(){ btn.textContent = t('groupRequestSent') || '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'; btn.classList.add('group-card-join-sent'); if(typeof showToast === 'function') showToast(t('groupRequestSent') || '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', 'success'); }).catch(function(err){ btn.disabled = false; alert((err && err.message) || t('error')); }); }); }); }); }
doSearch(); if(searchBtn) searchBtn.addEventListener('click', doSearch); if(searchInp) searchInp.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); doSearch(); } });
}); }
function loadVerificationView(){
if(!window.BizForum || !window.BizForum.isAdmin || !window.BizForum.adminListProfiles){ showView('feed'); loadFeed(getSort()); return; }
window.BizForum.isAdmin().then(function(ok){ if(!ok){ showView('feed'); loadFeed(getSort()); return; } showView('adminVerification'); if(views.admin) views.admin.classList.add('hidden'); if(views.adminReports) views.adminReports.classList.add('hidden'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('navVerification'), href: '' }]); window.BizForum.adminListProfiles().then(function(profiles){ var unverified = profiles.filter(function(pr){ return !pr.verified; }); var listEl = document.getElementById('admin-verification-list'); if(!listEl) return; var nameStr = function(pr){ return ((pr.first_name || '') + ' ' + (pr.last_name || '')).trim(); }; listEl.innerHTML = unverified.length ? unverified.map(function(pr){ return '<div class="admin-list-item" data-id="' + pr.id + '"><span>' + escapeHtml(nameStr(pr) || '‚Äî') + '</span> <span class="muted">' + escapeHtml(pr.company || '') + '</span> <button type="button" class="admin-verify-btn approve" data-id="' + pr.id + '">' + t('verificationApprove') + '</button> <button type="button" class="admin-verify-btn reject" data-id="' + pr.id + '">' + t('verificationReject') + '</button></div>'; }).join('') : '<p>' + t('verificationNone') + '</p>'; listEl.querySelectorAll('.admin-verify-btn.approve').forEach(function(btn){ btn.addEventListener('click', function(){ var id = this.getAttribute('data-id'); if(!id || !window.BizForum.adminUpdateProfile) return; var btnEl = this; btnEl.disabled = true; window.BizForum.adminUpdateProfile(id, { verified: true }).then(function(){ if(window.BizForum.createNotification) window.BizForum.createNotification(id, 'verification_approved', {}).catch(function(){}); loadVerificationView(); }).catch(function(err){ btnEl.disabled = false; alert((err && err.message) || t('error')); }); }); }); listEl.querySelectorAll('.admin-verify-btn.reject').forEach(function(btn){ btn.addEventListener('click', function(){ var id = this.getAttribute('data-id'); if(!id || !window.BizForum.adminDeleteProfile) return; if(!confirm(t('verificationRejectConfirm'))) return; var btnEl = this; btnEl.disabled = true; window.BizForum.adminDeleteProfile(id).then(function(){ loadVerificationView(); }).catch(function(err){ btnEl.disabled = false; alert((err && err.message) || t('error')); }); }); }); }); });
}
function loadAdminReportsView(){
if(!window.BizForum || !window.BizForum.isAdmin){ showView('feed'); loadFeed(getSort()); return; }
window.BizForum.isAdmin().then(function(ok){ if(!ok){ showView('feed'); loadFeed(getSort()); return; } showView('adminReports'); if(views.admin) views.admin.classList.add('hidden'); if(views.adminVerification) views.adminVerification.classList.add('hidden'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('adminReports'), href: '' }]); var listEl = document.getElementById('admin-reports-list'); var filterBtns = document.querySelectorAll('.admin-reports-filter'); var currentStatus = 'pending'; function loadReports(){ var getFn = (window.BizForum.getReports && typeof window.BizForum.getReports === 'function') ? window.BizForum.getReports(currentStatus) : Promise.resolve([]); getFn.then(function(rows){ if(!listEl) return; if(!rows || rows.length === 0){ listEl.innerHTML = '<p class="muted">' + (t('adminReportsNone') || '–ù–µ—Ç –∂–∞–ª–æ–±') + '</p>'; return; } var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; listEl.innerHTML = rows.map(function(r){ var dateStr = r.created_at ? new Date(r.created_at).toLocaleString(loc) : ''; var targetLabel = (r.target_type === 'post' ? (t('reportTargetPost') || '–ø–æ—Å—Ç') : (t('reportTargetComment') || '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π')) + ' ' + (r.target_id ? String(r.target_id).slice(0,8) : ''); var resolveBtn = r.status === 'pending' && window.BizForum.resolveReport ? ' <button type="button" class="admin-verify-btn" data-id="' + escapeHtml(r.id) + '" data-action="resolve">' + (t('adminReportsResolve') || '–ó–∞–∫—Ä—ã—Ç—å') + '</button>' : ''; var dismissBtn = r.status === 'pending' && window.BizForum.resolveReport ? ' <button type="button" class="admin-verify-btn reject" data-id="' + escapeHtml(r.id) + '" data-action="dismiss">' + (t('adminReportsDismiss') || '–û—Ç–∫–ª–æ–Ω–∏—Ç—å') + '</button>' : ''; return '<div class="admin-list-item admin-report-item" data-id="' + r.id + '"><div><span class="admin-report-target">' + escapeHtml(targetLabel) + '</span><span class="muted"> ‚Äî ' + escapeHtml(r.reason || '-') + '</span><br><span class="admin-report-date">' + escapeHtml(dateStr) + '</span></div>' + resolveBtn + dismissBtn + '</div>'; }).join(''); listEl.querySelectorAll('.admin-verify-btn[data-action="resolve"]').forEach(function(btn){ btn.onclick = function(){ var id = btn.getAttribute('data-id'); if(!id || !window.BizForum.resolveReport) return; window.BizForum.resolveReport(id, 'resolved').then(function(){ loadReports(); if(typeof updateAdminReportsBadge === 'function') updateAdminReportsBadge(); }); }; }); listEl.querySelectorAll('.admin-verify-btn[data-action="dismiss"]').forEach(function(btn){ btn.onclick = function(){ var id = btn.getAttribute('data-id'); if(!id || !window.BizForum.resolveReport) return; window.BizForum.resolveReport(id, 'dismissed').then(function(){ loadReports(); if(typeof updateAdminReportsBadge === 'function') updateAdminReportsBadge(); }); }; }); }).catch(function(){ if(listEl) listEl.innerHTML = '<p class="muted">' + t('error') + '</p>'; }); } filterBtns.forEach(function(btn){ btn.addEventListener('click', function(){ filterBtns.forEach(function(b){ b.classList.remove('active'); }); btn.classList.add('active'); currentStatus = btn.getAttribute('data-status') || 'pending'; loadReports(); }); }); loadReports(); if(typeof updateAdminReportsBadge === 'function') updateAdminReportsBadge(); });
}
function loadAdminContentView(){ if(!window.BizForum || !window.BizForum.isAdmin){ showView('feed'); loadFeed(getSort()); return; } window.BizForum.isAdmin().then(function(ok){ if(!ok){ showView('feed'); loadFeed(getSort()); return; } showView('adminContent'); if(views.admin) views.admin.classList.add('hidden'); if(views.adminDashboard) views.adminDashboard.classList.add('hidden'); if(views.adminVerification) views.adminVerification.classList.add('hidden'); if(views.adminReports) views.adminReports.classList.add('hidden'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('adminContent'), href: '' }]); document.querySelectorAll('.admin-tab-link').forEach(function(lnk){ lnk.classList.toggle('active', (lnk.getAttribute('href') || '').indexOf('/content') >= 0); }); var listEl = document.getElementById('admin-content-list'); if(!listEl) return; listEl.innerHTML = '<p class="muted">' + t('loading') + '</p>'; var postsPromise = BizForum.data && BizForum.data.getPosts ? BizForum.data.getPosts({ limit: 30, sort: 'new' }) : Promise.resolve([]); postsPromise.then(function(list){ var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; if(!list || list.length === 0){ listEl.innerHTML = '<p class="muted">' + (t('emptyStateFeed') || '–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤') + '</p>'; return; } listEl.innerHTML = list.map(function(p){ var d = p.createdAt ? new Date(p.createdAt).toLocaleDateString(loc) : ''; return '<div class="admin-list-item"><a href="#/post/' + escapeHtml(p.id) + '">' + escapeHtml((p.title || '').slice(0, 80) + (p.title && p.title.length > 80 ? '‚Ä¶' : '')) + '</a><span class="muted"> ‚Äî ' + escapeHtml(p.author || '‚Äî') + ' ¬∑ ' + escapeHtml(d) + '</span></div>'; }).join(''); }).catch(function(){ listEl.innerHTML = '<p class="muted">' + t('error') + '</p>'; }); }); }
function updateAdminReportsBadge(){ if(!window.BizForum || !window.BizForum.isAdmin || !window.BizForum.getReportsCount) return; window.BizForum.isAdmin().then(function(ok){ if(!ok) return; window.BizForum.getReportsCount().then(function(n){ var badges = document.querySelectorAll('.admin-reports-badge'); badges.forEach(function(b){ if(n > 0){ b.textContent = n > 99 ? '99+' : n; b.classList.remove('hidden'); } else { b.classList.add('hidden'); } }); var panelBadge = document.getElementById('admin-panel-reports-badge'); if(panelBadge){ if(n > 0){ panelBadge.textContent = n > 99 ? '99+' : n; panelBadge.classList.remove('hidden'); } else panelBadge.classList.add('hidden'); } }); }); }
function loadProfileView(){
if(!window.BizForum || !window.BizForum.auth){ showView('feed'); loadFeed(getSort()); return; }
window.BizForum.auth.getUser().then(function(r){
if(!r.data || !r.data.user){ window.location.hash = '#/'; return; }
showView('profile'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('breadcrumbProfile'), href: '' }]);
function fillProfileStats(){ if(!window.BizForum.getProfileStats) return; var fmt = typeof formatStatNumber === 'function' ? formatStatNumber : function(n){ return n != null ? String(n) : '0'; }; window.BizForum.auth.getUser().then(function(r){ var uid = r.data && r.data.user && r.data.user.id; window.BizForum.getProfileStats().then(function(s){ var el = document.getElementById('profile-stats'); if(!el) return; var helpful = (s.helpfulCount != null) ? s.helpfulCount : 0; var views = (s.totalViews != null) ? s.totalViews : 0; var html = '<div class="profile-stats-title">' + escapeHtml(t('profileStats')) + '</div><div class="profile-stat-card profile-stat-card-icon"><span class="profile-stat-icon" aria-hidden="true">üìù</span><span class="profile-stat-value">' + fmt(s.postsCount || 0) + '</span><span class="profile-stat-label">' + escapeHtml(t('profilePostsCount')) + '</span></div><div class="profile-stat-card profile-stat-card-icon"><span class="profile-stat-icon" aria-hidden="true">üí¨</span><span class="profile-stat-value">' + fmt(s.commentsCount || 0) + '</span><span class="profile-stat-label">' + escapeHtml(t('profileCommentsCount')) + '</span></div><div class="profile-stat-card profile-stat-card-icon"><span class="profile-stat-icon" aria-hidden="true">üëç</span><span class="profile-stat-value">' + fmt(helpful) + '</span><span class="profile-stat-label">' + escapeHtml(t('profileHelpfulCount')) + '</span></div><div class="profile-stat-card profile-stat-card-icon"><span class="profile-stat-icon" aria-hidden="true">‚ù§</span><span class="profile-stat-value">' + fmt(s.reactionsReceived || 0) + '</span><span class="profile-stat-label">' + escapeHtml(t('profileReactionsReceived')) + '</span></div><div class="profile-stat-card profile-stat-card-icon"><span class="profile-stat-icon" aria-hidden="true">üëÅ</span><span class="profile-stat-value">' + fmt(views) + '</span><span class="profile-stat-label">' + escapeHtml(t('profileTotalViews')) + '</span></div>'; if(uid && window.BizForum.getUserBadges){ window.BizForum.getUserBadges(uid).then(function(badges){ if(badges && badges.length) html += '<div class="profile-badges-wrap"><span class="profile-badges-title">' + escapeHtml(t('profileBadges')) + '</span><div class="profile-badges">' + badges.map(function(b){ return '<span class="profile-badge" title="' + escapeHtml(b.description_ru || '') + '">' + escapeHtml(b.name_ru || b.badge_id) + '</span>'; }).join('') + '</div></div>'; el.innerHTML = html; }).catch(function(){ el.innerHTML = html; }); } else { el.innerHTML = html; } }); }).catch(function(){ window.BizForum.getProfileStats().then(function(s){ var el = document.getElementById('profile-stats'); if(!el) return; var fmt2 = typeof formatStatNumber === 'function' ? formatStatNumber : function(n){ return n != null ? String(n) : '0'; }; el.innerHTML = '<div class="profile-stats-title">' + escapeHtml(t('profileStats')) + '</div><div class="profile-stat-card"><span class="profile-stat-value">' + fmt2(s.postsCount || 0) + '</span><span class="profile-stat-label">' + escapeHtml(t('profilePostsCount')) + '</span></div><div class="profile-stat-card"><span class="profile-stat-value">' + fmt2(s.commentsCount || 0) + '</span><span class="profile-stat-label">' + escapeHtml(t('profileCommentsCount')) + '</span></div>'; }); }); }
function fillProfile(p){ var card = document.getElementById('profile-card'); if(!card) return; var fn = (p && p.first_name) || ''; var ln = (p && p.last_name) || ''; var company = (p && p.company) || ''; var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; var dob = (p && p.date_of_birth) ? new Date(p.date_of_birth).toLocaleDateString(loc) : t('dash'); var avatar = (p && p.avatar_url) || ''; card.innerHTML = '<div class="profile-display"><div class="profile-row"><span class="profile-label">' + t('profileFirstName') + '</span><span class="profile-value">' + escapeHtml(fn) + '</span></div><div class="profile-row"><span class="profile-label">' + t('profileLastName') + '</span><span class="profile-value">' + escapeHtml(ln) + '</span></div><div class="profile-row"><span class="profile-label">' + t('profileCompany') + '</span><span class="profile-value">' + escapeHtml(company) + '</span></div><div class="profile-row"><span class="profile-label">' + t('profileVerification') + '</span><span class="profile-value">' + (p && p.verified ? t('profileVerified') : t('profilePending')) + '</span></div><div class="profile-row"><span class="profile-label">' + t('profileDob') + '</span><span class="profile-value">' + dob + '</span></div>' + (avatar ? '<div class="profile-row"><span class="profile-label">' + t('profilePhoto') + '</span><img src="' + escapeHtml(avatar) + '" alt="" class="profile-avatar-preview" onerror="this.style.display=&#39;none&#39;"></div>' : '') + '</div>'; var pf = document.getElementById('profile-first'); var pl = document.getElementById('profile-last'); var pc = document.getElementById('profile-company'); var pa = document.getElementById('profile-avatar'); var pd = document.getElementById('profile-dob'); if(pf) pf.value = fn; if(pl) pl.value = ln; if(pc) pc.value = company; if(pa) pa.value = avatar; if(pd) pd.value = (p && p.date_of_birth) || ''; var pcs = document.getElementById('profile-company-stage'); if(pcs) pcs.value = (p && p.company_stage) || ''; }
if(window.BizForum.getProfile){ window.BizForum.getProfile().then(function(p){ fillProfile(p || null); fillProfileStats(); }).catch(function(){ fillProfile(null); fillProfileStats(); }); } else { fillProfile(null); fillProfileStats(); }
var editForm = document.getElementById('profile-edit-form'); if(editForm) editForm.onsubmit = function(e){ e.preventDefault(); if(!window.BizForum.updateProfile) return; var dobVal = document.getElementById('profile-dob').value.trim(); var avatarVal = document.getElementById('profile-avatar').value.trim(); var csEl = document.getElementById('profile-company-stage'); var csVal = csEl ? csEl.value : ''; window.BizForum.updateProfile({ first_name: document.getElementById('profile-first').value.trim(), last_name: document.getElementById('profile-last').value.trim(), company: document.getElementById('profile-company').value.trim(), avatar_url: avatarVal || null, date_of_birth: dobVal || null, company_stage: csVal || null }).then(function(){ loadProfileView(); }).catch(function(err){ alert(err.message || t('error')); }); };
var profileNewPw = document.getElementById('profile-new-password'); if(profileNewPw){ profileNewPw.addEventListener('input', function(){ updatePasswordChecklist(this.value, 'profile'); }); profileNewPw.addEventListener('blur', function(){ updatePasswordChecklist(this.value, 'profile'); }); }
var pwForm = document.getElementById('profile-password-form'); if(pwForm) pwForm.onsubmit = function(e){ e.preventDefault(); var errEl = document.getElementById('profile-password-error'); var newP = document.getElementById('profile-new-password').value; var conf = document.getElementById('profile-new-password-confirm').value; if(newP !== conf){ errEl.textContent = t('errorPasswordsMatch'); return; } if(!validatePassword(newP)){ errEl.textContent = t('errorPasswordLength'); return; } errEl.textContent = ''; window.BizForum.auth.updateUser({ password: newP }).then(function(){ errEl.textContent = t('successPasswordChanged'); pwForm.reset(); }).catch(function(err){ errEl.textContent = err.message || t('error'); }); };
var emForm = document.getElementById('profile-email-form'); if(emForm) emForm.onsubmit = function(e){ e.preventDefault(); var errEl = document.getElementById('profile-email-error'); var newEmail = document.getElementById('profile-new-email').value.trim(); if(!newEmail){ errEl.textContent = t('errorEmailRequired'); return; } errEl.textContent = ''; if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)){ errEl.textContent = t('errorEmailInvalid'); return; } window.BizForum.auth.updateUser({ email: newEmail }).then(function(){ errEl.textContent = t('successEmailChanged'); emForm.reset(); }).catch(function(err){ errEl.textContent = err.message || t('error'); }); };
document.querySelectorAll('.profile-tab[data-profile-tab]').forEach(function(btn){ btn.addEventListener('click', function(){ var tab = this.getAttribute('data-profile-tab'); document.querySelectorAll('.profile-tab').forEach(function(b){ b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); }); document.querySelectorAll('.profile-tab-panel').forEach(function(p){ p.classList.remove('active'); p.hidden = true; }); this.classList.add('active'); this.setAttribute('aria-selected', 'true'); var panel = document.getElementById('profile-panel-' + tab); if(panel){ panel.classList.add('active'); panel.hidden = false; if(tab === 'statistics' && typeof loadProfileStatistics === 'function') loadProfileStatistics(); } }); });
var delBtn = document.getElementById('profile-delete-account-btn'); if(delBtn) delBtn.onclick = function(){ if(!confirm(t('profileDeleteAccountConfirm') || '–í—ã —É–≤–µ—Ä–µ–Ω—ã? –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –í—Å–µ –ø–æ—Å—Ç—ã, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return; if(!confirm(t('profileDeleteAccountConfirm2') || '–≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ. –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?')) return; if(!window.BizForum.deleteAccount){ alert(t('error') || '–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return; } delBtn.disabled = true; window.BizForum.deleteAccount().then(function(){ window.location.href = '/'; }).catch(function(err){ delBtn.disabled = false; alert((err && err.message) || t('error')); }); };
});
}
function loadProfileStatistics(){
var chartWrap = document.getElementById('profile-stats-chart-wrap'); var summaryEl = document.getElementById('profile-stats-summary'); if(!chartWrap || !summaryEl) return; chartWrap.innerHTML = '<p class="muted">' + t('loading') + '</p>'; summaryEl.innerHTML = ''; var uid = window.__bizforum_user_id; if(!uid || !window.BizForum.getAuthorStats){ chartWrap.innerHTML = '<p class="muted">' + (t('profileStatsUnavailable') || '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') + '</p>'; return; } window.BizForum.getAuthorStats(uid).then(function(s){ s = s || {}; var views = s.totalViews || 0; var posts = s.postsCount || 0; var reactions = s.reactionsReceived || 0; var comments = s.commentsCount || 0; var helpful = s.helpfulCount || 0; var byDay = s.viewsByDay || []; var fmt = typeof formatStatNumber === 'function' ? formatStatNumber : function(n){ return n != null ? String(n) : '0'; }; var summaryParts = []; summaryParts.push('<div class="profile-stats-section"><h3 class="profile-stats-section-title">' + escapeHtml(t('profileStatsSummary') || '–°–≤–æ–¥–∫–∞') + '</h3><div class="profile-stats-summary-grid">'); summaryParts.push('<div class="profile-stats-summary-item"><span class="profile-stats-summary-value">' + fmt(views) + '</span><span class="profile-stats-summary-label">' + (t('profileTotalViews') || '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã') + '</span></div>'); summaryParts.push('<div class="profile-stats-summary-item"><span class="profile-stats-summary-value">' + fmt(posts) + '</span><span class="profile-stats-summary-label">' + (t('profilePostsCount') || '–ü–æ—Å—Ç—ã') + '</span></div>'); summaryParts.push('<div class="profile-stats-summary-item"><span class="profile-stats-summary-value">' + fmt(reactions) + '</span><span class="profile-stats-summary-label">' + (t('profileReactionsReceived') || '–†–µ–∞–∫—Ü–∏–∏') + '</span></div>'); summaryParts.push('<div class="profile-stats-summary-item"><span class="profile-stats-summary-value">' + fmt(comments) + '</span><span class="profile-stats-summary-label">' + (t('profileCommentsCount') || '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏') + '</span></div>'); summaryParts.push('<div class="profile-stats-summary-item"><span class="profile-stats-summary-value">' + fmt(helpful) + '</span><span class="profile-stats-summary-label">' + (t('profileHelpfulCount') || '–ü–æ–ª–µ–∑–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤') + '</span></div>'); summaryParts.push('</div>'); if(posts > 0){ var avgViews = Math.round(views / posts); var avgReactions = Math.round(reactions / posts); summaryParts.push('<p class="profile-stats-avg">' + escapeHtml(t('profileStatsAvgPerPost') || '–í —Å—Ä–µ–¥–Ω–µ–º –Ω–∞ –ø–æ—Å—Ç') + ': <strong>' + fmt(avgViews) + '</strong> ' + (t('profileStatsWordViews') || '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤') + ', <strong>' + fmt(avgReactions) + '</strong> ' + (t('profileStatsWordReactions') || '—Ä–µ–∞–∫—Ü–∏–π') + '</p>'); } summaryParts.push('</div>'); summaryEl.innerHTML = summaryParts.join(''); var maxV = Math.max(1, Math.max.apply(null, byDay.map(function(d){ return d.views || 0; }))); var barMaxHeight = 140; var bars = byDay.length ? byDay.slice(-14).map(function(d){ var h = Math.round(((d.views || 0) / maxV) * barMaxHeight); var dateStr = (d.date || ''); var label = dateStr.length >= 10 ? dateStr.slice(8, 10) + '.' + dateStr.slice(5, 7) : dateStr; return '<div class="profile-stats-bar-wrap" title="' + escapeHtml(dateStr + ': ' + (d.views || 0)) + '"><div class="profile-stats-bar" style="height:' + h + 'px"></div><span class="profile-stats-bar-label">' + escapeHtml(label) + '</span></div>'; }).join('') : ''; var chartHtml = ''; chartHtml += '<div class="profile-stats-section"><h3 class="profile-stats-section-title">' + escapeHtml(t('profileStatsChartTitle') || '–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤') + '</h3>'; if(bars){ chartHtml += '<p class="profile-stats-chart-caption">' + escapeHtml(t('profileStatsChartHint') || '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –ø–æ –ø–æ—Å—Ç–∞–º (–ø–æ –¥–∞—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)') + '</p><div class="profile-stats-chart">' + bars + '</div>'; } else if(views > 0){ chartHtml += '<p class="profile-stats-total-only">' + escapeHtml(t('profileTotalViews') || '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã') + ': <strong>' + fmt(views) + '</strong></p><p class="muted profile-stats-chart-caption">' + escapeHtml(t('profileStatsChartHint') || '') + '</p>'; } else { chartHtml += '<p class="muted">' + (t('profileStatsNoData') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥') + '</p>'; } chartHtml += '</div>'; chartWrap.innerHTML = chartHtml; }).catch(function(){ chartWrap.innerHTML = '<p class="muted">' + t('error') + '</p>'; });
}
function loadFavorites(){
if(!listFavoritesEl) return;
showView('favorites'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('breadcrumbFavorites'), href: '' }]); listFavoritesEl.innerHTML = '<p class="feed-loading">' + t('loading') + '</p>';
function renderFavList(ids){ ids = ids && Array.isArray(ids) ? ids : []; if(ids.length === 0){ listFavoritesEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon" aria-hidden="true">‚Äî</div><h3>' + escapeHtml(t('emptyStateFav')) + '</h3><p>' + escapeHtml(t('emptyStateFavDesc')) + '</p></div>'; return; } BizForum.data.getCategories().then(function(cats){ var map = {}; cats.forEach(function(c){ map[c.id] = c; }); var list = []; var done = 0; ids.forEach(function(id){ BizForum.data.getPost(id).then(function(p){ if(p){ p._isFavorite = true; list.push(p); } done++; if(done === ids.length){ list.sort(function(a,b){ return new Date(b.createdAt) - new Date(a.createdAt); }); renderFeed(list, listFavoritesEl, map); bindCardReactionDelegation(listFavoritesEl); bindFavDelegation(listFavoritesEl); bindPostCardLinks(listFavoritesEl); } }); }); }); }
var favPromise = BizForum.data.getFavorites ? BizForum.data.getFavorites() : [];
Promise.resolve(favPromise).then(renderFavList).catch(function(){ renderFavList([]); });
}
function loadDraftsView(){
if(!listDraftsEl) return;
showView('drafts'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('navDrafts'), href: '' }]);
listDraftsEl.innerHTML = '<p class="feed-loading">' + t('loading') + '</p>';
var promise = (BizForum.data.getMyDrafts && typeof BizForum.data.getMyDrafts === 'function') ? BizForum.data.getMyDrafts() : Promise.resolve([]);
promise.then(function(list){
if(!list || list.length === 0){ listDraftsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon" aria-hidden="true">‚Äî</div><h3>' + escapeHtml(t('emptyStateDrafts')) + '</h3><p>' + escapeHtml(t('emptyStateDraftsDesc')) + '</p></div>'; return; }
BizForum.data.getCategories().then(function(cats){ var map = {}; (cats || []).forEach(function(c){ map[c.id] = c; }); var html = list.map(function(p){ var catName = (map[p.categoryId] && map[p.categoryId].name) || p.categoryId; return '<div class="post-card post-card-draft" data-post-id="' + p.id + '"><div class="post-card-link" role="button" tabindex="0" data-post-id="' + p.id + '"><div class="post-card-meta"><span class="post-card-category">' + escapeHtml(catName) + '</span><span class="post-card-date">' + formatDate(p.createdAt) + '</span></div><h2 class="post-card-title">' + escapeHtml(p.title) + '</h2><p class="post-card-excerpt">' + escapeHtml(p.excerpt || '') + '</p></div><div class="post-card-actions"><button type="button" class="btn-outline publish-draft-btn" data-post-id="' + p.id + '">' + escapeHtml(t('publishDraft')) + '</button></div></div>'; }).join(''); listDraftsEl.innerHTML = html; bindPostCardLinks(listDraftsEl); listDraftsEl.querySelectorAll('.publish-draft-btn').forEach(function(btn){ btn.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); var id = this.getAttribute('data-post-id'); if(!id || !BizForum.data.publishPost) return; var self = this; self.disabled = true; BizForum.data.publishPost(id).then(function(){ window.location.hash = '#/post/' + id; }).catch(function(err){ self.disabled = false; var msg = (err && err.message) || t('error'); if(msg.indexOf('moderation:') === 0){ var w = msg.split(':').slice(1).join(':') || ''; msg = '–ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø–æ—Å—Ç: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–ª–æ–≤–∞ ‚Äî ' + w.replace(/,/g, ', '); } alert(msg); }); }); }); });
}).catch(function(){ listDraftsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon" aria-hidden="true">‚Äî</div><h3>' + escapeHtml(t('emptyStateDrafts')) + '</h3><p>' + escapeHtml(t('emptyStateDraftsDesc')) + '</p></div>'; });
}
function loadSubscriptionView(){
showView('subscription'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('navSubscription'), href: '' }]);
var buyBtn = document.getElementById('subscription-buy-btn');
if(buyBtn && window.BizForum && window.BizForum.activateSubscription){
buyBtn.disabled = false;
if(!buyBtn._subBound){ buyBtn._subBound = true; buyBtn.addEventListener('click', function(){ if(!window.__bizforum_user_id){ if(typeof openAuthModal === 'function') openAuthModal('login'); return; } var btn = this; btn.disabled = true; window.BizForum.activateSubscription().then(function(){ if(typeof showToast === 'function') showToast((window.BizForum && window.BizForum.i18n && window.BizForum.i18n.t ? window.BizForum.i18n.t('subscriptionActivated') : '–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –º–µ—Å—è—Ü!') || '–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –º–µ—Å—è—Ü!', 'success'); if(typeof updateAuthHeader === 'function') updateAuthHeader(); btn.disabled = false; }).catch(function(err){ btn.disabled = false; alert((err && err.message) || t('error')); }); }); }
}
}
var DRAFT_KEY = 'bizforum_new_post_draft';
function loadNewPostView(){
BizForum.data.getCategories().then(function(cats){
var sel = document.getElementById('new-post-category'); if(!sel) return; sel.innerHTML = cats.map(function(c){ return '<option value="' + c.id + '">' + escapeHtml(c.name) + '</option>'; }).join('');
var priceWrap = document.getElementById('new-post-price-wrap'); var priceInput = document.getElementById('new-post-price'); if(sel && priceWrap){ function togglePriceRow(){ var v = sel.value; priceWrap.classList.toggle('hidden', v !== 'useful'); if(v !== 'useful' && priceInput) priceInput.value = '0'; } togglePriceRow(); sel.addEventListener('change', togglePriceRow); }
var tit = document.getElementById('new-post-title'); var bod = document.getElementById('new-post-body'); var med = document.getElementById('new-post-media');
try{ var d = localStorage.getItem(DRAFT_KEY); if(d){ var draft = JSON.parse(d); if(draft && (draft.title || draft.body)){ if(tit && draft.title) tit.value = draft.title; if(bod && draft.body) bod.value = draft.body; if(med && draft.media) med.value = draft.media; if(sel && draft.categoryId) sel.value = draft.categoryId; if(priceInput && draft.price != null) priceInput.value = draft.price; if(typeof showToast === 'function') showToast(t('draftRestored') || '–ß–µ—Ä–Ω–æ–≤–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info'); } } } catch(e){}
var autoSaveTm; function saveDraft(){ try{ if(!tit || !bod) return; var t = tit.value.trim(), b = bod.value.trim(); if(!t && !b) return; var cat = document.getElementById('new-post-category'); var pr = document.getElementById('new-post-price'); localStorage.setItem(DRAFT_KEY, JSON.stringify({ categoryId: cat ? cat.value : '', title: t, body: b, media: med ? med.value : '', price: pr ? parseInt(pr.value,10)||0 : 0, savedAt: Date.now() })); } catch(e){} }
[tit,bod,med,sel].filter(Boolean).forEach(function(el){ el.addEventListener('input', function(){ clearTimeout(autoSaveTm); autoSaveTm = setTimeout(saveDraft, 3000); }); el.addEventListener('change', saveDraft); });
});
var authorWrap = document.getElementById('new-post-author-wrap');
var authorInput = document.getElementById('new-post-author');
if(authorWrap && authorInput){
if(!window.BizForum || !window.BizForum.auth){ authorWrap.classList.remove('hidden'); authorInput.value = getAuthorName() || ''; authorInput.readOnly = false; }
else {
window.BizForum.auth.getUser().then(function(r){
var uid = r.data && r.data.user && r.data.user.id;
if(!uid){ authorWrap.classList.add('hidden'); return; }
if(window.BizForum.isVerified){ window.BizForum.isVerified().then(function(verified){ if(verified && window.BizForum.getDisplayName){ authorWrap.classList.remove('hidden'); authorWrap.querySelector('input').readOnly = true; window.BizForum.getDisplayName().then(function(name){ authorInput.value = (name || '').trim() || (t('postAuthor') + ' (–∏–º—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)'); }); } else authorWrap.classList.add('hidden'); }); return; }
authorWrap.classList.add('hidden');
});
}
}
showView('new'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('breadcrumbNewPost'), href: '' }]);
var formTitleEl = document.getElementById('post-form-title'); var formBackEl = document.getElementById('post-form-back'); if(formTitleEl) formTitleEl.textContent = t('pageNewPost'); if(formBackEl){ formBackEl.href = '#/'; formBackEl.textContent = '‚Üê'; } var postForm = document.getElementById('post-form'); if(postForm){ postForm._editPostId = null; delete postForm.dataset.editPostId; } var draftBtn = document.getElementById('new-post-draft-btn'); if(draftBtn) draftBtn.style.display = '';
}
function loadEditPostView(postId){
if(!postId || !BizForum.data.getPost) return;
BizForum.data.getPost(postId).then(function(p){
if(!p){ window.location.hash = '#/'; return; }
BizForum.data.getCategories().then(function(cats){
var sel = document.getElementById('new-post-category'); if(sel){ sel.innerHTML = cats.map(function(c){ return '<option value="' + c.id + '">' + escapeHtml(c.name) + '</option>'; }).join(''); sel.value = p.categoryId || ''; }
var tit = document.getElementById('new-post-title'); var bod = document.getElementById('new-post-body'); var med = document.getElementById('new-post-media'); var priceInput = document.getElementById('new-post-price');
if(tit) tit.value = p.title || ''; if(bod) bod.value = p.body || ''; if(med && p.mediaUrls && Array.isArray(p.mediaUrls)) med.value = p.mediaUrls.map(function(m){ return (m && m.url) ? m.url : (typeof m === 'string' ? m : ''); }).filter(Boolean).join('\n'); else if(med) med.value = ''; if(priceInput) priceInput.value = (p.price != null && p.price > 0) ? p.price : '0';
var priceWrap = document.getElementById('new-post-price-wrap'); if(priceWrap) priceWrap.classList.toggle('hidden', (p.categoryId || '') !== 'useful'); if(sel && priceWrap){ function togglePriceRow(){ var v = sel.value; priceWrap.classList.toggle('hidden', v !== 'useful'); if(v !== 'useful' && priceInput) priceInput.value = '0'; } sel.addEventListener('change', togglePriceRow); }
var formTitleEl = document.getElementById('post-form-title'); var formBackEl = document.getElementById('post-form-back'); if(formTitleEl) formTitleEl.textContent = t('pageEditPost'); if(formBackEl){ formBackEl.href = '#/post/' + postId; formBackEl.textContent = '‚Üê'; }
var postForm = document.getElementById('post-form'); if(postForm){ postForm._editPostId = postId; postForm.dataset.editPostId = String(postId); }
var draftBtn = document.getElementById('new-post-draft-btn'); if(draftBtn) draftBtn.style.display = 'none';
var authorWrap = document.getElementById('new-post-author-wrap'); if(authorWrap) authorWrap.classList.add('hidden');
var postSubmitBtn = postForm && postForm.querySelector('button[type="submit"]'); if(postSubmitBtn) postSubmitBtn.textContent = t('postSave');
try{ localStorage.removeItem(DRAFT_KEY); } catch(e){}
var tc = document.getElementById('new-post-title-counter'); var bc = document.getElementById('new-post-body-counter'); var ti = document.getElementById('new-post-title'); var bi = document.getElementById('new-post-body'); if(tc && ti) tc.textContent = (ti.value || '').length + ' / 300'; if(bc && bi) bc.textContent = (bi.value || '').length + ' / 5000';
showView('new'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: (t('pageEditPost') || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç').slice(0, 40), href: '' }]); closeSidebar();
});
});
}
function runSearch(){ var q = (document.getElementById('search-input') && document.getElementById('search-input').value) || ''; window.location.hash = '#/search/' + encodeURIComponent(q); }
function getSearchFilterOpts(){ var cat = document.getElementById('search-filter-category'); var from = document.getElementById('search-filter-date-from'); var to = document.getElementById('search-filter-date-to'); var opts = {}; if(cat && cat.value) opts.categoryId = cat.value; if(from && from.value) opts.dateFrom = from.value; if(to && to.value) opts.dateTo = to.value; return opts; }
function loadSearchView(query){ if(!query || !BizForum.data.searchPosts) return; var opts = getSearchFilterOpts(); BizForum.data.getCategories().then(function(cats){ var map = {}; cats.forEach(function(c){ map[c.id] = c; }); var catSelect = document.getElementById('search-filter-category'); if(catSelect && catSelect.options.length <= 1){ cats.forEach(function(c){ var opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; catSelect.appendChild(opt); }); } return BizForum.data.searchPosts(query, opts).then(function(list){ list.forEach(function(p){ p._highlightQuery = query; }); renderFeed(list, listSearchEl, map); bindCardReactionDelegation(listSearchEl); bindFavDelegation(listSearchEl); bindPostCardLinks(listSearchEl); if(searchResultTitleEl) searchResultTitleEl.textContent = query ? ((window.BizForum && window.BizForum.i18n && window.BizForum.i18n.tFormat) ? window.BizForum.i18n.tFormat('searchFor', { q: query, n: list.length }) : '–ü–æ –∑–∞–ø—Ä–æ—Å—É ¬´' + query + '¬ª: ' + list.length) : t('searchResults'); }); }).catch(function(){ if(listSearchEl) listSearchEl.innerHTML = ''; if(searchResultTitleEl) searchResultTitleEl.textContent = t('searchResults'); }); }
function closeSidebar(){ var sb = document.getElementById('sidebar'); var ov = document.getElementById('sidebar-overlay'); if(sb) sb.classList.remove('open'); if(ov) ov.classList.remove('visible'); }
function getTourSteps(){ return [ { target: null, title: t('tourWelcomeTitle'), text: t('tourWelcomeText'), position: 'bottom' }, { target: '[data-tour="step-logo"]', title: t('tourStepLogoTitle'), text: t('tourStepLogoText'), position: 'bottom' }, { target: '[data-tour="step-nav"]', title: t('tourStepNavTitle'), text: t('tourStepNavText'), position: 'bottom' }, { target: '[data-tour="step-sidebar"]', title: t('tourStepSidebarTitle'), text: t('tourStepSidebarText'), position: 'right' }, { target: '[data-tour="step-feed"]', title: t('tourStepFeedTitle'), text: t('tourStepFeedText'), position: 'bottom' }, { target: '[data-tour="step-profile"]', title: t('tourStepProfileTitle'), text: t('tourStepProfileText'), position: 'left' }, { target: null, title: t('tourEndTitle'), text: t('tourEndText'), position: 'bottom' } ]; }
function route(){
var hash = (window.location.hash || '#/').slice(1);
var qi = hash.indexOf('?');
if(qi >= 0) hash = hash.slice(0, qi);
hash = hash.replace(/^\/+|\/+$/g, '');
var parts = hash ? hash.split('/') : [];
var seg0 = parts[0] || 'feed';
var viewNew = document.getElementById('view-new');
if(viewNew && !viewNew.classList.contains('hidden') && seg0 !== 'new' && seg0 !== 'edit'){ if(window.__bizforum_new_post_just_submitted){ window.__bizforum_new_post_just_submitted = false; } else { var titleEl = document.getElementById('new-post-title'); var bodyEl = document.getElementById('new-post-body'); if(titleEl && bodyEl && (titleEl.value.trim() || bodyEl.value.trim())){ if(!confirm(t('confirmLeaveNewPost'))){ var pf = document.getElementById('post-form'); var editId = pf && (pf._editPostId || pf.dataset.editPostId || null); window.location.hash = editId ? '#/edit/' + editId : '#/new'; return; } } } }
if(seg0 === 'post' && parts[1]){ fromRoute = lastListRoute || '#/'; lastScrollY = window.scrollY; updatePageMeta('@Bizz ‚Äî –ø–æ—Å—Ç', ''); loadPost(parts[1]); closeSidebar(); return; }
if(seg0 === 'category' && parts[1]){ lastListRoute = '#/category/' + parts[1]; showView('category'); loadCategoryFeed(parts[1], getSortCat()).then(function(){ if(window.__bizforum_restoreScroll != null){ window.scrollTo(0, window.__bizforum_restoreScroll); window.__bizforum_restoreScroll = null; } }); closeSidebar(); return; }
if(seg0 === 'categories'){ loadCategoriesPage(); closeSidebar(); return; }
if(seg0 === 'favorites'){ lastListRoute = '#/favorites'; loadFavorites(); BizForum.data.getCategories().then(renderSidebarCategories); closeSidebar(); return; }
if(seg0 === 'drafts'){ lastListRoute = '#/drafts'; loadDraftsView(); closeSidebar(); return; }
if(seg0 === 'subscription'){ loadSubscriptionView(); closeSidebar(); return; }
if(seg0 === 'search' && parts[1]){ lastListRoute = '#/search/' + parts[1]; lastSearchQuery = decodeURIComponent(parts[1].replace(/\+/g, ' ')); var searchInput = document.getElementById('search-input'); if(searchInput) searchInput.value = lastSearchQuery; showView('search'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('searchResults'), href: '' }]); loadSearchView(lastSearchQuery); closeSidebar(); return; }
if(seg0 === 'new'){ loadNewPostView(); BizForum.data.getCategories().then(renderSidebarCategories); closeSidebar(); return; }
if(seg0 === 'edit' && parts[1]){ loadEditPostView(parts[1]); closeSidebar(); return; }
if(seg0 === 'admin' && parts[1] === 'verification'){ loadVerificationView(); closeSidebar(); return; }
if(seg0 === 'admin' && parts[1] === 'reports'){ loadAdminReportsView(); closeSidebar(); return; }
if(seg0 === 'admin' && parts[1] === 'registry'){ loadAdminRegistryView(); closeSidebar(); return; }
if(seg0 === 'admin' && parts[1] === 'content'){ loadAdminContentView(); closeSidebar(); return; }
if(seg0 === 'admin'){ loadAdminDashboardView(); closeSidebar(); return; }
if(seg0 === 'profile'){ loadProfileView(); closeSidebar(); return; }
if(seg0 === 'friends'){ loadFriendsView(); closeSidebar(); return; }
if(seg0 === 'groups'){ loadGroupsView(); closeSidebar(); return; }
if(seg0 === 'user' && parts[1]){ loadUserProfileView(parts[1]); return; }
if(seg0 === 'privacy'){ showView('privacy'); setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('footerPrivacy'), href: '' }]); closeSidebar(); return; }
if(seg0 === 'following'){
  (window.BizForum && window.BizForum.auth ? window.BizForum.auth.getUser() : Promise.resolve({ data: null })).then(function(r){
    var loggedIn = !!(r && r.data && r.data.user);
    if(!loggedIn){ window.location.hash = '#/'; return; }
    feedFollowingMode = true;
    document.querySelectorAll('.feed-tab').forEach(function(t){ t.classList.toggle('active', t.getAttribute('data-feed-mode') === 'following'); });
    lastListRoute = '#/following'; setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }, { name: t('feedFeedFollowing'), href: '' }]); showView('feed');
    loadFeed(getSort());
    if(BizForum.data.getCategories) BizForum.data.getCategories().then(renderSidebarCategories).catch(function(){});
    closeSidebar();
  });
  return;
}
if(seg0 === '' || seg0 === 'feed'){
  (window.BizForum && window.BizForum.auth ? window.BizForum.auth.getUser() : Promise.resolve({ data: null })).then(function(r){
    var h = (window.location.hash || '#/').slice(1).replace(/^\/+|\/+$/g, ''); var p0 = h ? h.split('/')[0] : '';
    if(p0 && p0 !== '' && p0 !== 'feed') return;
    var loggedIn = !!(r && r.data && r.data.user);
    if(!loggedIn){ showView('landing'); document.body.classList.add('landing-visible'); setBreadcrumbs([]); closeSidebar(); if(typeof loadLandingPreview === 'function') loadLandingPreview(); return; }
    document.body.classList.remove('landing-visible');
    feedFollowingMode = false;
    document.querySelectorAll('.feed-tab').forEach(function(t){ t.classList.toggle('active', t.getAttribute('data-feed-mode') === 'all'); });
    lastListRoute = '#/'; setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }]); showView('feed');
    var feedPromise = loadFeed(getSort());
    if(feedPromise && typeof feedPromise.then === 'function') feedPromise.then(function(){ if(window.__bizforum_restoreScroll != null){ window.scrollTo(0, window.__bizforum_restoreScroll); window.__bizforum_restoreScroll = null; } }); else if(window.__bizforum_restoreScroll != null){ window.scrollTo(0, window.__bizforum_restoreScroll); window.__bizforum_restoreScroll = null; }
    if(BizForum.data.getCategories) BizForum.data.getCategories().then(renderSidebarCategories).catch(function(){ if(categoryListEl) renderSidebarCategories([]); });
    closeSidebar();
    setTimeout(function(){ if(window.BizForumTour && (window.BizForumTour.shouldShowAfterLogin() || window.BizForumTour.requestShowFromLink())){ var steps = getTourSteps(); window.BizForumTour.start(steps, { forceShow: window.BizForumTour.requestShowFromLink() }); } }, 500);
  });
  return;
}
feedFollowingMode = false;
lastListRoute = '#/';
setBreadcrumbs([{ name: t('breadcrumbHome'), href: '#/' }]);
showView('feed');
document.querySelectorAll('.feed-tab').forEach(function(t){ t.classList.toggle('active', t.getAttribute('data-feed-mode') === 'all'); });
var feedPromise = loadFeed(getSort());
if(feedPromise && typeof feedPromise.then === 'function') feedPromise.then(function(){ if(window.__bizforum_restoreScroll != null){ window.scrollTo(0, window.__bizforum_restoreScroll); window.__bizforum_restoreScroll = null; } }); else if(window.__bizforum_restoreScroll != null){ window.scrollTo(0, window.__bizforum_restoreScroll); window.__bizforum_restoreScroll = null; }
if(BizForum.data.getCategories) BizForum.data.getCategories().then(renderSidebarCategories).catch(function(){ if(categoryListEl) renderSidebarCategories([]); });
closeSidebar();
}
var runAppAttempts = 0;
function runApp(){
if(!window.BizForum || !window.BizForum.data){ runAppAttempts++; if(runAppAttempts < 100) setTimeout(runApp, 50); return; }
listEl = document.getElementById('post-list'); listCatEl = document.getElementById('post-list-category'); listFavoritesEl = document.getElementById('post-list-favorites');
categoryListEl = document.getElementById('category-list'); categoriesGridEl = document.getElementById('categories-grid');
postFullEl = document.getElementById('post-full'); postReactionsEl = document.getElementById('post-reactions'); commentsListEl = document.getElementById('comments-list');
categoryFeedTitleEl = document.getElementById('category-feed-title'); searchResultTitleEl = document.getElementById('search-result-title'); breadcrumbsEl = document.getElementById('breadcrumbs');
views.feed = document.getElementById('view-feed'); views.category = document.getElementById('view-category'); views.post = document.getElementById('view-post'); views.categories = document.getElementById('view-categories'); views.search = document.getElementById('view-search'); views.favorites = document.getElementById('view-favorites'); views.drafts = document.getElementById('view-drafts'); views.new = document.getElementById('view-new'); views.admin = document.getElementById('view-admin'); views.adminDashboard = document.getElementById('view-admin-dashboard'); views.adminVerification = document.getElementById('view-admin-verification'); views.adminReports = document.getElementById('view-admin-reports'); views.adminContent = document.getElementById('view-admin-content'); views.profile = document.getElementById('view-profile'); views.friends = document.getElementById('view-friends'); views.userProfile = document.getElementById('view-user-profile'); views.landing = document.getElementById('view-landing');
bindCardReactionDelegation(document.body);
bindBuyPostDelegation(document.body);
bindOpenPostDelegation(document.body);
bindShareDelegation(document.body);
bindDeletePostDelegation(document.body);
if(window.BizForum && window.BizForum.i18n && window.BizForum.i18n.applyLang) window.BizForum.i18n.applyLang();
var welcomeBanner = document.getElementById('welcome-banner'); var welcomeBannerClose = document.getElementById('welcome-banner-close');
if(welcomeBanner && welcomeBannerClose){ try { if(!localStorage.getItem('bizforum_welcome_seen')) welcomeBanner.classList.remove('hidden'); } catch(e){} welcomeBannerClose.addEventListener('click', function(){ try { localStorage.setItem('bizforum_welcome_seen', '1'); } catch(e){} welcomeBanner.classList.add('hidden'); }); }
function landingParallax(e){ if(!document.body.classList.contains('landing-visible')) return; var shapes = document.querySelectorAll('.landing-bg-shapes .landing-shape'); if(!shapes.length) return; var cx = window.innerWidth / 2; var cy = window.innerHeight / 2; var nx = (e.clientX - cx) / cx; var ny = (e.clientY - cy) / cy; var move = 30; shapes.forEach(function(s){ var px = parseFloat(s.getAttribute('data-px')) || 0.5; var tx = nx * move * px; var ty = ny * move * px; s.style.transform = 'translate(' + tx + 'px,' + ty + 'px)'; }); }
document.addEventListener('mousemove', landingParallax);
function loadLandingPreview(){
  var container = document.getElementById('landing-preview-posts');
  if(!container) return;
  if(!container.dataset.clickBound){ container.dataset.clickBound='1'; container.addEventListener('click', function(e){ if(e.target.closest('.landing-preview-post')){ e.preventDefault(); if(typeof openAuthModal === 'function') openAuthModal('register'); } }); }
  var placeholder = [
    { title: '–ö–∞–∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å –±–µ–∑ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤?', excerpt: '–ö—Ç–æ –ø—Ä–æ—à—ë–ª –ø—É—Ç—å –æ—Ç –≤—ã—Ä—É—á–∫–∏ 1‚Äì3 –º–ª–Ω –¥–æ 10+ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –¥–µ–Ω–µ–≥? –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Ä–µ–∞–ª—å–Ω—ã–º –æ–ø—ã—Ç–æ–º: —á—Ç–æ –ø–æ–º–æ–≥–ª–æ, –∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –∏–∑–±–µ–∂–∞—Ç—å.', categoryName: '–§–∏–Ω–∞–Ω—Å—ã', author: '–û–ª—å–≥–∞ –ö.', views: '6 570', comments: '127', reactions: '1,3 —Ç—ã—Å' },
    { title: '–ö–∞–∫ –ø—Ä–∏–≤–ª–µ—á—å –ø–µ—Ä–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –±—é–¥–∂–µ—Ç–∞', excerpt: '–î–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º: —á—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –≤ –≤–∞—à–µ–º —Å—Ç–∞—Ä—Ç–∞–ø–µ –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤?', categoryName: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥', author: '–ê–ª–µ–∫—Å–µ–π –ú.', views: '12', comments: '3' },
    { title: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä—É—Ç–∏–Ω—ã', excerpt: '–ö–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥–ª—è —É—á—ë—Ç–∞, CRM, —Ä–∞—Å—Å—ã–ª–æ–∫? –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏.', categoryName: '–ü—Ä–æ–¥–∞–∂–∏', author: '–ú–∞—Ä–∏—è –ö.', views: '12', comments: '3' }
  ];
  function cardHtml(p){
    var av = '<span class="avatar-wrap avatar-initial">' + escapeHtml((p.author || '?').charAt(0).toUpperCase()) + '</span>';
    var v = t('views');
    var c = t('commentsShort');
    var r = t('reactions');
    var rm = t('readMore');
    var statsHtml = '<span class="stat-views">' + (p.views || '12') + ' ' + v + '</span><span class="stat-comments">' + (p.comments || '3') + ' ' + c + '</span>';
    if(p.reactions) statsHtml += '<span class="stat-reactions">' + p.reactions + ' ' + r + '</span>';
    return '<div class="post-card landing-preview-post" role="button" tabindex="0"><div class="post-card-link"><div class="post-card-meta"><span class="post-card-category">' + escapeHtml(p.categoryName) + '</span><span class="post-card-author">' + av + '<span>' + escapeHtml(p.author) + '</span></span><span class="post-card-date">' + (p.dateStr || '') + '</span></div><h2 class="post-card-title">' + escapeHtml(p.title) + '</h2><p class="post-card-excerpt">' + escapeHtml(p.excerpt) + '</p><a href="#" class="post-card-read-more">' + rm + ' ‚Üí</a></div><div class="post-card-stats">' + statsHtml + '</div></div>';
  }
  function renderPlaceholder(){
    var now = new Date();
    var dateStr = now.toLocaleDateString((window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
    container.innerHTML = placeholder.map(function(p){ return cardHtml({ categoryName: p.categoryName, author: p.author, title: p.title, excerpt: p.excerpt, dateStr: dateStr, views: p.views || '12', comments: p.comments || '3', reactions: p.reactions }); }).join('');
    container.querySelectorAll('.landing-preview-post').forEach(function(el){ el.addEventListener('click', function(e){ e.preventDefault(); if(typeof openAuthModal === 'function') openAuthModal('register'); }); });
  }
  renderPlaceholder();
}
var scrollProgressEl = document.getElementById('scroll-progress'); var backToTopEl = document.getElementById('back-to-top');
function onScrollUI(){ var h = document.documentElement.scrollHeight - window.innerHeight; if(h > 0 && scrollProgressEl) scrollProgressEl.style.width = (window.scrollY / h) * 100 + '%'; if(backToTopEl){ var show = window.scrollY > 400; backToTopEl.classList.toggle('visible', show); backToTopEl.classList.toggle('hidden', !show); } }
if(backToTopEl) backToTopEl.addEventListener('click', function(){ window.scrollTo(0, 0); });
window.addEventListener('scroll', onScrollUI, { passive: true });
function updateCharCounter(inputId, counterId, max){ var inp = document.getElementById(inputId); var cnt = document.getElementById(counterId); if(!inp || !cnt) return; function upd(){ var len = (inp.value || '').length; cnt.textContent = len + '/' + max; } inp.addEventListener('input', upd); upd(); }
updateCharCounter('new-post-title', 'new-post-title-counter', 300); updateCharCounter('new-post-body', 'new-post-body-counter', 10000); updateCharCounter('comment-body', 'comment-body-counter', 2000);
var feedFilterMine = document.getElementById('feed-filter-mine'); if(feedFilterMine) feedFilterMine.addEventListener('change', function(){ loadFeed(getSort()); });
var shortcutsModal = document.getElementById('shortcuts-modal'); var shortcutsClose = document.getElementById('shortcuts-close');
if(shortcutsClose && shortcutsModal) shortcutsClose.addEventListener('click', function(){ shortcutsModal.classList.add('hidden'); });
document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ closeAuthModal(); var cp = document.getElementById('chat-panel'); if(cp && !cp.classList.contains('hidden')){ closeChatPanel(); } var sb = document.getElementById('sidebar'); var ov = document.getElementById('sidebar-overlay'); if(sb) sb.classList.remove('open'); if(ov) ov.classList.remove('visible'); if(shortcutsModal && !shortcutsModal.classList.contains('hidden')) shortcutsModal.classList.add('hidden'); } else if(e.key === '?' && !e.ctrlKey && !e.metaKey && !e.altKey){ var target = e.target; if(target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA')) return; e.preventDefault(); if(shortcutsModal) shortcutsModal.classList.remove('hidden'); } });
function initTheme(){ var stored = ''; try { stored = localStorage.getItem('bizforum_theme') || ''; } catch(e){} var dark = stored === 'dark'; document.body.classList.toggle('theme-dark', dark); var sun = document.querySelector('.theme-icon-sun'); var moon = document.querySelector('.theme-icon-moon'); if(sun && moon){ sun.classList.toggle('hidden', dark); moon.classList.toggle('hidden', !dark); } }
function toggleTheme(){ var dark = document.body.classList.toggle('theme-dark'); try { localStorage.setItem('bizforum_theme', dark ? 'dark' : 'light'); } catch(e){} var sun = document.querySelector('.theme-icon-sun'); var moon = document.querySelector('.theme-icon-moon'); if(sun && moon){ sun.classList.toggle('hidden', dark); moon.classList.toggle('hidden', !dark); } }
initTheme();
var themeBtn = document.getElementById('theme-toggle'); if(themeBtn) themeBtn.addEventListener('click', toggleTheme);
var langBtn = document.getElementById('lang-btn'); var langDrop = document.getElementById('lang-dropdown'); if(langBtn && langDrop){ langBtn.addEventListener('click', function(e){ e.stopPropagation(); document.querySelector('.lang-switcher') && document.querySelector('.lang-switcher').classList.toggle('open'); }); document.querySelectorAll('.lang-option').forEach(function(opt){ opt.addEventListener('click', function(){ var lang = this.getAttribute('data-lang'); if(lang && window.BizForum && window.BizForum.i18n){ window.BizForum.i18n.setLang(lang); window.BizForum.i18n.applyLang(); document.querySelector('.lang-switcher') && document.querySelector('.lang-switcher').classList.remove('open'); route(); } }); }); document.addEventListener('click', function(ev){ if(!ev.target.closest('.lang-switcher')) document.querySelectorAll('.lang-switcher.open').forEach(function(w){ w.classList.remove('open'); }); }); }
window.addEventListener('bizforum:lang', function(){ route(); });
var sortEl = document.getElementById('sort'); if(sortEl) sortEl.addEventListener('change', function(){ loadFeed(this.value); });
function syncSortPills(){ var v = getSort(); document.querySelectorAll('.feed-sort-pill').forEach(function(p){ p.classList.toggle('active', p.getAttribute('data-sort') === v); }); }
document.querySelectorAll('.feed-sort-pill').forEach(function(pill){ pill.addEventListener('click', function(){ var v = this.getAttribute('data-sort'); if(!v) return; if(sortEl) sortEl.value = v; syncSortPills(); loadFeed(v); }); });
var sortCatEl = document.getElementById('sort-cat'); if(sortCatEl) sortCatEl.addEventListener('change', function(){ var path = (window.location.hash || '#/').slice(1).replace(/^\/+|\/+$/g, ''); var parts = path ? path.split('/') : []; if(parts[0] === 'category' && parts[1]) loadCategoryFeed(parts[1], this.value); });
var searchInput = document.getElementById('search-input');
var searchBtn = document.getElementById('search-btn');
if(searchBtn) searchBtn.addEventListener('click', runSearch);
if(searchInput) searchInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); runSearch(); } });
var searchFilterCat = document.getElementById('search-filter-category'); var searchFilterFrom = document.getElementById('search-filter-date-from'); var searchFilterTo = document.getElementById('search-filter-date-to');
function onSearchFilterChange(){ if(lastSearchQuery) loadSearchView(lastSearchQuery); }
if(searchFilterCat) searchFilterCat.addEventListener('change', onSearchFilterChange);
if(searchFilterFrom) searchFilterFrom.addEventListener('change', onSearchFilterChange);
if(searchFilterTo) searchFilterTo.addEventListener('change', onSearchFilterChange);
var logoEl = document.querySelector('a.logo'); if(logoEl) logoEl.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); window.location.hash = '#/'; return false; });
var commentForm = document.getElementById('comment-form'); if(commentForm) commentForm.addEventListener('submit', function(e){
e.preventDefault();
var body = document.getElementById('comment-body'); var text = (body && body.value) ? body.value.trim() : '';
if(!text) return;
if(!currentPostId) return;
var commentFormError = document.getElementById('comment-form-error'); if(commentFormError) commentFormError.textContent = '';
var submitBtn = commentForm.querySelector('button[type="submit"]'); if(submitBtn) submitBtn.disabled = true;
function doAddComment(author){
author = author || getAuthorName() || '–ì–æ—Å—Ç—å';
if(author && !(document.getElementById('comment-author') && document.getElementById('comment-author').value)) setAuthorName(author);
var parentIdEl = document.getElementById('comment-parent-id');
var parentId = (parentIdEl && parentIdEl.value) ? parentIdEl.value.trim() : null;
if(!BizForum.data || !BizForum.data.addComment){ if(commentFormError) commentFormError.textContent = '–§—É–Ω–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Supabase (config.js).'; if(submitBtn) submitBtn.disabled = false; return; }
var p = BizForum.data.addComment(currentPostId, text, author, getSessionId(), parentId || undefined);
var fin = function(){ if(submitBtn) submitBtn.disabled = false; };
if(p && typeof p.then === 'function') p.then(function(newComment){ if(!newComment){ if(commentFormError) commentFormError.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'; fin(); return; } var sentText = text; body.value = ''; if(parentIdEl) parentIdEl.value = ''; try { localStorage.removeItem('bizforum_comment_draft_' + currentPostId); } catch(e){} var replyToEl = document.getElementById('comment-reply-to'); if(replyToEl) replyToEl.classList.add('hidden'); currentReplyToAuthorId = null; if(commentFormError) commentFormError.textContent = ''; if(window.BizForum.createNotification && newComment.id){ if(parentId && currentReplyToAuthorId) window.BizForum.createNotification(currentReplyToAuthorId, 'reply_to_comment', { post_id: currentPostId, comment_id: newComment.id }).catch(function(){}); else if(!parentId && currentPostAuthorId) window.BizForum.createNotification(currentPostAuthorId, 'comment_on_post', { post_id: currentPostId, comment_id: newComment.id }).catch(function(){}); (sentText.match(/@([^\s@]+)/g) || []).forEach(function(m){ var name = (m || '').slice(1).toLowerCase().trim(); if(!name) return; var uid = commentAuthorMap[name]; if(uid && uid !== window.__bizforum_user_id) window.BizForum.createNotification(uid, 'mention', { post_id: currentPostId, comment_id: newComment.id }).catch(function(){}); }); } loadAndRenderComments(function(comments){ updatePostStatsCommentCount(comments.length); }); }).catch(function(err){ if(commentFormError) commentFormError.textContent = (err && err.message) ? err.message : t('error'); }).finally(fin); else fin();
}
function checkVerifiedThenSend(){
if(!window.BizForum || !window.BizForum.auth){ doAddComment((document.getElementById('comment-author') && document.getElementById('comment-author').value) ? document.getElementById('comment-author').value.trim() : getAuthorName()); return; }
window.BizForum.auth.getUser().then(function(r){
var uid = r.data && r.data.user && r.data.user.id;
if(!uid){ doAddComment((document.getElementById('comment-author') && document.getElementById('comment-author').value) ? document.getElementById('comment-author').value.trim() : getAuthorName()); return; }
if(window.BizForum.isVerified){ window.BizForum.isVerified().then(function(verified){ if(!verified){ if(commentFormError) commentFormError.textContent = t('unverifiedHint') || '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ª–µ–Ω—Ç—É –∏ —Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'; if(submitBtn) submitBtn.disabled = false; return; } if(window.BizForum.getDisplayName) window.BizForum.getDisplayName().then(doAddComment).catch(function(){ doAddComment(''); }); else doAddComment(''); }); return; }
if(window.BizForum.getDisplayName) window.BizForum.getDisplayName().then(doAddComment).catch(function(){ doAddComment(''); }); else doAddComment('');
});
}
checkVerifiedThenSend();
});
var bodyTextarea = document.getElementById('new-post-body'); var boldBtn = document.getElementById('post-body-bold'); var italicBtn = document.getElementById('post-body-italic');
function wrapSelection(openTag, closeTag){
if(!bodyTextarea) return; bodyTextarea.focus(); var start = bodyTextarea.selectionStart, end = bodyTextarea.selectionEnd, val = bodyTextarea.value; var before = val.slice(0, start), sel = val.slice(start, end), after = val.slice(end); bodyTextarea.value = before + openTag + sel + closeTag + after; bodyTextarea.selectionStart = bodyTextarea.selectionEnd = start + openTag.length + sel.length; bodyTextarea.focus();
}
function insertAtCursor(prefix, suffix){ if(!bodyTextarea) return; bodyTextarea.focus(); var start = bodyTextarea.selectionStart, val = bodyTextarea.value; bodyTextarea.value = val.slice(0, start) + prefix + (suffix || '') + val.slice(start); bodyTextarea.selectionStart = bodyTextarea.selectionEnd = start + prefix.length; bodyTextarea.focus(); }
if(boldBtn && bodyTextarea){ boldBtn.addEventListener('click', function(){ wrapSelection('**', '**'); }); }
if(italicBtn && bodyTextarea){ italicBtn.addEventListener('click', function(){ wrapSelection('*', '*'); }); }
if(bodyTextarea){
bodyTextarea.addEventListener('keydown', function(e){
if(!e.ctrlKey && !e.metaKey) return;
if(e.key === 'b'){ e.preventDefault(); wrapSelection('**', '**'); return; }
if(e.key === 'i'){ e.preventDefault(); wrapSelection('*', '*'); return; }
if(e.key === 'k'){ e.preventDefault(); wrapSelection('[', '](url)'); return; }
});
}
var linkBtn = document.getElementById('post-body-link'); if(linkBtn && bodyTextarea){ linkBtn.addEventListener('click', function(){ wrapSelection('[', '](url)'); }); }
var ulBtn = document.getElementById('post-body-ul'); if(ulBtn && bodyTextarea){ ulBtn.addEventListener('click', function(){ insertAtCursor('- ', ''); }); }
var quoteBtn = document.getElementById('post-body-quote'); if(quoteBtn && bodyTextarea){ quoteBtn.addEventListener('click', function(){ wrapSelection('> ', ''); }); }
var codeBtn = document.getElementById('post-body-code'); if(codeBtn && bodyTextarea){ codeBtn.addEventListener('click', function(){ wrapSelection('`', '`'); }); }
var titleInput = document.getElementById('new-post-title'); var titleCounter = document.getElementById('new-post-title-counter'); var bodyCounter = document.getElementById('new-post-body-counter');
function updateCharCounters(){ if(titleCounter && titleInput) titleCounter.textContent = (titleInput.value || '').length + ' / 300'; if(bodyCounter && bodyTextarea) bodyCounter.textContent = (bodyTextarea.value || '').length + ' / 5000'; }
if(titleInput){ titleInput.addEventListener('input', updateCharCounters); updateCharCounters(); }
if(bodyTextarea){ bodyTextarea.addEventListener('input', updateCharCounters); updateCharCounters(); }
var postForm = document.getElementById('post-form'); if(postForm) postForm.addEventListener('submit', function(e){
e.preventDefault();
var form = e.currentTarget;
var postFormError = document.getElementById('post-form-error'); if(postFormError) postFormError.textContent = '';
var categoryId = (form.querySelector('#new-post-category') || {}).value || '';
var title = ((form.querySelector('#new-post-title') || {}).value || '').trim();
var body = ((form.querySelector('#new-post-body') || {}).value || '').trim();
var postSubmitBtn = form.querySelector('button[type="submit"]');
var editPostId = form._editPostId || (form.dataset.editPostId || null) || null;
if(editPostId && (title || body)){
if(postSubmitBtn) postSubmitBtn.disabled = true;
var mediaEl = document.getElementById('new-post-media'); var mediaUrls = []; if(mediaEl && mediaEl.value){ var lines = (mediaEl.value || '').split(/[\r\n]+/).map(function(s){ return s.trim(); }).filter(Boolean); mediaUrls = lines.map(function(url){ var ext = (url.split('.').pop() || '').split('?')[0].toLowerCase(); var isVideo = /^(mp4|webm|ogg|mov)$/i.test(ext); return { type: isVideo ? 'video' : 'image', url: url }; }); } var priceVal = document.getElementById('new-post-price'); var price = (categoryId === 'useful' && priceVal && priceVal.value) ? parseInt(priceVal.value, 10) || 0 : 0;
var updateData = { title: title, body: body, categoryId: categoryId, mediaUrls: mediaUrls, price: price };
var fn = adminModeOn && window.BizForum.adminUpdatePost ? function(){ return window.BizForum.adminUpdatePost(editPostId, title, body); } : (BizForum.data && BizForum.data.updatePost) ? function(){ return BizForum.data.updatePost(editPostId, updateData); } : null;
if(fn) fn().then(function(){ form._editPostId = null; if(form.dataset) form.dataset.editPostId = ''; window.__bizforum_new_post_just_submitted = true; window.location.hash = '#/post/' + editPostId; }).catch(function(err){ if(postSubmitBtn) postSubmitBtn.disabled = false; var msg = (err && err.message) || t('error'); if(msg.indexOf('moderation:') === 0){ msg = '–ò—Å–ø—Ä–∞–≤—å—Ç–µ: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–ª–æ–≤–∞ ‚Äî ' + ((msg.split(':')[1] || '').replace(/,/g, ', ')); } if(postFormError) postFormError.textContent = msg; }); else { if(postSubmitBtn) postSubmitBtn.disabled = false; }
return;
}
function doCreatePost(author, isDraft){
author = author || (document.getElementById('new-post-author') && document.getElementById('new-post-author').value) || getAuthorName() || '–ì–æ—Å—Ç—å';
if(!title || !body || !categoryId) return;
if(postSubmitBtn) postSubmitBtn.disabled = true;
var mediaEl = document.getElementById('new-post-media');
var mediaUrls = [];
if(mediaEl && mediaEl.value){ var lines = (mediaEl.value || '').split(/[\r\n]+/).map(function(s){ return s.trim(); }).filter(Boolean); mediaUrls = lines.map(function(url){ var ext = (url.split('.').pop() || '').split('?')[0].toLowerCase(); var isVideo = /^(mp4|webm|ogg|mov)$/i.test(ext); return { type: isVideo ? 'video' : 'image', url: url }; }); }
var data = { categoryId: categoryId, title: title, body: body, author: author }; if(isDraft) data.draft = true; if(mediaUrls.length) data.mediaUrls = mediaUrls; var anonCb = document.getElementById('new-post-anonymous'); if(anonCb && anonCb.checked) data.anonymous = true; if(categoryId === 'useful'){ var priceVal = document.getElementById('new-post-price'); data.price = (priceVal && priceVal.value) ? parseInt(priceVal.value, 10) || 0 : 0; }
BizForum.data.createPost(data).then(function(p){ if(p && p.id){ try{ localStorage.removeItem(DRAFT_KEY); } catch(e){} if(p._moderationReject){ if(postSubmitBtn) postSubmitBtn.disabled = false; var words = (p._violationWords || []).slice(0, 5).join(', '); var modMsg = (t('toastModerationTitle') || '–ú–æ–¥–µ—Ä–∞—Ü–∏—è') + ': ' + (t('toastModerationText') || '–ü–æ—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫. –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–ª–æ–≤–∞: ') + (words || '...'); if(typeof showToast === 'function') showToast(modMsg, 'error'); else if(postFormError) postFormError.textContent = modMsg; window.__bizforum_new_post_just_submitted = true; window.location.hash = '#/drafts'; return; } if(isDraft){ if(postSubmitBtn) postSubmitBtn.disabled = false; window.__bizforum_new_post_just_submitted = true; window.location.hash = '#/drafts'; } else { window.__bizforum_new_post_just_submitted = true; window.location.hash = '#/post/' + p.id; } } else { if(postSubmitBtn) postSubmitBtn.disabled = false; window.location.hash = '#/'; } }).catch(function(err){ if(postSubmitBtn) postSubmitBtn.disabled = false; var msg = (err && err.message) || t('error'); if(msg.indexOf('moderation:') === 0){ var w = msg.split(':')[1] || ''; msg = (t('toastModerationTitle') || '–ú–æ–¥–µ—Ä–∞—Ü–∏—è') + ': ' + (t('toastModerationText') || '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–ª–æ–≤–∞: ') + w.replace(/,/g, ', '); if(typeof showToast === 'function') showToast(msg, 'error'); else if(postFormError) postFormError.textContent = msg; } else { if(postFormError) postFormError.textContent = msg; } });
}
function checkVerifiedThenCreate(){
var cfg = window.BIZFORUM_CONFIG || {};
var supabaseConfigured = !!(cfg.useSupabase && cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY);
if(supabaseConfigured){
if(!window.BizForum || !window.BizForum.auth){ if(postFormError) postFormError.textContent = t('createPostLoginRequired') || '–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç.'; return; }
window.BizForum.auth.getUser().then(function(r){
var uid = r.data && r.data.user && r.data.user.id;
if(!uid){ if(postFormError) postFormError.textContent = t('createPostLoginRequired') || '–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç.'; return; }
if(window.BizForum.isVerified){ window.BizForum.isVerified().then(function(verified){ if(!verified){ if(postFormError) postFormError.textContent = t('unverifiedHint') || '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ª–µ–Ω—Ç—É –∏ —Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'; return; } window.BizForum.getDisplayName().then(function(name){ doCreatePost(name, !!(postForm && postForm._saveAsDraft)); if(postForm) postForm._saveAsDraft = false; }); }); return; }
window.BizForum.getDisplayName().then(function(name){ doCreatePost(name, !!(postForm && postForm._saveAsDraft)); if(postForm) postForm._saveAsDraft = false; });
});
return;
}
doCreatePost((document.getElementById('new-post-author') && document.getElementById('new-post-author').value) ? document.getElementById('new-post-author').value.trim() : getAuthorName());
}
var draftBtn = document.getElementById('new-post-draft-btn'); if(draftBtn && postForm){ draftBtn.addEventListener('click', function(){ postForm._saveAsDraft = true; postForm.requestSubmit(); }); }
checkVerifiedThenCreate();
});
var feedSentinel = document.getElementById('feed-infinite-sentinel');
if(feedSentinel && typeof IntersectionObserver !== 'undefined'){ var feedIo = new IntersectionObserver(function(entries){ if(!entries[0] || !entries[0].isIntersecting) return; if(views.feed && views.feed.classList.contains('hidden')) return; if(listEl && listEl.querySelector('.feed-loading')) return; loadFeed(getSort(), true); }, { root: null, rootMargin: '200px', threshold: 0 }); feedIo.observe(feedSentinel); }
var chatTrigger = document.getElementById('header-chats-link'); var chatPanel = document.getElementById('chat-panel'); var chatPanelClose = document.getElementById('chat-panel-close'); var chatBackdrop = document.getElementById('chat-backdrop');
function closeChatPanel(){ if(unsubscribeMessages){ unsubscribeMessages(); unsubscribeMessages = null; } if(unsubscribeNotifications){ unsubscribeNotifications(); unsubscribeNotifications = null; } if(chatPanel) chatPanel.classList.add('hidden'); if(chatBackdrop){ chatBackdrop.classList.add('hidden'); chatBackdrop.setAttribute('aria-hidden','true'); } }
var currentDmUserId = null; var currentDmConversationId = null; var currentGroupConversationId = null; var currentGroupCreatedBy = null; var currentAdminConversationId = null; var currentAdminThreadConvId = null; var unsubscribeMessages = null; var unsubscribeNotifications = null;
if(chatTrigger && chatPanel){ chatTrigger.addEventListener('click', function(e){ e.preventDefault(); var isOpening = chatPanel.classList.contains('hidden'); if(isOpening){ chatPanel.classList.remove('hidden'); if(chatBackdrop){ chatBackdrop.classList.remove('hidden'); chatBackdrop.setAttribute('aria-hidden','false'); } } else { closeChatPanel(); return; } document.querySelectorAll('.chat-list-item').forEach(function(x){ x.classList.remove('active'); }); document.getElementById('chat-view-admin').classList.add('hidden'); document.getElementById('chat-view-dm').classList.add('hidden'); document.getElementById('chat-view-group').classList.add('hidden'); document.getElementById('chat-view-ai').classList.add('hidden'); loadChatFriends(); loadChatGroups(); updateCreateGroupButtonVisibility(); if(typeof refreshChatsBadge === 'function') refreshChatsBadge(); }); }
if(chatPanelClose && chatPanel){ chatPanelClose.addEventListener('click', closeChatPanel); }
if(chatBackdrop){ chatBackdrop.addEventListener('click', closeChatPanel); }
var chatList = document.getElementById('chat-panel-list'); if(chatList) chatList.addEventListener('click', function(e){ var item = e.target.closest('.chat-list-item'); if(!item) return; var chat = item.getAttribute('data-chat'); var userId = item.getAttribute('data-user-id'); document.querySelectorAll('.chat-list-item').forEach(function(x){ x.classList.remove('active'); }); item.classList.add('active'); document.getElementById('chat-view-admin').classList.add('hidden'); document.getElementById('chat-view-dm').classList.add('hidden'); document.getElementById('chat-view-group').classList.add('hidden'); document.getElementById('chat-view-ai').classList.add('hidden'); if(unsubscribeMessages){ unsubscribeMessages(); unsubscribeMessages = null; } if(unsubscribeNotifications){ unsubscribeNotifications(); unsubscribeNotifications = null; } if(chat === 'admin'){ document.getElementById('chat-view-admin').classList.remove('hidden'); loadChatAdminView(); } else if(chat === 'dm' && userId){ currentDmUserId = userId; currentDmConversationId = null; document.getElementById('chat-view-dm').classList.remove('hidden'); var dmTitle = document.getElementById('chat-dm-title'); var dmStatus = document.getElementById('chat-dm-status'); var dmMessages = document.getElementById('chat-messages'); var dmForm = document.getElementById('chat-send-form'); var dmInput = document.getElementById('chat-message-input'); if(dmTitle){ var name = (item.querySelector && item.querySelector('.chat-list-item-name')) ? item.querySelector('.chat-list-item-name').textContent.trim() : item.textContent.trim(); dmTitle.textContent = name; dmTitle.href = userId ? '#/user/' + userId : '#'; } if(dmStatus) dmStatus.textContent = ''; if(dmMessages) dmMessages.innerHTML = '<div class="chat-loading">' + t('loading') + '...</div>'; if(dmForm) dmForm.style.pointerEvents = 'none'; if(dmInput) dmInput.disabled = true; if(window.BizForum.getOrCreateDmConversation && window.BizForum.getMessages){ var myUid = window.__bizforum_user_id || null; var loadConv = window.BizForum.getOrCreateDmConversation(userId); loadConv.then(function(cid){ currentDmConversationId = cid; return window.BizForum.getMessages(cid); }).then(function(msgs){ var el = document.getElementById('chat-messages'); var form = document.getElementById('chat-send-form'); var inp = document.getElementById('chat-message-input'); var st = document.getElementById('chat-dm-status'); if(form) form.style.pointerEvents = ''; if(inp) inp.disabled = false; if(st) st.textContent = ''; if(!el) return; var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; el.innerHTML = (msgs || []).length ? (msgs || []).map(function(m){ var isMine = myUid && m.senderId === myUid; var dateStr = m.createdAt ? new Date(m.createdAt).toLocaleTimeString(loc, { hour: '2-digit', minute: '2-digit' }) : ''; return '<div class="chat-bubble' + (isMine ? ' chat-bubble-mine' : ' chat-bubble-theirs') + '"><div class="chat-bubble-body">' + escapeHtml(m.body || '') + '</div><span class="chat-bubble-time">' + dateStr + '</span></div>'; }).join('') : '<div class="chat-empty">' + (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.t ? window.BizForum.i18n.t('chatsNoMessages') : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—ã–º!') + '</div>'; el.scrollTop = el.scrollHeight; if(inp) inp.focus(); if(window.BizForum.markConversationRead) window.BizForum.markConversationRead(currentDmConversationId).then(function(){ if(typeof refreshChatsBadge === 'function') refreshChatsBadge(); loadChatFriends(); }).catch(function(){}); if(window.BizForum.subscribeToMessages && currentDmConversationId){ var subCid = currentDmConversationId; if(unsubscribeMessages) unsubscribeMessages(); unsubscribeMessages = window.BizForum.subscribeToMessages(subCid, function(){ if(currentDmConversationId !== subCid) return; window.BizForum.getMessages(subCid).then(function(nmsgs){ var nel = document.getElementById('chat-messages'); if(!nel || currentDmConversationId !== subCid) return; var nloc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; nel.innerHTML = (nmsgs || []).length ? (nmsgs || []).map(function(m){ var isMine = myUid && m.senderId === myUid; var dateStr = m.createdAt ? new Date(m.createdAt).toLocaleTimeString(nloc, { hour: '2-digit', minute: '2-digit' }) : ''; return '<div class="chat-bubble' + (isMine ? ' chat-bubble-mine' : ' chat-bubble-theirs') + '"><div class="chat-bubble-body">' + escapeHtml(m.body || '') + '</div><span class="chat-bubble-time">' + dateStr + '</span></div>'; }).join('') : '<div class="chat-empty">' + (window.BizForum.i18n && window.BizForum.i18n.t ? window.BizForum.i18n.t('chatsNoMessages') : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—ã–º!') + '</div>'; nel.scrollTop = nel.scrollHeight; }); if(typeof refreshChatsBadge === 'function') refreshChatsBadge(); }); } }).catch(function(err){ currentDmConversationId = null; var form = document.getElementById('chat-send-form'); var inp = document.getElementById('chat-message-input'); var st = document.getElementById('chat-dm-status'); var el = document.getElementById('chat-messages'); if(form) form.style.pointerEvents = 'none'; if(inp) inp.disabled = true; if(st) st.textContent = (err && err.message) || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞'; if(el) el.innerHTML = '<div class="chat-error">' + escapeHtml((err && err.message) || t('error')) + '</div>'; }); } else { var form = document.getElementById('chat-send-form'); var inp = document.getElementById('chat-message-input'); var st = document.getElementById('chat-dm-status'); var el = document.getElementById('chat-messages'); if(st) st.textContent = '–ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'; if(el) el.innerHTML = '<div class="chat-error">–ß–∞—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω (Supabase).</div>'; } } else if(chat === 'group'){ var convId = item.getAttribute('data-conversation-id'); if(convId){ currentDmConversationId = null; currentGroupConversationId = convId; document.getElementById('chat-view-group').classList.remove('hidden'); loadGroupChatView(convId, item); } } else if(chat === 'ai') document.getElementById('chat-view-ai').classList.remove('hidden'); });
function updateCreateGroupButtonVisibility(){ var btn = document.getElementById('chat-create-group-btn'); if(!btn) return; if(!window.BizForum || !window.BizForum.getSubscriptionStatus){ btn.classList.add('hidden'); return; } window.BizForum.getSubscriptionStatus().then(function(status){ if(status && status.hasSubscription){ btn.classList.remove('hidden'); } else { btn.classList.add('hidden'); } }).catch(function(){ btn.classList.add('hidden'); }); }
function loadChatGroups(){ var wrap = document.getElementById('chat-list-groups'); if(!wrap || !window.BizForum.getGroupConversationsWithPreview) return; window.BizForum.getGroupConversationsWithPreview().then(function(list){ var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; wrap.innerHTML = list.length ? list.map(function(g){ var prev = g.lastBody ? '<span class="chat-list-item-preview">' + escapeHtml(String(g.lastBody).slice(0, 45) + (g.lastBody.length > 45 ? '‚Ä¶' : '')) + '</span>' : ''; var time = g.lastCreatedAt ? '<span class="chat-list-item-time">' + (function(d){ var now = new Date(); var diff = now - d; if(diff < 60000) return '—Å–µ–π—á–∞—Å'; if(diff < 3600000) return Math.floor(diff/60000) + ' –º–∏–Ω'; if(diff < 86400000) return Math.floor(diff/3600000) + ' —á'; return d.toLocaleDateString(loc); }(new Date(g.lastCreatedAt))) + '</span>' : ''; var badge = (g.unreadCount > 0) ? '<span class="chat-list-badge">' + (g.unreadCount > 99 ? '99+' : g.unreadCount) + '</span>' : ''; return '<div class="chat-list-item" data-chat="group" data-conversation-id="' + escapeHtml(g.conversationId) + '"><div class="chat-list-item-info"><span class="chat-list-item-name">' + escapeHtml(g.title || '‚Äî') + '</span>' + prev + '</div>' + time + badge + '</div>'; }).join('') : ''; }).catch(function(){ wrap.innerHTML = ''; }); }
function renderGroupChatMessages(el, msgs, myUid, loc){ if(!el) return; if(!msgs || !msgs.length){ el.innerHTML = '<div class="chat-empty">' + t('chatsNoMessages') + '</div>'; el.scrollTop = 0; return; } var senderIds = []; msgs.forEach(function(m){ if(m.senderId && senderIds.indexOf(m.senderId) < 0) senderIds.push(m.senderId); }); var doRender = function(nameMap){ var youLabel = t('chatsYou') || '–í—ã'; var html = msgs.map(function(m){ var isMine = myUid && m.senderId === myUid; var senderName = isMine ? youLabel : (nameMap[m.senderId] || '‚Äî'); var dateStr = m.createdAt ? new Date(m.createdAt).toLocaleTimeString(loc, { hour: '2-digit', minute: '2-digit' }) : ''; return '<div class="chat-group-msg"><span class="chat-group-msg-sender">' + escapeHtml(senderName) + '</span><div class="chat-bubble' + (isMine ? ' chat-bubble-mine' : ' chat-bubble-theirs') + '"><div class="chat-bubble-body">' + escapeHtml(m.body || '') + '</div><span class="chat-bubble-time">' + dateStr + '</span></div></div>'; }).join(''); el.innerHTML = html; el.scrollTop = el.scrollHeight; }; if(senderIds.length && window.BizForum.friendsGetProfilesByIds){ window.BizForum.friendsGetProfilesByIds(senderIds).then(function(profiles){ var nameMap = {}; (profiles || []).forEach(function(p){ nameMap[p.id] = ((p.first_name || '') + ' ' + (p.last_name || '')).trim() || p.company || '‚Äî'; }); doRender(nameMap); }).catch(function(){ doRender({}); }); } else { doRender({}); } }
function loadGroupChatView(convId, item){ var titleEl = document.getElementById('chat-group-title'); var msgEl = document.getElementById('chat-group-messages'); var form = document.getElementById('chat-group-send-form'); var inp = document.getElementById('chat-group-message-input'); var myUid = window.__bizforum_user_id; if(form) form.style.pointerEvents = 'none'; if(inp) inp.disabled = true; if(msgEl) msgEl.innerHTML = '<div class="chat-loading">' + t('loading') + '...</div>'; if(window.BizForum.getConversationInfo) window.BizForum.getConversationInfo(convId).then(function(info){ currentGroupCreatedBy = info.createdBy; if(titleEl) titleEl.textContent = info.title || '‚Äî'; var reqBtn = document.getElementById('chat-group-requests-btn'); var reqPanel = document.getElementById('chat-group-join-requests-panel'); if(reqBtn) reqBtn.classList.toggle('hidden', myUid !== info.createdBy); if(reqPanel) reqPanel.classList.add('hidden'); }); if(window.BizForum.getMessages){ window.BizForum.getMessages(convId).then(function(msgs){ var el = document.getElementById('chat-group-messages'); if(!el || currentGroupConversationId !== convId) return; var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; renderGroupChatMessages(el, msgs || [], myUid, loc); if(form) form.style.pointerEvents = ''; if(inp){ inp.disabled = false; inp.focus(); } if(window.BizForum.markConversationRead) window.BizForum.markConversationRead(convId).then(function(){ if(typeof refreshChatsBadge === 'function') refreshChatsBadge(); loadChatGroups(); }).catch(function(){}); if(window.BizForum.subscribeToMessages && currentGroupConversationId === convId){ var subCid = convId; if(unsubscribeMessages) unsubscribeMessages(); unsubscribeMessages = window.BizForum.subscribeToMessages(subCid, function(){ if(currentGroupConversationId !== subCid) return; window.BizForum.getMessages(subCid).then(function(nmsgs){ var nel = document.getElementById('chat-group-messages'); if(!nel || currentGroupConversationId !== subCid) return; var nloc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; renderGroupChatMessages(nel, nmsgs || [], myUid, nloc); if(typeof refreshChatsBadge === 'function') refreshChatsBadge(); }); }); } }); } }
function renderGroupJoinRequests(convId){ var listEl = document.getElementById('chat-group-join-requests-list'); if(!listEl || !window.BizForum.getGroupJoinRequests || !window.BizForum.friendsGetProfilesByIds) return; window.BizForum.getGroupJoinRequests(convId).then(function(requests){ var pending = requests || []; if(!pending.length){ listEl.innerHTML = '<p class="muted">' + (t('groupJoinRequestsNone') || '–ù–µ—Ç –∑–∞—è–≤–æ–∫.') + '</p>'; return; } var userIds = pending.map(function(r){ return r.userId || r.user_id; }); window.BizForum.friendsGetProfilesByIds(userIds).then(function(profiles){ var name = function(p){ return ((p.first_name || '') + ' ' + (p.last_name || '')).trim() || p.company || '‚Äî'; }; var profileMap = {}; (profiles || []).forEach(function(p){ profileMap[p.id] = p; }); listEl.innerHTML = pending.map(function(r){ var uid = r.userId || r.user_id; var p = profileMap[uid]; var n = p ? name(p) : (r.userName || uid); return '<div class="chat-join-request-item"><a href="#/user/' + escapeHtml(uid) + '">' + (p ? avatarHtml(p.avatar_url || '', n) : '') + ' ' + escapeHtml(n) + '</a><div class="chat-join-request-actions"><button type="button" class="chat-join-request-accept" data-user-id="' + escapeHtml(uid) + '" title="–ü—Ä–∏–Ω—è—Ç—å">‚úì</button><button type="button" class="chat-join-request-reject" data-user-id="' + escapeHtml(uid) + '" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å">‚úï</button></div></div>'; }).join(''); listEl.querySelectorAll('.chat-join-request-accept').forEach(function(btn){ btn.onclick = function(){ var uid = btn.getAttribute('data-user-id'); if(!uid || !window.BizForum.acceptGroupJoinRequest) return; window.BizForum.acceptGroupJoinRequest(convId, uid).then(function(){ renderGroupJoinRequests(convId); if(typeof renderGroupMembers === 'function') renderGroupMembers(convId); }).catch(function(err){ alert((err && err.message) || t('error')); }); }; }); listEl.querySelectorAll('.chat-join-request-reject').forEach(function(btn){ btn.onclick = function(){ var uid = btn.getAttribute('data-user-id'); if(!uid || !window.BizForum.rejectGroupJoinRequest) return; window.BizForum.rejectGroupJoinRequest(convId, uid).then(function(){ renderGroupJoinRequests(convId); }).catch(function(err){ alert((err && err.message) || t('error')); }); }; }); }); }); }
function renderGroupMembers(convId){ var listEl = document.getElementById('chat-group-members-list'); if(!listEl || !window.BizForum.getGroupParticipants || !window.BizForum.friendsGetProfilesByIds) return; window.BizForum.getGroupParticipants(convId).then(function(ids){ if(!ids.length){ listEl.innerHTML = ''; return; } window.BizForum.friendsGetProfilesByIds(ids).then(function(profiles){ var myUid = window.__bizforum_user_id; var canRemove = currentGroupCreatedBy === myUid; var name = function(p){ return ((p.first_name || '') + ' ' + (p.last_name || '')).trim() || p.company || '‚Äî'; }; listEl.innerHTML = profiles.map(function(p){ var rm = canRemove && p.id !== myUid ? ' <button type="button" class="chat-remove-member-btn" data-id="' + escapeHtml(p.id) + '">' + t('chatsRemoveMember') + '</button>' : ''; return '<div class="chat-member-item"><a href="#/user/' + escapeHtml(p.id) + '">' + avatarHtml(p.avatar_url || '', name(p)) + ' ' + escapeHtml(name(p)) + '</a>' + rm + '</div>'; }).join(''); listEl.querySelectorAll('.chat-remove-member-btn').forEach(function(btn){ btn.onclick = function(){ var uid = btn.getAttribute('data-id'); if(!uid || !window.BizForum.removeParticipantFromGroup) return; if(!confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ —á–∞—Ç–∞?')) return; window.BizForum.removeParticipantFromGroup(convId, uid).then(function(){ renderGroupMembers(convId); loadChatGroups(); }).catch(function(err){ alert((err && err.message) || t('error')); }); }; }); }); }); }
function loadChatFriends(){ var friendsWrap = document.getElementById('chat-list-friends'); if(!friendsWrap) return; var renderFriendItem = function(p){ var n = (p.first_name !== undefined) ? (((p.first_name || '') + ' ' + (p.last_name || '')).trim() || p.company || '‚Äî') : (p.otherName || p.name || '‚Äî'); var uid = p.id || p.otherUserId; var av = avatarHtml((p.avatar_url || ''), n); var conv = p.conversationId ? ' data-conversation-id="' + escapeHtml(p.conversationId) + '"' : ''; var prev = p.lastBody ? '<span class="chat-list-item-preview">' + escapeHtml(String(p.lastBody).slice(0, 45) + (p.lastBody.length > 45 ? '‚Ä¶' : '')) + '</span>' : ''; var time = p.lastCreatedAt ? '<span class="chat-list-item-time">' + (function(d){ var now = new Date(); var diff = now - d; if(diff < 60000) return '—Å–µ–π—á–∞—Å'; if(diff < 3600000) return Math.floor(diff/60000) + ' –º–∏–Ω'; if(diff < 86400000) return Math.floor(diff/3600000) + ' —á'; return d.toLocaleDateString(); }(new Date(p.lastCreatedAt))) + '</span>' : ''; var badge = (p.unreadCount > 0) ? '<span class="chat-list-badge">' + (p.unreadCount > 99 ? '99+' : p.unreadCount) + '</span>' : ''; return '<div class="chat-list-item" data-chat="dm" data-user-id="' + escapeHtml(uid) + '"' + conv + '>' + av + '<div class="chat-list-item-info"><span class="chat-list-item-name">' + escapeHtml(n) + '</span>' + prev + '</div>' + time + badge + '</div>'; }; if(!window.BizForum.friendsListAccepted || !window.BizForum.friendsGetProfilesByIds){ friendsWrap.innerHTML = '<p class="muted" style="font-size:.85rem;padding:8px 16px;">' + t('chatsNoFriends') + '</p>'; return; } window.BizForum.friendsListAccepted().then(function(ids){ if(!ids || !ids.length){ friendsWrap.innerHTML = '<p class="muted" style="font-size:.85rem;padding:8px 16px;">' + t('chatsNoFriends') + '</p>'; return; } window.BizForum.friendsGetProfilesByIds(ids).then(function(profiles){ var previewMap = {}; var addPreview = function(previews){ (previews || []).forEach(function(r){ previewMap[r.otherUserId] = { conversationId: r.conversationId, lastBody: r.lastBody, lastCreatedAt: r.lastCreatedAt, unreadCount: r.unreadCount || 0 }; }); }; var done = function(){ var list = profiles.map(function(p){ var pr = previewMap[p.id] || {}; return { id: p.id, first_name: p.first_name, last_name: p.last_name, company: p.company, avatar_url: p.avatar_url, conversationId: pr.conversationId, lastBody: pr.lastBody, lastCreatedAt: pr.lastCreatedAt, unreadCount: pr.unreadCount || 0 }; }); list.sort(function(a,b){ var ta = a.lastCreatedAt ? new Date(a.lastCreatedAt).getTime() : 0; var tb = b.lastCreatedAt ? new Date(b.lastCreatedAt).getTime() : 0; return tb - ta; }); friendsWrap.innerHTML = list.length ? list.map(function(p){ return renderFriendItem(p); }).join('') : '<p class="muted" style="font-size:.85rem;padding:8px 16px;">' + t('chatsNoFriends') + '</p>'; }; if(window.BizForum.getDmConversationsWithPreview){ window.BizForum.getDmConversationsWithPreview().then(function(previews){ addPreview(previews); done(); }).catch(done); } else { done(); } }); }).catch(function(){ friendsWrap.innerHTML = '<p class="muted" style="font-size:.85rem;padding:8px 16px;">' + t('chatsNoFriends') + '</p>'; }); }
var adminNotesForm = document.getElementById('chat-admin-notes-form'); if(adminNotesForm) adminNotesForm.addEventListener('submit', function(e){ e.preventDefault(); var input = document.getElementById('chat-admin-notes-input'); var text = (input && input.value) ? input.value.trim() : ''; if(!text) return; if(!window.BizForum.createOrGetAdminConversation || !window.BizForum.sendMessage){ alert(t('error') || '–ß–∞—Ç —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.'); return; } var convId = currentAdminConversationId; var doSend = function(cid){ return window.BizForum.sendMessage(cid, text).then(function(){ if(input) input.value = ''; currentAdminConversationId = cid; return window.BizForum.getMessages(cid); }); }; (convId ? doSend(convId) : window.BizForum.createOrGetAdminConversation().then(function(cid){ currentAdminConversationId = cid; return doSend(cid); })).then(function(msgs){ var listEl = document.getElementById('chat-admin-notes-list'); if(!listEl) return; var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; var myUid = window.__bizforum_user_id; listEl.innerHTML = (msgs || []).length ? (msgs || []).map(function(m){ var isMine = myUid && m.senderId === myUid; var d = m.createdAt ? new Date(m.createdAt).toLocaleString(loc) : ''; return '<div class="chat-note-item' + (isMine ? ' chat-note-mine' : '') + '">' + escapeHtml(d) + ' ‚Äî ' + escapeHtml(m.body || '') + '</div>'; }).join('') : ''; listEl.scrollTop = listEl.scrollHeight; }).catch(function(err){ alert((err && err.message) || t('error')); }); });
function notificationLabel(n){ var key = 'notification_' + n.type; var label = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.t) ? window.BizForum.i18n.t(key) : n.type; if(n.type === 'friend_request' && n.payload && n.payload.from_user_id) label = label; return label; }
function refreshChatNotifications(){ var listEl = document.getElementById('chat-notifications-list'); if(!listEl || !window.BizForum.getNotifications) return; window.BizForum.getNotifications(50).then(function(rows){ var unread = 0; listEl.innerHTML = rows.length ? rows.map(function(n){ if(!n.read) unread++; var label = (function(){ var k = 'notification_' + n.type; return (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.t) ? window.BizForum.i18n.t(k) : n.type; })(); var dateStr = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? new Date(n.created_at).toLocaleString(window.BizForum.i18n.getLocale()) : new Date(n.created_at).toLocaleString(); var cls = n.read ? 'chat-notification-item' : 'chat-notification-item unread'; return '<div class="' + cls + '" data-id="' + n.id + '">' + escapeHtml(label) + '<br><span class="muted" style="font-size:.8rem">' + escapeHtml(dateStr) + '</span></div>'; }).join('') : '<p class="muted">' + t('noComments') + '</p>'; listEl.querySelectorAll('.chat-notification-item').forEach(function(el){ el.addEventListener('click', function(){ var id = this.getAttribute('data-id'); if(id && window.BizForum.markNotificationRead){ var elItem = this; window.BizForum.markNotificationRead(id).then(function(){ elItem.classList.remove('unread'); }); } }); }); var badge = document.getElementById('chat-admin-badge'); if(badge){ if(unread > 0){ badge.textContent = unread > 99 ? '99+' : unread; badge.classList.remove('hidden'); } else badge.classList.add('hidden'); } }); }
function refreshChatsBadge(){ if(!window.BizForum.getTotalUnreadChatCount) return; window.BizForum.getTotalUnreadChatCount().then(function(count){ var badge = document.getElementById('chats-badge'); if(!badge) return; if(count > 0){ badge.textContent = count > 99 ? '99+' : count; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }); }
function loadChatAdminView(){
  var forUser = document.getElementById('chat-admin-for-user');
  var forAdmin = document.getElementById('chat-admin-for-admin');
  var notesListEl = document.getElementById('chat-admin-notes-list');
  window.BizForum.isAdmin().then(function(isAdmin){
    if(isAdmin && forAdmin){
      forUser.classList.add('hidden');
      forAdmin.classList.remove('hidden');
      if(window.BizForum.getAdminConversationsList){
        window.BizForum.getAdminConversationsList().then(function(list){
          var threadsEl = document.getElementById('chat-admin-threads-list');
          if(!threadsEl) return;
          var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU';
          var html = list.length ? list.map(function(t){
            var prev = t.lastBody ? escapeHtml(String(t.lastBody).slice(0, 40) + (t.lastBody.length > 40 ? '...' : '')) : '';
            var time = t.lastCreatedAt ? new Date(t.lastCreatedAt).toLocaleString(loc) : '';
            var name = escapeHtml(t.userName || 'User');
            return '<div class="chat-admin-thread-item" data-conv-id="' + escapeHtml(t.conversationId) + '" data-user-id="' + escapeHtml(t.userId) + '" data-user-name="' + escapeHtml(t.userName || '-') + '"><span class="chat-admin-thread-name">' + name + '</span><span class="chat-admin-thread-preview muted">' + prev + '</span><span class="chat-admin-thread-time muted">' + escapeHtml(time) + '</span></div>';
          }).join('') : '<p class="muted" style="padding:12px">No messages</p>';
          threadsEl.innerHTML = html;
          threadsEl.querySelectorAll('.chat-admin-thread-item').forEach(function(el){
            el.onclick = function(){
              var cid = el.getAttribute('data-conv-id');
              var uname = el.getAttribute('data-user-name');
              currentAdminThreadConvId = cid;
              document.getElementById('chat-admin-thread-view').classList.remove('hidden');
              var nameEl = document.getElementById('chat-admin-thread-user-name');
              if(nameEl) nameEl.textContent = uname || '-';
              loadAdminThreadMessages(cid);
            };
          });
        });
      }
    } else if(forUser){
      forAdmin.classList.add('hidden');
      forUser.classList.remove('hidden');
      if(window.BizForum.createOrGetAdminConversation && window.BizForum.getMessages){
        window.BizForum.createOrGetAdminConversation().then(function(cid){
          currentAdminConversationId = cid;
          return window.BizForum.getMessages(cid);
        }).then(function(msgs){
          if(!notesListEl) return;
          var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU';
          var myUid = window.__bizforum_user_id;
          notesListEl.innerHTML = (msgs || []).length ? (msgs || []).map(function(m){
            var isMine = myUid && m.senderId === myUid;
            var d = m.createdAt ? new Date(m.createdAt).toLocaleString(loc) : '';
            return '<div class="chat-note-item' + (isMine ? ' chat-note-mine' : '') + '">' + escapeHtml(d) + ' - ' + escapeHtml(m.body || '') + '</div>';
          }).join('') : '';
          notesListEl.scrollTop = notesListEl.scrollHeight;
        });
      }
    }
    refreshChatNotifications();
    var uid = window.__bizforum_user_id;
    if(uid && window.BizForum.subscribeToNotifications){
      if(unsubscribeNotifications) unsubscribeNotifications();
      unsubscribeNotifications = window.BizForum.subscribeToNotifications(uid, refreshChatNotifications);
    }
  });
}
function loadAdminThreadMessages(convId){ var msgEl = document.getElementById('chat-admin-thread-messages'); if(!msgEl) return; msgEl.innerHTML = '<div class="chat-loading">' + t('loading') + '...</div>'; if(!window.BizForum.adminGetMessages){ msgEl.innerHTML = '<div class="chat-error">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞</div>'; return; } window.BizForum.adminGetMessages(convId).then(function(msgs){ var loc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; var myUid = window.__bizforum_user_id; msgEl.innerHTML = (msgs || []).length ? (msgs || []).map(function(m){ var isMine = myUid && m.senderId === myUid; var dateStr = m.createdAt ? new Date(m.createdAt).toLocaleTimeString(loc, { hour: '2-digit', minute: '2-digit' }) : ''; return '<div class="chat-bubble' + (isMine ? ' chat-bubble-mine' : ' chat-bubble-theirs') + '"><div class="chat-bubble-body">' + escapeHtml(m.body || '') + '</div><span class="chat-bubble-time">' + dateStr + '</span></div>'; }).join('') : '<div class="chat-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'; msgEl.scrollTop = msgEl.scrollHeight; }); }
var chatSendForm = document.getElementById('chat-send-form'); if(chatSendForm) chatSendForm.addEventListener('submit', function(e){ e.preventDefault(); if(!currentDmConversationId || !window.BizForum.sendMessage) return; var input = document.getElementById('chat-message-input'); var body = (input && input.value) ? input.value.trim() : ''; if(!body) return; var myUid = window.__bizforum_user_id || null; window.BizForum.sendMessage(currentDmConversationId, body).then(function(sent){ if(input) input.value = ''; var el = document.getElementById('chat-messages'); var loc2 = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; if(el && sent && sent.body){ var dateStr = sent.createdAt ? new Date(sent.createdAt).toLocaleTimeString(loc2, { hour: '2-digit', minute: '2-digit' }) : ''; var bubble = '<div class="chat-bubble chat-bubble-mine"><div class="chat-bubble-body">' + escapeHtml(sent.body) + '</div><span class="chat-bubble-time">' + dateStr + '</span></div>'; var empty = el.querySelector('.chat-empty'); if(empty) empty.remove(); el.insertAdjacentHTML('beforeend', bubble); el.scrollTop = el.scrollHeight; } if(input) input.focus(); setTimeout(function(){ if(!currentDmConversationId) return; window.BizForum.getMessages(currentDmConversationId).then(function(msgs){ var nel = document.getElementById('chat-messages'); if(!nel) return; var nloc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; nel.innerHTML = (msgs || []).map(function(m){ var isMine = myUid && m.senderId === myUid; var dateStr = m.createdAt ? new Date(m.createdAt).toLocaleTimeString(nloc, { hour: '2-digit', minute: '2-digit' }) : ''; return '<div class="chat-bubble' + (isMine ? ' chat-bubble-mine' : ' chat-bubble-theirs') + '"><div class="chat-bubble-body">' + escapeHtml(m.body || '') + '</div><span class="chat-bubble-time">' + dateStr + '</span></div>'; }).join('') || '<div class="chat-empty">' + (window.BizForum.i18n && window.BizForum.i18n.t ? window.BizForum.i18n.t('chatsNoMessages') : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π') + '</div>'; nel.scrollTop = nel.scrollHeight; }); }, 400); }).catch(function(err){ alert((err && err.message) || t('error')); }); });
var chatGroupSendForm = document.getElementById('chat-group-send-form'); if(chatGroupSendForm) chatGroupSendForm.addEventListener('submit', function(e){ e.preventDefault(); if(!currentGroupConversationId || !window.BizForum.sendMessage) return; var inp = document.getElementById('chat-group-message-input'); var body = (inp && inp.value) ? inp.value.trim() : ''; if(!body) return; var myUid = window.__bizforum_user_id || null; window.BizForum.sendMessage(currentGroupConversationId, body).then(function(sent){ if(inp) inp.value = ''; var el = document.getElementById('chat-group-messages'); var loc2 = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; if(el && sent && sent.body){ var dateStr = sent.createdAt ? new Date(sent.createdAt).toLocaleTimeString(loc2, { hour: '2-digit', minute: '2-digit' }) : ''; var youLabel = t('chatsYou') || '–í—ã'; var bubble = '<div class="chat-group-msg"><span class="chat-group-msg-sender">' + escapeHtml(youLabel) + '</span><div class="chat-bubble chat-bubble-mine"><div class="chat-bubble-body">' + escapeHtml(sent.body) + '</div><span class="chat-bubble-time">' + dateStr + '</span></div></div>'; var empty = el.querySelector('.chat-empty'); if(empty) empty.remove(); el.insertAdjacentHTML('beforeend', bubble); el.scrollTop = el.scrollHeight; } if(inp) inp.focus(); setTimeout(function(){ if(!currentGroupConversationId) return; window.BizForum.getMessages(currentGroupConversationId).then(function(msgs){ var nel = document.getElementById('chat-group-messages'); if(!nel) return; var nloc = (window.BizForum && window.BizForum.i18n && window.BizForum.i18n.getLocale) ? window.BizForum.i18n.getLocale() : 'ru-RU'; renderGroupChatMessages(nel, msgs || [], myUid, nloc); }); }, 400); }).catch(function(err){ alert((err && err.message) || t('error')); }); });
var chatAdminBackBtn = document.getElementById('chat-admin-back-btn'); if(chatAdminBackBtn){ chatAdminBackBtn.addEventListener('click', function(){ document.getElementById('chat-admin-thread-view').classList.add('hidden'); currentAdminThreadConvId = null; }); }
var chatAdminReplyForm = document.getElementById('chat-admin-reply-form'); if(chatAdminReplyForm){ chatAdminReplyForm.addEventListener('submit', function(e){ e.preventDefault(); var inp = document.getElementById('chat-admin-reply-input'); var body = (inp && inp.value) ? inp.value.trim() : ''; if(!body || !currentAdminThreadConvId || !window.BizForum.adminSendMessage) return; window.BizForum.adminSendMessage(currentAdminThreadConvId, body).then(function(){ if(inp) inp.value = ''; loadAdminThreadMessages(currentAdminThreadConvId); }).catch(function(err){ alert((err && err.message) || t('error')); }); }); }
var chatGroupMembersBtn = document.getElementById('chat-group-members-btn'); var chatGroupMembersPanel = document.getElementById('chat-group-members-panel'); var chatGroupRequestsBtn = document.getElementById('chat-group-requests-btn'); var chatGroupJoinRequestsPanel = document.getElementById('chat-group-join-requests-panel'); if(chatGroupMembersBtn && chatGroupMembersPanel){ chatGroupMembersBtn.addEventListener('click', function(){ chatGroupMembersPanel.classList.toggle('hidden'); if(chatGroupJoinRequestsPanel) chatGroupJoinRequestsPanel.classList.add('hidden'); if(!chatGroupMembersPanel.classList.contains('hidden') && currentGroupConversationId) renderGroupMembers(currentGroupConversationId); }); } if(chatGroupRequestsBtn && chatGroupJoinRequestsPanel){ chatGroupRequestsBtn.addEventListener('click', function(){ chatGroupJoinRequestsPanel.classList.toggle('hidden'); if(chatGroupMembersPanel) chatGroupMembersPanel.classList.add('hidden'); if(!chatGroupJoinRequestsPanel.classList.contains('hidden') && currentGroupConversationId) renderGroupJoinRequests(currentGroupConversationId); }); }
var chatCreateGroupBtn = document.getElementById('chat-create-group-btn'); var chatCreateGroupModal = document.getElementById('chat-create-group-modal'); var chatCreateGroupClose = document.getElementById('chat-create-group-close'); var chatCreateGroupForm = document.getElementById('chat-create-group-form'); var chatCreateGroupProfiles = []; function renderCreateGroupFriends(profiles, query){ var friendsEl = document.getElementById('chat-create-group-friends'); var searchInp = document.getElementById('chat-create-group-search'); var q = (searchInp && searchInp.value) ? String(searchInp.value).trim().toLowerCase() : (query || ''); var name = function(p){ return ((p.first_name || '') + ' ' + (p.last_name || '')).trim() || p.company || '‚Äî'; }; var filtered = q ? profiles.filter(function(p){ var n = (name(p) + ' ' + (p.company || '')).toLowerCase(); return n.indexOf(q) >= 0; }) : profiles; friendsEl.innerHTML = filtered.length ? filtered.map(function(p){ var n = name(p); var comp = (p.company || ''); var av = avatarHtml(p.avatar_url || '', n); return '<label class="chat-create-group-friend"><input type="checkbox" value="' + escapeHtml(p.id) + '"><span class="chat-create-group-friend-avatar">' + av + '</span><span class="chat-create-group-friend-info"><span class="chat-create-group-friend-name">' + escapeHtml(n) + '</span>' + (comp ? '<span class="chat-create-group-friend-company">' + escapeHtml(comp) + '</span>' : '') + '</span><span class="chat-create-group-friend-check"></span></label>'; }).join('') : '<p class="chat-create-group-no-results">' + (t('chatsNoResults') || '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ') + '</p>'; } if(chatCreateGroupBtn && chatCreateGroupModal){ chatCreateGroupBtn.addEventListener('click', function(e){ e.stopPropagation(); chatCreateGroupModal.classList.remove('hidden'); chatCreateGroupProfiles = []; var friendsEl = document.getElementById('chat-create-group-friends'); var titleInp = document.getElementById('chat-group-title-input'); var searchInp = document.getElementById('chat-create-group-search'); var descInp = document.getElementById('chat-group-desc-input'); var isOpenCb = document.getElementById('chat-group-is-open'); var catSel = document.getElementById('chat-group-category-input'); if(titleInp) titleInp.value = ''; if(searchInp) searchInp.value = ''; if(descInp) descInp.value = ''; if(isOpenCb) isOpenCb.checked = false; if(catSel){ catSel.innerHTML = '<option value="">‚Äî</option>'; if(BizForum.data && BizForum.data.getCategories){ BizForum.data.getCategories().then(function(cats){ if(!catSel || !cats || !cats.length) return; cats.forEach(function(c){ var opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name || c.id; catSel.appendChild(opt); }); }); } } if(!window.BizForum.friendsListAccepted || !window.BizForum.friendsGetProfilesByIds){ friendsEl.innerHTML = '<p class="muted">' + t('chatsNoFriends') + '</p>'; return; } window.BizForum.friendsListAccepted().then(function(ids){ if(!ids || !ids.length){ friendsEl.innerHTML = '<p class="muted">' + t('chatsNoFriends') + '</p>'; return; } window.BizForum.friendsGetProfilesByIds(ids).then(function(profiles){ chatCreateGroupProfiles = profiles; renderCreateGroupFriends(profiles); }); }).catch(function(){ friendsEl.innerHTML = '<p class="muted">' + t('chatsNoFriends') + '</p>'; }); }); } var chatCreateGroupSearch = document.getElementById('chat-create-group-search'); if(chatCreateGroupSearch){ chatCreateGroupSearch.addEventListener('input', function(){ if(chatCreateGroupProfiles.length) renderCreateGroupFriends(chatCreateGroupProfiles); }); } if(chatCreateGroupClose && chatCreateGroupModal) chatCreateGroupClose.addEventListener('click', function(){ chatCreateGroupModal.classList.add('hidden'); }); if(chatCreateGroupModal) chatCreateGroupModal.addEventListener('click', function(e){ if(e.target === this) chatCreateGroupModal.classList.add('hidden'); }); if(chatCreateGroupForm){ chatCreateGroupForm.addEventListener('submit', function(e){ e.preventDefault(); var titleInp = document.getElementById('chat-group-title-input'); var friendsEl = document.getElementById('chat-create-group-friends'); var descInp = document.getElementById('chat-group-desc-input'); var isOpenCb = document.getElementById('chat-group-is-open'); var catSel = document.getElementById('chat-group-category-input'); var title = (titleInp && titleInp.value) ? titleInp.value.trim() : ''; if(!title){ alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞'); return; } var ids = []; if(friendsEl) friendsEl.querySelectorAll('input[type=checkbox]:checked').forEach(function(cb){ if(cb.value) ids.push(cb.value); }); if(!ids.length){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –¥—Ä—É–≥–∞'); return; } var opts = {}; if(descInp && descInp.value.trim()) opts.description = descInp.value.trim(); if(isOpenCb && isOpenCb.checked) opts.is_open = true; if(catSel && catSel.value) opts.category_id = catSel.value; if(!window.BizForum.createGroupChat){ alert(t('error')); return; } window.BizForum.createGroupChat(title, ids, opts).then(function(convId){ chatCreateGroupModal.classList.add('hidden'); loadChatGroups(); document.querySelectorAll('.chat-list-item').forEach(function(x){ x.classList.remove('active'); }); var item = document.querySelector('.chat-list-item[data-chat="group"][data-conversation-id="' + convId + '"]'); if(item){ item.classList.add('active'); document.getElementById('chat-view-admin').classList.add('hidden'); document.getElementById('chat-view-dm').classList.add('hidden'); document.getElementById('chat-view-ai').classList.add('hidden'); document.getElementById('chat-view-group').classList.remove('hidden'); currentGroupConversationId = convId; loadGroupChatView(convId, item); } }).catch(function(err){ alert((err && err.message) || t('error')); }); }); }
var catSentinel = document.getElementById('category-infinite-sentinel');
if(catSentinel && typeof IntersectionObserver !== 'undefined'){ var catIo = new IntersectionObserver(function(entries){ if(!entries[0] || !entries[0].isIntersecting) return; if(views.category && views.category.classList.contains('hidden')) return; loadCategoryFeed(currentCategoryId, getSortCat(), true); }, { root: null, rootMargin: '200px', threshold: 0 }); catIo.observe(catSentinel); }
var burger = document.getElementById('burger'); if(burger) burger.addEventListener('click', function(){ var sb = document.getElementById('sidebar'); var ov = document.getElementById('sidebar-overlay'); if(sb) sb.classList.toggle('open'); if(ov) ov.classList.toggle('visible'); });
var overlay = document.getElementById('sidebar-overlay'); if(overlay) overlay.addEventListener('click', function(){ var sb = document.getElementById('sidebar'); if(sb) sb.classList.remove('open'); this.classList.remove('visible'); });
document.addEventListener('click', function(e){ var link = e.target.closest('a[href^="#"]'); if(!link) return; var href = link.getAttribute('href') || ''; if(href && (href === '#' || href === '#/')){ e.preventDefault(); window.location.hash = '#/'; return; } if(href && href.indexOf('#/') === 0){ e.preventDefault(); window.location.hash = href; } });
document.querySelectorAll('.admin-chat-link').forEach(function(link){ link.addEventListener('click', function(e){ e.preventDefault(); var panel = document.getElementById('chat-panel'); var backdrop = document.getElementById('chat-backdrop'); if(panel){ panel.classList.remove('hidden'); } if(backdrop){ backdrop.classList.remove('hidden'); backdrop.setAttribute('aria-hidden','false'); } document.querySelectorAll('.chat-list-item').forEach(function(x){ x.classList.remove('active'); }); var adminItem = document.getElementById('chat-item-admin'); if(adminItem){ adminItem.classList.add('active'); document.getElementById('chat-view-admin').classList.remove('hidden'); document.getElementById('chat-view-dm').classList.add('hidden'); document.getElementById('chat-view-group').classList.add('hidden'); document.getElementById('chat-view-ai').classList.add('hidden'); loadChatAdminView(); loadChatFriends(); loadChatGroups(); updateCreateGroupButtonVisibility(); } }); });
var adminDropdownBtn = document.getElementById('admin-dropdown-btn'); var adminDropdown = document.getElementById('admin-dropdown'); if(adminDropdownBtn && adminDropdown){ adminDropdownBtn.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); var isOpen = adminDropdown.classList.toggle('open'); adminDropdownBtn.setAttribute('aria-expanded', isOpen); if(adminDropdown) adminDropdown.setAttribute('aria-hidden', !isOpen); }); document.addEventListener('click', function(ev){ if(!ev.target.closest('.admin-dropdown-wrap')){ adminDropdown.classList.remove('open'); if(adminDropdownBtn) adminDropdownBtn.setAttribute('aria-expanded', 'false'); if(adminDropdown) adminDropdown.setAttribute('aria-hidden', 'true'); } else if(ev.target.closest('a.admin-dropdown-item')){ adminDropdown.classList.remove('open'); if(adminDropdownBtn) adminDropdownBtn.setAttribute('aria-expanded', 'false'); if(adminDropdown) adminDropdown.setAttribute('aria-hidden', 'true'); } }); } var adminToggle = document.getElementById('admin-toggle'); if(adminToggle){ function syncAdminToggleLabel(){ adminToggle.textContent = adminModeOn ? (t('adminModeOff') || 'Admin off') : ('–†–µ–∂–∏–º: –≤—ã–∫–ª'); adminToggle.classList.toggle('active', adminModeOn); } syncAdminToggleLabel(); adminToggle.addEventListener('click', function(){ var wasOn = adminModeOn; adminModeOn = !adminModeOn; syncAdminToggleLabel(); if(wasOn && !adminModeOn){ var h = (window.location.hash || '#/').slice(1).replace(/^\/+|\/+$/g, ''); var p0 = h ? h.split('/')[0] : ''; if(p0 === 'admin'){ window.location.hash = '#/'; } var dd = document.getElementById('admin-dropdown'); if(dd) dd.classList.remove('open'); var ab = document.getElementById('admin-dropdown-btn'); if(ab) ab.setAttribute('aria-expanded', 'false'); } var bar = document.getElementById('post-admin-bar'); if(bar && !currentPostId) bar.classList.add('hidden'); if(currentPostId && commentsListEl) loadAndRenderComments(); if(currentPostId && document.getElementById('view-post') && !document.getElementById('view-post').classList.contains('hidden')) loadPost(currentPostId); if(!wasOn || adminModeOn){ var dd = document.getElementById('admin-dropdown'); if(dd) dd.classList.remove('open'); var ab = document.getElementById('admin-dropdown-btn'); if(ab) ab.setAttribute('aria-expanded', 'false'); } }); }
window.addEventListener('hashchange', route);
function initFeedComposer(user){
var composerEl = document.getElementById('feed-composer'); var avatarEl = document.getElementById('feed-composer-avatar'); var categorySel = document.getElementById('feed-composer-category'); var form = document.getElementById('feed-composer-form'); var textEl = document.getElementById('feed-composer-text'); var mediaWrap = document.getElementById('feed-composer-media-wrap'); var mediaEl = document.getElementById('feed-composer-media'); var errEl = document.getElementById('feed-composer-error'); var publishBtn = document.getElementById('feed-composer-publish'); var photoBtn = document.getElementById('feed-composer-photo-btn'); var draftLink = document.getElementById('feed-composer-draft-link');
if(!composerEl || !form || !textEl) return;
if(avatarEl){ var name = (user && ((user.user_metadata && (user.user_metadata.first_name || user.user_metadata.last_name)) || user.email)) ? ((user.user_metadata && ((user.user_metadata.first_name || '') + ' ' + (user.user_metadata.last_name || '')).trim()) || user.email || '?') : '?'; var initial = (name && String(name).trim()) ? String(name).trim().charAt(0).toUpperCase() : '?'; if(window.BizForum && window.BizForum.getProfile){ window.BizForum.getProfile().then(function(p){ if(p && p.avatar_url){ avatarEl.innerHTML = '<img src="' + escapeHtml(p.avatar_url) + '" alt="" onerror="this.style.display=\'none\';this.nextElementSibling&&this.nextElementSibling.style.removeProperty(\'display\')"><span class="avatar-initial" style="display:none">' + escapeHtml(initial) + '</span>'; } else avatarEl.textContent = initial; }).catch(function(){ avatarEl.textContent = initial; }); } else avatarEl.textContent = initial; }
if(categorySel && BizForum.data && BizForum.data.getCategories){ BizForum.data.getCategories().then(function(cats){ if(!cats || !cats.length) return; categorySel.innerHTML = cats.map(function(c){ return '<option value="' + c.id + '">' + escapeHtml(c.name) + '</option>'; }).join(''); var priceWrap = document.getElementById('feed-composer-price-wrap'); var priceInput = document.getElementById('feed-composer-price'); function toggleFeedPrice(){ var v = categorySel.value; if(priceWrap) priceWrap.classList.toggle('hidden', v !== 'useful'); if(v !== 'useful' && priceInput) priceInput.value = '0'; } toggleFeedPrice(); categorySel.addEventListener('change', toggleFeedPrice); }); }
if(!form._feedComposerBound){ form._feedComposerBound = true;
photoBtn && photoBtn.addEventListener('click', function(){ if(mediaWrap) mediaWrap.classList.toggle('hidden'); });
draftLink && draftLink.addEventListener('click', function(e){ e.preventDefault(); if(!textEl.value.trim()) return; form._saveAsDraft = true; form.requestSubmit(); });
form.addEventListener('submit', function(e){ e.preventDefault(); if(errEl) errEl.textContent = ''; var body = (textEl && textEl.value) ? textEl.value.trim() : ''; if(!body){ if(errEl) errEl.textContent = t('postBodyPlaceholder') || '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç'; return; } var categoryId = (categorySel && categorySel.value) ? categorySel.value : ''; if(!categoryId && BizForum.data && BizForum.data.getCategories){ BizForum.data.getCategories().then(function(cats){ if(cats && cats[0]) categoryId = cats[0].id; doSubmitFeedComposer(body, categoryId, !!form._saveAsDraft); }); return; } doSubmitFeedComposer(body, categoryId, !!form._saveAsDraft); form._saveAsDraft = false; });
}
try{ var d = localStorage.getItem(DRAFT_KEY); if(d){ var draft = JSON.parse(d); if(draft && (draft.body || draft.title)){ if(textEl && draft.body) textEl.value = draft.body; else if(textEl && draft.title) textEl.value = draft.title; if(mediaEl && draft.media) mediaEl.value = draft.media; if(categorySel && draft.categoryId) categorySel.value = draft.categoryId; var priceWrap = document.getElementById('feed-composer-price-wrap'); var priceInput = document.getElementById('feed-composer-price'); if(priceWrap) priceWrap.classList.toggle('hidden', draft.categoryId !== 'useful'); if(priceInput && draft.price != null) priceInput.value = draft.price; } } } catch(e){}
}
function doSubmitFeedComposer(body, categoryId, isDraft){
var textEl = document.getElementById('feed-composer-text'); var mediaEl = document.getElementById('feed-composer-media'); var categorySel = document.getElementById('feed-composer-category'); var errEl = document.getElementById('feed-composer-error'); var publishBtn = document.getElementById('feed-composer-publish');
var lines = (body || '').split('\n'); var firstLine = (lines[0] || '').trim(); var title = firstLine.length > 300 ? firstLine.slice(0, 300) : firstLine || (t('postTitlePlaceholder') || '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞'); var bodyText = body || '';
var mediaUrls = []; if(mediaEl && mediaEl.value){ var urls = (mediaEl.value || '').split(/[\r\n]+/).map(function(s){ return s.trim(); }).filter(Boolean); mediaUrls = urls.map(function(url){ var ext = (url.split('.').pop() || '').split('?')[0].toLowerCase(); return { type: /^(mp4|webm|ogg|mov)$/i.test(ext) ? 'video' : 'image', url: url }; }); }
if(!categoryId && categorySel) categoryId = categorySel.value || '';
if(!window.BizForum || !BizForum.data || !BizForum.data.createPost){ if(errEl) errEl.textContent = t('error'); return; }
if(!window.__bizforum_user_id){ if(typeof openAuthModal === 'function') openAuthModal('login'); return; }
if(publishBtn) publishBtn.disabled = true;
var authorPromise = (window.BizForum.getDisplayName && window.BizForum.getDisplayName()) ? window.BizForum.getDisplayName() : Promise.resolve(getAuthorName() || '');
authorPromise.then(function(author){ author = (author && String(author).trim()) ? String(author).trim() : getAuthorName() || '–ì–æ—Å—Ç—å'; var data = { categoryId: categoryId, title: title, body: bodyText, author: author }; if(isDraft) data.draft = true; if(mediaUrls.length) data.mediaUrls = mediaUrls; if(categoryId === 'useful'){ var priceEl = document.getElementById('feed-composer-price'); data.price = (priceEl && priceEl.value) ? parseInt(priceEl.value, 10) || 0 : 0; } else { data.price = 0; } var anonCb = document.getElementById('feed-composer-anonymous'); if(anonCb && anonCb.checked) data.anonymous = true;
var verifiedCheck = (window.BizForum.isVerified && window.BizForum.isVerified()) ? window.BizForum.isVerified() : Promise.resolve(true); verifiedCheck.then(function(verified){ if(!verified){ if(errEl) errEl.textContent = t('unverifiedHint') || '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'; if(publishBtn) publishBtn.disabled = false; return; }
BizForum.data.createPost(data).then(function(p){ if(publishBtn) publishBtn.disabled = false; if(errEl) errEl.textContent = ''; if(textEl) textEl.value = ''; if(mediaEl) mediaEl.value = ''; try{ localStorage.removeItem(DRAFT_KEY); } catch(e){} if(p && p.id){ if(p._moderationReject){ var words = (p._violationWords || []).slice(0, 5).join(', '); if(typeof showToast === 'function') showToast((t('toastModerationTitle') || '–ú–æ–¥–µ—Ä–∞—Ü–∏—è') + ': ' + (t('toastModerationText') || '–ü–æ—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫.') + (words ? ' ' + words : ''), 'error'); window.location.hash = '#/drafts'; return; } if(isDraft){ if(typeof showToast === 'function') showToast(t('postSaveDraft') + ' ‚úì', 'success'); window.location.hash = '#/drafts'; } else { if(typeof showToast === 'function') showToast(t('postPublish') + ' ‚úì', 'success'); if(typeof loadFeed === 'function') loadFeed(getSort()); else window.location.hash = '#/post/' + p.id; } } }).catch(function(err){ if(publishBtn) publishBtn.disabled = false; var msg = (err && err.message) || t('error'); if(errEl) errEl.textContent = msg; if(typeof showToast === 'function') showToast(msg, 'error'); }); }); }).catch(function(){ if(publishBtn) publishBtn.disabled = false; if(errEl) errEl.textContent = t('error'); });
}
function updateAuthHeader(optDisplayName){
var btns = document.getElementById('auth-btns'); var userEl = document.getElementById('auth-user'); var nameEl = document.getElementById('auth-user-name'); var badgeEl = document.getElementById('auth-user-badge'); var adminWrap = document.getElementById('auth-admin-wrap');
if(!window.BizForum || !window.BizForum.signIn){ window.__bizforum_user_id = null; if(btns) btns.classList.remove('hidden'); if(userEl) userEl.classList.add('hidden'); if(adminWrap) adminWrap.classList.add('hidden'); var composerEl = document.getElementById('feed-composer'); if(composerEl) composerEl.classList.add('hidden'); var mw = document.getElementById('feed-filter-mine-wrap'); if(mw) mw.classList.add('hidden'); return; }
return window.BizForum.auth.getUser().catch(function(){ return { data: { user: null } }; }).then(function(r){
var user = r.data && r.data.user;
var friendsBtn = document.getElementById('header-friends-btn');
var chatsLink = document.getElementById('header-chats-link'); var fabWrap = document.getElementById('fab-wrap'); window.__bizforum_user_id = user ? user.id : null;
if(!user){ if(btns) btns.classList.remove('hidden'); if(userEl) userEl.classList.add('hidden'); if(adminWrap) adminWrap.classList.add('hidden'); if(friendsBtn) friendsBtn.classList.add('hidden'); if(chatsLink) chatsLink.classList.add('hidden'); if(fabWrap) fabWrap.classList.add('hidden'); var composerEl = document.getElementById('feed-composer'); if(composerEl) composerEl.classList.add('hidden'); var mineWrap = document.getElementById('feed-filter-mine-wrap'); if(mineWrap) mineWrap.classList.add('hidden'); return; }
if(btns) btns.classList.add('hidden'); if(friendsBtn) friendsBtn.classList.remove('hidden'); if(chatsLink) chatsLink.classList.remove('hidden'); if(fabWrap) fabWrap.classList.remove('hidden');
var composerEl = document.getElementById('feed-composer'); if(composerEl){ composerEl.classList.remove('hidden'); if(typeof initFeedComposer === 'function') initFeedComposer(user); }
var mineWrap = document.getElementById('feed-filter-mine-wrap'); if(mineWrap) mineWrap.classList.remove('hidden');
function setDisplayName(name){ var displayName = (name && String(name).trim()) ? String(name).trim() : t('authProfile'); if(nameEl){ nameEl.textContent = displayName; nameEl.style.cursor = 'pointer'; nameEl.title = '–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å'; var uid = (user && user.id) ? user.id : (window.__bizforum_user_id || ''); nameEl.onclick = function(){ if(uid) window.location.hash = '#/user/' + uid; else window.location.hash = '#/profile'; }; } if(userEl) userEl.classList.remove('hidden'); if(window.BizForum.getBalance){ var balEl = document.getElementById('auth-user-balance'); if(balEl){ window.BizForum.getBalance().then(function(bal){ balEl.textContent = ' ¬∑ ' + (bal != null ? bal : 0); }); balEl.style.cursor = 'pointer'; balEl.title = (t('balanceTopUpTitle') || '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å'); balEl.onclick = function(e){ e.preventDefault(); e.stopPropagation(); if(typeof openBalanceModal === 'function') openBalanceModal(); }; } } }
if(optDisplayName !== undefined && optDisplayName !== null && String(optDisplayName).trim()){ setDisplayName(optDisplayName); } else { window.BizForum.getDisplayName().then(function(name){ setDisplayName(name); }); }
if(window.BizForum.isVerified && badgeEl){ window.BizForum.isVerified().then(function(verified){ badgeEl.textContent = verified ? '' : ' (–Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω)'; }); } else if(badgeEl) badgeEl.textContent = '';
if(window.BizForum.isAdmin && adminWrap){ window.BizForum.isAdmin().then(function(ok){ if(ok){ adminWrap.classList.remove('hidden'); if(typeof updateAdminReportsBadge === 'function') updateAdminReportsBadge(); } else adminWrap.classList.add('hidden'); var chatAdminItem = document.getElementById('chat-item-admin'); if(chatAdminItem){ if(ok) chatAdminItem.classList.remove('hidden'); else chatAdminItem.classList.add('hidden'); } }); } else if(adminWrap) adminWrap.classList.add('hidden');
if(typeof updateFriendsBadge === 'function') updateFriendsBadge();
if(typeof refreshChatsBadge === 'function') refreshChatsBadge();
if(typeof updateCreateGroupButtonVisibility === 'function') updateCreateGroupButtonVisibility();
});
}
function openAuthModal(tab){
var modal = document.getElementById('auth-modal'); if(!modal) return;
modal.classList.remove('hidden');
var noSupabase = document.getElementById('auth-no-supabase'); var tabs = document.getElementById('auth-tabs'); var panelLogin = document.getElementById('auth-panel-login'); var panelReg = document.getElementById('auth-panel-register');
var cfg = window.BIZFORUM_CONFIG || {};
var supabaseConfigured = !!(cfg.useSupabase && cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY);
if(!supabaseConfigured && (!window.BizForum || !window.BizForum.signIn)){ if(noSupabase) noSupabase.classList.remove('hidden'); if(tabs) tabs.classList.add('hidden'); if(panelLogin) panelLogin.classList.add('hidden'); if(panelReg) panelReg.classList.add('hidden'); return; }
if(noSupabase) noSupabase.classList.add('hidden'); if(tabs) tabs.classList.remove('hidden');
if(tab === 'register'){ document.querySelector('.auth-tab[data-tab="register"]').classList.add('active'); document.querySelector('.auth-tab[data-tab="login"]').classList.remove('active'); if(panelReg) panelReg.classList.add('active'); if(panelLogin) panelLogin.classList.remove('active'); }
else { document.querySelector('.auth-tab[data-tab="login"]').classList.add('active'); document.querySelector('.auth-tab[data-tab="register"]').classList.remove('active'); if(panelLogin) panelLogin.classList.add('active'); if(panelReg) panelReg.classList.remove('active'); }
document.getElementById('login-error').textContent = ''; document.getElementById('register-error').textContent = ''; var rs = document.getElementById('register-success'); if(rs){ rs.classList.add('hidden'); rs.textContent = ''; } if(tab === 'register') updatePasswordChecklist(document.getElementById('reg-password') && document.getElementById('reg-password').value, 'reg');
}
function closeAuthModal(){ var modal = document.getElementById('auth-modal'); if(modal) modal.classList.add('hidden'); }
function openBalanceModal(){ var modal = document.getElementById('balance-modal'); if(modal){ modal.classList.remove('hidden'); var inp = document.getElementById('balance-topup-amount'); if(inp){ inp.value = '100'; inp.focus(); } var costEl = document.getElementById('balance-topup-cost'); if(costEl) costEl.textContent = '100 ‚ÇΩ'; var errEl = document.getElementById('balance-topup-error'); if(errEl) errEl.textContent = ''; } }
function closeBalanceModal(){ var modal = document.getElementById('balance-modal'); if(modal) modal.classList.add('hidden'); }
function initAuthUI(){
var btnLogout = document.getElementById('btn-logout'); var modalClose = document.getElementById('auth-modal-close');
if(btnLogout) btnLogout.addEventListener('click', function(e){ e.preventDefault(); if(window.BizForum.signOut) window.BizForum.signOut().then(updateAuthHeader); });
if(modalClose) modalClose.addEventListener('click', closeAuthModal);
var authModal = document.getElementById('auth-modal'); if(authModal) authModal.addEventListener('click', function(e){ if(e.target === this) closeAuthModal(); });
document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ if(document.getElementById('auth-modal') && !document.getElementById('auth-modal').classList.contains('hidden')){ closeAuthModal(); e.preventDefault(); return; } if(document.getElementById('balance-modal') && !document.getElementById('balance-modal').classList.contains('hidden')){ closeBalanceModal(); e.preventDefault(); return; } var replyToEl = document.getElementById('comment-reply-to'); if(replyToEl && !replyToEl.classList.contains('hidden')){ replyToEl.classList.add('hidden'); var pid = document.getElementById('comment-parent-id'); if(pid) pid.value = ''; var body = document.getElementById('comment-body'); if(body) body.value = ''; currentReplyToAuthorId = null; e.preventDefault(); } } if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ var cf = document.getElementById('comment-form'); var bodyEl = document.getElementById('comment-body'); if(cf && bodyEl && bodyEl.value.trim() && document.getElementById('view-post') && !document.getElementById('view-post').classList.contains('hidden')){ e.preventDefault(); cf.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true })); } } });
document.querySelectorAll('.auth-tab').forEach(function(t){ t.addEventListener('click', function(){ var tab = this.getAttribute('data-tab'); document.querySelectorAll('.auth-tab').forEach(function(x){ x.classList.toggle('active', x.getAttribute('data-tab') === tab); }); var pl = document.getElementById('auth-panel-login'); var pr = document.getElementById('auth-panel-register'); if(pl) pl.classList.toggle('active', tab === 'login'); if(pr) pr.classList.toggle('active', tab === 'register'); }); });
var formLogin = document.getElementById('form-login'); if(formLogin) formLogin.addEventListener('submit', function(e){
e.preventDefault();
var cfgLogin = window.BIZFORUM_CONFIG || {};
if(!window.BizForum || !window.BizForum.signIn){ document.getElementById('login-error').textContent = (cfgLogin.useSupabase && cfgLogin.SUPABASE_URL && cfgLogin.SUPABASE_ANON_KEY) ? '–ú–æ–¥—É–ª—å –≤—Ö–æ–¥–∞ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12).' : '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Supabase (config.js, useSupabase: true). –°–º. SETUP-DATABASE.md'; return; }
var email = document.getElementById('login-email').value.trim(); var password = document.getElementById('login-password').value;
document.getElementById('login-error').textContent = '';
window.BizForum.signIn(email, password).then(function(){ try{ if(!localStorage.getItem('bizforum_has_logged_in')) localStorage.setItem('bizforum_has_logged_in','1'); if(window.BizForumTour) window.BizForumTour.markShowRequest(); }catch(e){} closeAuthModal(); var p = updateAuthHeader(); if(p && typeof p.then === 'function') p.then(function(){ route(); }); else route(); }).catch(function(err){ var msg = err && err.message ? err.message : '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'; var status = err && (err.status || err.response && err.response.status); if(status === 400 || /email not confirmed|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω|confirm/i.test(msg)) msg = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å. –ï—Å–ª–∏ –≤—ã —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ—á—Ç—É –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –ø–∏—Å—å–º–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'; else if(/storage|persist|blocked|tracking prevention|third.?party/i.test(String(msg))) msg = '–ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (Tracking Prevention). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ Chrome –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ –∑–∞—â–∏—Ç—É –æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞.'; document.getElementById('login-error').textContent = msg; });
});
var regPw = document.getElementById('reg-password'); if(regPw){ regPw.addEventListener('input', function(){ updatePasswordChecklist(this.value, 'reg'); }); regPw.addEventListener('blur', function(){ updatePasswordChecklist(this.value, 'reg'); }); }
var formRegister = document.getElementById('form-register'); if(formRegister) formRegister.addEventListener('submit', function(e){
e.preventDefault();
var cfgReg = window.BIZFORUM_CONFIG || {};
if(!window.BizForum || !window.BizForum.signUpRegister){ document.getElementById('register-error').textContent = (cfgReg.useSupabase && cfgReg.SUPABASE_URL && cfgReg.SUPABASE_ANON_KEY) ? '–ú–æ–¥—É–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12).' : '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Supabase (config.js, useSupabase: true). –°–º. SETUP-DATABASE.md'; return; }
var email = document.getElementById('reg-email').value.trim(); var password = document.getElementById('reg-password').value;
var passwordConfirm = document.getElementById('reg-password-confirm'); var confirmVal = (passwordConfirm && passwordConfirm.value) ? passwordConfirm.value : '';
if(password !== confirmVal){ document.getElementById('register-error').textContent = t('errorPasswordsMatch') || '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.'; return; }
if(!validatePassword(password)){ document.getElementById('register-error').textContent = t('errorPasswordLength') || '–ü–∞—Ä–æ–ª—å: –æ—Ç 8 —Å–∏–º–≤–æ–ª–æ–≤, –∑–∞–≥–ª–∞–≤–Ω—ã–µ, —Å—Ç—Ä–æ—á–Ω—ã–µ, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã.'; return; }
var first_name = document.getElementById('reg-first-name').value.trim(); var last_name = document.getElementById('reg-last-name').value.trim(); var company = document.getElementById('reg-company').value.trim(); var secret_word = document.getElementById('reg-secret-word').value.trim();
document.getElementById('register-error').textContent = ''; var successEl = document.getElementById('register-success'); if(successEl){ successEl.classList.add('hidden'); successEl.textContent = ''; }
window.BizForum.signUpRegister({ email: email, password: password, first_name: first_name, last_name: last_name, company: company, secret_word: secret_word }).then(function(r){ if(r && r.user && r.user.id && window.BizForum.createNotification) window.BizForum.createNotification(r.user.id, 'registration', {}).catch(function(){}); successEl = document.getElementById('register-success'); var errEl = document.getElementById('register-error'); if(successEl){ var cfgReg = window.BIZFORUM_CONFIG || {}; var needConfirm = cfgReg.requireEmailConfirmation !== false; successEl.textContent = needConfirm ? (t('registerSuccessMessage') || '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É ‚Äî –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Å—Å—ã–ª–∫—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.') : (t('registerSuccessMessageNoConfirm') || '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ. –ú–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.'); successEl.classList.remove('hidden'); } if(errEl) errEl.textContent = ''; var btn = document.getElementById('reg-submit-btn'); if(btn) btn.disabled = true; var displayName = ((first_name || '') + ' ' + (last_name || '')).trim(); try{ if(window.BizForumTour) window.BizForumTour.markShowRequest(); }catch(e){} updateAuthHeader(displayName || undefined); setTimeout(function(){ if(successEl) successEl.classList.add('hidden'); document.getElementById('form-register').reset(); if(btn) btn.disabled = false; closeAuthModal(); updateAuthHeader(); document.querySelector('.auth-tab[data-tab="login"]') && document.querySelector('.auth-tab[data-tab="login"]').click(); }, 4000); updateAuthHeader(displayName || undefined); }).catch(function(err){ var msg = err && err.message ? err.message : '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'; if(/rate\s*limit\s*exceeded|429|too\s*many\s*requests/i.test(msg)) msg = '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ —Å —ç—Ç–æ–π –ø–æ—á—Ç—ã. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1 —á–∞—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π email.'; document.getElementById('register-error').textContent = msg; if(successEl) successEl.classList.add('hidden'); });
});
if(window.BizForum && window.BizForum.auth && typeof window.BizForum.auth.onAuthStateChange === 'function') window.BizForum.auth.onAuthStateChange(function(ev, session){ updateAuthHeader(); });
updateAuthHeader();
var footerYear = document.getElementById('footer-year'); if(footerYear) footerYear.textContent = new Date().getFullYear();
var balanceClose = document.getElementById('balance-modal-close'); if(balanceClose) balanceClose.addEventListener('click', closeBalanceModal);
var balanceOverlay = document.getElementById('balance-modal'); if(balanceOverlay) balanceOverlay.addEventListener('click', function(e){ if(e.target === balanceOverlay) closeBalanceModal(); });
var balanceAmountInput = document.getElementById('balance-topup-amount'); if(balanceAmountInput) balanceAmountInput.addEventListener('input', function(){ var n = parseInt(this.value, 10) || 0; var costEl = document.getElementById('balance-topup-cost'); if(costEl) costEl.textContent = n + ' ‚ÇΩ'; });
var balanceForm = document.getElementById('balance-topup-form'); if(balanceForm) balanceForm.addEventListener('submit', function(e){ e.preventDefault(); var inp = document.getElementById('balance-topup-amount'); var errEl = document.getElementById('balance-topup-error'); var submitBtn = balanceForm.querySelector('.balance-topup-submit'); var amount = parseInt(inp && inp.value ? inp.value : 0, 10); if(!amount || amount < 1){ if(errEl) errEl.textContent = (t('balanceTopUpMin') || '–ú–∏–Ω–∏–º—É–º 1 –º–æ–Ω–µ—Ç–∞'); return; } if(errEl) errEl.textContent = ''; if(submitBtn) submitBtn.disabled = true; if(!window.BizForum || !window.BizForum.userTopupBalance){ if(errEl) errEl.textContent = t('error'); if(submitBtn) submitBtn.disabled = false; return; } window.BizForum.userTopupBalance(amount).then(function(){ closeBalanceModal(); if(typeof updateAuthHeader === 'function') updateAuthHeader(); if(typeof showToast === 'function') showToast((t('balanceTopUpSuccess') || '–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!') + ' +' + amount, 'success'); }).catch(function(err){ if(errEl) errEl.textContent = (err && err.message) || t('error'); }).finally(function(){ if(submitBtn) submitBtn.disabled = false; }); });
}
function bindAuthLinks(){
var btnLogin = document.getElementById('btn-login'); var btnReg = document.getElementById('btn-register');
if(btnLogin) btnLogin.addEventListener('click', function(e){ e.preventDefault(); openAuthModal('login'); });
if(btnReg) btnReg.addEventListener('click', function(e){ e.preventDefault(); openAuthModal('register'); });
var landingLoginBtn = document.getElementById('landing-login-btn'); var landingRegBtn = document.getElementById('landing-register-btn');
if(landingLoginBtn) landingLoginBtn.addEventListener('click', function(e){ e.preventDefault(); openAuthModal('login'); });
if(landingRegBtn) landingRegBtn.addEventListener('click', function(e){ e.preventDefault(); openAuthModal('register'); });
}
var author = getAuthorName(); var ai = document.getElementById('comment-author'); if(ai && author) ai.placeholder = '–ü–æ–¥–ø–∏—Å—å: ' + author;
route();
bindAuthLinks();
initAuthUI();
if(!window.BizForum || !window.BizForum.signIn){ window.BizForum = window.BizForum || {}; window.BizForum.onDataReady = function(){ updateAuthHeader(); route(); bindOpenPostDelegation(document.body); bindBuyPostDelegation(document.body); if(window.BizForum.data && window.BizForum.data.getCategories && categoryListEl) window.BizForum.data.getCategories().then(renderSidebarCategories).catch(function(){ renderSidebarCategories([]); }); }; }
}
if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', runApp); else runApp();
})();
