# Что ещё не сделано: список и как реализовать

Ниже — функционал, который из ROADMAP и текущего кода пока не реализован или не доведён до конца. Разложено по полочкам с кратким планом реализации.

---

## 1. База данных (Supabase)

### 1.1 Типы реакций в схеме БД

**Что не так:** В `supabase/schema.sql` у таблицы `reactions` ограничение `CHECK (type IN ('like','useful','love', ...))` — старый набор. Сейчас в коде используются типы: `muzhik`, `koroleva`, `rzhaka`, `fire`, `fu`, `grustno`, `babki`, `hahaha`. При сохранении новой реакции в Supabase вставка может падать из‑за нарушения CHECK.

**Как сделать:**
- В Supabase → **SQL Editor** выполнить миграцию:
  - `ALTER TABLE reactions DROP CONSTRAINT IF EXISTS reactions_type_check;`
  - `ALTER TABLE reactions ADD CONSTRAINT reactions_type_check CHECK (type IN ('muzhik','koroleva','rzhaka','fire','fu','grustno','babki','hahaha'));`
- Либо добавить в проект файл `supabase/migration-reactions-types.sql` с этим SQL и описать в SETUP-DATABASE.md шаг «обновить типы реакций».

---

## 2. Посты: редактирование и удаление автором

**Что не так:** Кнопки «Изменить пост» и «Удалить пост» показываются только в режиме админа (Admin ON). В БД политики RLS уже разрешают автору поста обновлять и удалять свой пост (`auth.uid() = author_id`), но в интерфейсе автор этого не видит.

**Как сделать:**
1. **data-supabase.js** (и при необходимости data.js для моков):
   - В ответе `getPost` возвращать `authorId: p.author_id` (и в списках постов при необходимости).
   - Добавить `updatePost(postId, { title, body })`: `sb.from('posts').update({ title, body, ... }).eq('id', postId)` — RLS сам проверит, что это автор.
   - Добавить `deletePost(postId)`: `sb.from('posts').delete().eq('id', postId)` — аналогично.
2. **app.js** в `loadPost`:
   - Получить текущего пользователя (`getUid()` или через `BizForum.auth.getUser()`).
   - Если есть `p.authorId` и он совпадает с текущим пользователем — показывать блок «Изменить» / «Удалить» (отдельно от админского, например класс `post-author-bar`).
   - По клику «Изменить» — prompt или форма с заголовком и телом, вызов `BizForum.data.updatePost(postId, { title, body })`, затем перезагрузка поста.
   - По клику «Удалить» — confirm и `BizForum.data.deletePost(postId)`, затем переход на ленту.
3. Админская панель остаётся как есть (Admin ON) для редактирования/удаления любых постов.

---

## 3. Расширенный поиск

**Что не так:** Сейчас поиск только по тексту (запрос в `title` и `body`). В ROADMAP заложен фильтр по категории и опционально по периоду.

**Как сделать:**
1. **data-supabase.js**: расширить `searchPosts(query, opts)`:
   - `opts.categoryId` — добавить `.eq('category_id', opts.categoryId)` к запросу, если передан.
   - `opts.dateFrom` / `opts.dateTo` (ISO-строка или Date) — `.gte('created_at', ...)` и `.lte('created_at', ...)` при наличии.
2. **data.js** (моки): в моковом `searchPosts` фильтровать массив по категории и датам.
3. **index.html**: рядом с полем поиска добавить, например:
   - select «Категория» (все + список категорий),
   - опционально два input type="date" «С» / «По».
4. **app.js** в `runSearch`:
   - Считывать категорию и даты из новых полей.
   - Вызывать `BizForum.data.searchPosts(q, { categoryId, dateFrom, dateTo })`.
   - Отрендерить результаты как сейчас.

---

## 4. Уведомления (заглушка или простой список)

**Что не так:** В ROADMAP пункт 10 — «У вас N новых ответов» или список непрочитанного. Сейчас этого нет.

**Как сделать (минимальный вариант без бэкенда):**
1. **Логика:**
   - При открытии поста или страницы «Мои посты» запоминать в localStorage время последнего визита (или список просмотренных post_id + comment count).
   - «Непрочитанные» = посты/топики, где после твоего последнего визита появились новые комментарии (или новые ответы на твои комментарии). Без сервера можно приближённо: хранить для каждого поста `lastSeenCommentCount` и при загрузке ленты/поста сравнивать с текущим `commentsCount`; если вырос — считать пост «с новыми ответами».
2. **UI:**
   - В шапке иконка «колокольчик» и счётчик (например «3»). По клику — выпадающий список: «В посте "…" 2 новых комментария» со ссылкой на пост.
   - Данные хранить в localStorage (например ключ `bizforum_notifications`: массив `{ postId, title, newCount, lastSeen }`), обновлять при заходе на пост (пометить как просмотренный).
3. **С Supabase (позже):** можно завести таблицу `notifications` (user_id, post_id, comment_id, type, read_at) и подписываться на новые комментарии по своим постам/ответам — это уже отдельный этап.

---

## 5. UX и мелкие доработки

### 5.1 Закрытие сайдбара на мобильном при переходе

**Что не так:** При клике по ссылке в сайдбаре (категория, избранное, новый пост) на мобильном сайдбар может оставаться открытым.

**Как сделать:** В `app.js` в функции `route()` (или в одном месте, где обрабатывается смена hash) после переключения вида вызывать закрытие сайдбара: найти `#sidebar` и `#sidebar-overlay`, снять класс `open` у сайдбара и `visible` у оверлея. Одной строкой в конце `route()` достаточно.

### 5.2 Плейсхолдеры в модалке авторизации на выбранный язык

**Что не так:** В форме входа/регистрации плейсхолдеры вроде «Иван», «ООО Ромашка», «Пароль» захардкожены; при переключении языка они не меняются.

**Как сделать:** Добавить в `i18n.js` ключи для плейсхолдеров (например `authEmailPlaceholder`, `authPasswordPlaceholder`, `authFirstNamePlaceholder`, …). В `index.html` у полей модалки поставить `data-i18n-placeholder="authEmailPlaceholder"` и т.д. — тогда `applyLang()` уже подставит перевод (механизм есть).

### 5.3 Названия категорий на двух языках

**Что не так:** Названия категорий приходят из API (БД) одним текстом (например «Стартапы»). При переключении на English они не меняются.

**Как сделать (клиентский вариант без смены БД):**
- В `i18n.js` завести объект, например `CATEGORY_NAMES: { ru: { startups: 'Стартапы', ... }, en: { startups: 'Startups', ... } }`, и функцию/ключи для получения имени по `categoryId` и текущему языку.
- В местах, где выводится имя категории (лента, страница поста, селект «Новый пост»), подставлять не `cat.name`, а результат из этого словаря по `cat.id` и текущему языку (если перевода нет — fallback на `cat.name`).
- Альтернатива: хранить в БД slug, а перевод по slug держать на клиенте — тогда не нужно менять структуру таблицы категорий.

---

## 6. Что уже сделано (для ясности)

- Лента, категории, страница поста, комментарии, создание постов.
- Реакции (новый набор: мужик!, королева!, ржаакаа, огонь, фу, грустно, делаем бабки, хахаха).
- Сортировки: рекомендуемое, новые, по популярности, по комментариям, по просмотрам.
- Хлебные крошки и «Назад».
- «Загрузить ещё» (пагинация).
- Избранное.
- Редактирование/удаление своего комментария (по author_id / author_device_id); удаление комментария админом.
- Имя автора (подпись) через sessionStorage и форма.
- Мобильное меню (бургер + выдвижной сайдбар).
- Переключатель языка (ru/en), перевод интерфейса и дат.
- Реестр аккаунтов, профиль, верификация, админ: редактирование/удаление поста и профилей.

---

## Приоритет внедрения (рекомендуемый)

| Порядок | Задача | Зачем |
|--------|--------|--------|
| 1 | Миграция типов реакций в БД | Чтобы новые реакции работали с Supabase. |
| 2 | Редактирование/удаление поста автором | Ожидаемое поведение для авторов без включения админа. |
| 3 | Закрытие сайдбара при переходе | Небольшое улучшение UX на мобильном. |
| 4 | Расширенный поиск (категория, даты) | Больше пользы при росте объёма постов. |
| 5 | Плейсхолдеры и категории на двух языках | Полнота мультиязычности. |
| 6 | Уведомления (заглушка/список) | Повышение возвратов; можно начать с простого варианта на localStorage. |

Если скажете, с какого пункта начать, могу расписать конкретные правки по файлам и строкам (патчи/код).
